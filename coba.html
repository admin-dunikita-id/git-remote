<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al-Quran Digital Enhanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Light Mode */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .controls {
            background: #f8f9fa;
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            position: relative;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        select, button, input {
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select:hover, button:hover, input:focus {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
        }

        .icon-btn {
            width: 50px;
            height: 50px;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            border-radius: 50%;
        }

        /* Search History Styles */
        .search-history {
            display: none;
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-top: 8px;
            z-index: 999;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
        }

        .search-history.show {
            display: block;
        }

        .search-history-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .search-history-item {
            padding: 8px;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s ease;
            font-size: 14px;
            color: #333;
            background: #f9f9f9;
            margin-bottom: 5px;
        }

        .search-history-item:hover {
            background: #e0f7fa;
        }

        .search-history-icon {
            margin-right: 6px;
        }

        .search-history-text {
            color: #333;
            flex: 1;
            margin-left: 8px;
        }

        .search-history-delete,
        .search-history-pin {
            background: none;
            border: none;
            font-size: 14px;
            cursor: pointer;
            padding: 2px 5px;
            color: #666;
        }

        .search-history-delete:hover,
        .search-history-pin:hover {
            color: #000;
        }

        .search-history-clear {
            text-align: center;
            margin-top: 10px;
        }

        .clear-history-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
        }

        .search-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-input {
            position: absolute;
            top: 60px;
            right: 0;
            width: 300px;
            display: none;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .search-input.show {
            display: flex;
            gap: 10px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .settings-panel {
            position: absolute;
            overflow: auto;
            flex-direction: column;
            align-items: flex-start;
            max-height: 500px;
            top: 80px;
            right: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 20px;
            width: 400px;
            display: none;
            z-index: 1000;
            border: 2px solid #667eea;
        }

        .settings-panel.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .settings-panel h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.3rem;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .setting-item2 {
            display: flex;
            align-items: left;
            flex-direction: column;
            margin-bottom: 5px;
        }

        .setting-label {
            color: #2c3e50;
            font-weight: 500;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: #ccc;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }

        .toggle-switch.active::after {
            transform: translateX(25px);
        }

        .font-size-control {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .font-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
        }

        .font-btn:hover, .font-btn.active {
            background: #667eea;
            color: white;
        }

        .qari-select {
            width: 100%;
            margin-top: 10px;
        }

        .language-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .lang-btn {
            padding: 6px 12px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .lang-btn:hover, .lang-btn.active {
            background: #667eea;
            color: white;
        }

        /* Tajwid Colors */
        .tajwid-mad { 
            background: linear-gradient(to bottom, rgba(255, 0, 255, 0.3), rgba(255, 0, 255, 0.1));
            border-radius: 2px;
            padding: 0 1px;
        }

        .tajwid-ikhfa { 
            background: linear-gradient(to bottom, rgba(0, 255, 0, 0.4), rgba(0, 255, 0, 0.2));
            border-radius: 2px;
            padding: 0 1px;
        }

        .tajwid-idgham { 
            background: linear-gradient(to bottom, rgba(255, 165, 0, 0.4), rgba(255, 165, 0, 0.2));
            border-radius: 2px;
            padding: 0 1px;
        }

        .tajwid-ghunnah { 
            background: linear-gradient(to bottom, rgba(255, 255, 0, 0.4), rgba(255, 255, 0, 0.2));
            border-radius: 2px;
            padding: 0 1px;
        }

        .tajwid-qalqalah { 
            background: linear-gradient(to bottom, rgba(0, 255, 255, 0.4), rgba(0, 255, 255, 0.2));
            border-radius: 2px;
            padding: 0 1px;
        }

        .tajwid-iqlab { 
            background: linear-gradient(to bottom, rgba(255, 192, 203, 0.4), rgba(255, 192, 203, 0.2));
            border-radius: 2px;
            padding: 0 1px;
        }

        .tajwid-waqf { 
            background: linear-gradient(to bottom, rgba(255, 0, 0, 0.3), rgba(255, 0, 0, 0.1));
            border-radius: 2px;
            padding: 0 1px;
        }

        .tajwid-madd-lazim { 
            background: linear-gradient(to bottom, rgba(0, 0, 255, 0.4), rgba(0, 0, 255, 0.2));
            border-radius: 2px;
            padding: 0 1px;
        }

        .tajwid-madd-wajib { 
            background: linear-gradient(to bottom, rgba(128, 0, 128, 0.4), rgba(128, 0, 128, 0.2));
            border-radius: 2px;
            padding: 0 1px;
        }

        .tajwid-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 10px;
            margin-bottom: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 12px;
        }

        .tajwid-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tajwid-color-box {
            width: 20px;
            height: 15px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }

        .audio-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            background: #e8f5e8;
            padding: 15px;
            border-radius: 10px;
            margin: 20px;
        }

        .audio-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .audio-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .audio-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .surah-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            text-align: center;
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .surah-header h2 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .surah-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .surah-container {
            padding: 20px;
        }

        .ayah-card {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 25px;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            margin-bottom: 20px;
            background: #fafafa;
            transition: all 0.3s ease;
            position: relative;
            will-change: transform;
            transform: translate3d(0, 0, 0);
        }

        .ayah-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: #667eea;
            transform: translate3d(0, -3px, 0);
        }

        .ayah-card.highlight {
            background: #fff3cd;
            border-color: #ffc107;
            animation: pulse 2s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .left-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .ayah-number {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-weight: bold;
            text-align: center;
            width: fit-content;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .verse-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .bookmark-btn.bookmarked {
            background: #ffc107;
            color: #212529;
        }

        .transliteration {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #2196f3;
            display: block;
        }

        .transliteration h4 {
            color: #1976d2;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .transliteration p {
            font-style: italic;
            line-height: 1.5;
            color: #424242;
        }

        .translation {
            background: #f3e5f5;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #9c27b0;
            display: block;
        }

        .translation h4 {
            color: #7b1fa2;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .translation p {
            line-height: 1.6;
            color: #424242;
        }

        .arabic-text {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff8e1;
            padding: 25px;
            border-radius: 10px;
            border-right: 4px solid #ff9800;
        }

        .arabic {
            font-size: 1.8rem;
            line-height: 1.8;
            text-align: right;
            direction: rtl;
            color: #2c3e50;
            font-family: 'Arabic Typesetting', 'Traditional Arabic', serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .arabic:hover {
            color: #667eea;
            transform: scale(1.02);
        }

        .arabic.small-text { font-size: 1.5rem; }
        .arabic.medium-text { font-size: 1.8rem; }
        .arabic.large-text { font-size: 2.2rem; }
        .arabic.xlarge-text { font-size: 2.8rem; }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 1.2rem;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #f44336;
            text-align: center;
            margin: 20px;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            padding: 20px;
        }

        .nav-btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .nav-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .progress-bar {
            background: #e9ecef;
            height: 6px;
            border-radius: 3px;
            margin: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(45deg, #667eea, #764ba2);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            will-change: width;
    transform: translate3d(0, 0, 0);
        }

        .statistics {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .scroll-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            display: none;
            font-size: 20px;
        }

        .scroll-top:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }

        .bookmarks-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 100%;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .bookmarks-panel.open {
            right: 0;
        }

        .bookmarks-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-bookmarks {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .bookmark-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .bookmark-item:hover {
            background: #f8f9fa;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .overlay.show {
            display: block;
        }

        .mobile-toolbar .center-group {
            display: flex;
            align-items: center;
            gap: 10px; /* tambahkan atau ubah ini */
        }

        /* ===== MODAL PROGRESS PER SURAH ===== */
        .progress-modal-overlay-v2 {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .progress-modal-v2 {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 500px;
            min-width: 350px;
            animation: modalSlideInV2 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalSlideInV2 {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .progress-modal-v2 h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .progress-modal-v2 p {
            color: #555;
            margin-bottom: 25px;
            line-height: 1.5;
            font-size: 1rem;
        }

        .progress-info-v2 {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border-left: 4px solid #2196F3;
        }

        .progress-info-v2 h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .progress-bar-preview-v2 {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill-preview-v2 {
            background: linear-gradient(45deg, #667eea, #764ba2);
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text-v2 {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .progress-modal-buttons-v2 {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .progress-modal-btn-v2 {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .progress-modal-btn-v2.save {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .progress-modal-btn-v2.save:hover {
            background: linear-gradient(45deg, #45a049, #3e8e41);
            transform: translateY(-2px);
        }

        .progress-modal-btn-v2.delete {
            background: linear-gradient(45deg, #f44336, #da190b);
            color: white;
        }

        .progress-modal-btn-v2.delete:hover {
            background: linear-gradient(45deg, #da190b, #c62828);
            transform: translateY(-2px);
        }

        .progress-modal-btn-v2.continue {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }

        .progress-modal-btn-v2.continue:hover {
            background: linear-gradient(45deg, #1976D2, #1565C0);
            transform: translateY(-2px);
        }

        .progress-modal-btn-v2.restart {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
        }

        .progress-modal-btn-v2.restart:hover {
            background: linear-gradient(45deg, #F57C00, #EF6C00);
            transform: translateY(-2px);
        }

        /* ===== PANEL PROGRESS BACA ===== */
        .progress-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .progress-panel.open {
            right: 0;
        }

        .progress-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .close-progress {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background 0.3s ease;
        }

        .close-progress:hover {
            background: rgba(255,255,255,0.2);
        }

        .progress-list {
            padding: 0;
        }

        .progress-item {
            padding: 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.3s ease;
            position: relative;
        }

        .progress-item:hover {
            background: #f8f9fa;
        }

        .progress-item:last-child {
            border-bottom: none;
        }

        .progress-surah-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .progress-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .progress-percentage {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .progress-date {
            color: #666;
            font-size: 0.85rem;
        }

        .progress-bar-mini {
            background: #e0e0e0;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill-mini {
            background: linear-gradient(45deg, #667eea, #764ba2);
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .progress-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .progress-action-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .progress-action-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .progress-action-btn.continue {
            background: #28a745;
        }

        .progress-action-btn.continue:hover {
            background: #218838;
        }

        .progress-action-btn.delete {
            background: #dc3545;
        }

        .progress-action-btn.delete:hover {
            background: #c82333;
        }

        .progress-empty {
            padding: 60px 20px;
            text-align: center;
            color: #666;
        }

        .progress-empty-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .progress-stats {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .progress-stats h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 1rem;
        }

        .progress-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .progress-stat-item {
            text-align: center;
        }

        .progress-stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            display: block;
        }

        .progress-stat-label {
            font-size: 0.8rem;
            color: #666;
        }

        /* TAMBAHAN CSS untuk Footnote dan Tafsir */
        .footnote-section {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #4caf50;
            margin-top: 10px;
            display: none;
        }

        .footnote-section h4 {
            color: #2e7d32;
            margin-bottom: 8px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .footnote-section p {
            line-height: 1.6;
            color: #424242;
            font-size: 0.95rem;
        }

        /* PERBAIKAN 7: CSS tambahan untuk tafsir */
/* PERBAIKAN 4: CSS yang lebih baik untuk tafsir */
.tafsir-section {
    background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
    padding: 20px;
    border-radius: 12px;
    border-left: 5px solid #ff9800;
    margin-top: 15px;
    display: none;
    box-shadow: 0 2px 8px rgba(255, 152, 0, 0.1);
    transition: all 0.3s ease;
}

.tafsir-section.show {
    display: block !important;
    animation: slideInTafsir 0.4s ease;
}

.tafsir-section h4 {
    color: #e65100;
    margin-bottom: 12px;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    border-bottom: 2px solid #ffcc02;
    padding-bottom: 8px;
}

.tafsir-content {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 10px;
}

.tafsir-content::-webkit-scrollbar {
    width: 6px;
}

.tafsir-content::-webkit-scrollbar-track {
    background: #ffe0b2;
    border-radius: 3px;
}

.tafsir-content::-webkit-scrollbar-thumb {
    background: #ff9800;
    border-radius: 3px;
}

.tafsir-content p {
    line-height: 1.7;
    color: #3e2723;
    font-size: 0.95rem;
    text-align: justify;
    text-indent: 20px;
    margin-bottom: 12px;
}

.action-btn.tafsir-btn {
    background: linear-gradient(135deg, #ff9800, #f57c00);
    color: white;
    position: relative;
    overflow: hidden;
}

.action-btn.tafsir-btn:hover {
    background: linear-gradient(135deg, #f57c00, #ef6c00);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
}

.action-btn.tafsir-btn.active {
    background: linear-gradient(135deg, #2196f3, #1976d2);
    box-shadow: 0 0 15px rgba(33, 150, 243, 0.4);
}

@keyframes slideInTafsir {
    from {
        opacity: 0;
        transform: translateY(-20px);
        max-height: 0;
    }
    to {
        opacity: 1;
        transform: translateY(0);
        max-height: 500px;
    }
}

/* Responsive untuk mobile */
@media (max-width: 768px) {
    .tafsir-section {
        padding: 15px;
    }
    
    .tafsir-content {
        max-height: 250px;
    }
    
    .tafsir-content p {
        font-size: 0.9rem;
        text-indent: 15px;
    }
}

/* TAMBAHAN CSS untuk deskripsi surah yang bisa diklik */
.surah-description {
    background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
    padding: 0; /* Ubah dari 20px ke 0 */
    margin: 20px 0;
    border-radius: 12px;
    border-left: 4px solid #4caf50;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: all 0.3s ease;
}

.surah-description-header {
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
}

.surah-description-header:hover {
    background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
    transform: translateY(-1px);
}

.surah-description-header h5 {
    color: #4caf50;
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.surah-description-toggle {
    font-size: 1.2rem;
    transition: transform 0.3s ease;
    color: #4caf50;
}

.surah-description-toggle.expanded {
    transform: rotate(180deg);
}

.surah-description-content {
    padding: 0 20px;
    max-height: 0;
    overflow: hidden;
    transition: all 0.4s ease;
    opacity: 0;
}

.surah-description-content.show {
    padding: 0 20px 20px 20px;
    max-height: 500px;
    opacity: 1;
}

.surah-description-content p {
    margin: 0;
    text-align: justify;
    text-indent: 20px;
    font-size: 0.95rem;
    line-height: 1.6;
    color: rgba(255,255,255,0.9);
}

.surah-description-content.show {
    animation: expandDescription 0.4s ease forwards;
}

.surah-description-content:not(.show) {
    animation: collapseDescription 0.4s ease forwards;
}

/* Dark theme */
body.dark-theme .surah-description-header h5 {
    color: #27ae60;
}

body.dark-theme .surah-description-toggle {
    color: #27ae60;
}

body.dark-theme .surah-description-content p {
    color: #ecf0f1;
}

/* Responsive */
@media (max-width: 768px) {
    .surah-description-header {
        padding: 15px;
    }
    
    .surah-description-content.show {
        padding: 0 15px 15px 15px;
    }
    
    .surah-description-content p {
        font-size: 0.9rem;
        text-indent: 15px;
    }
}

/* Animasi untuk smooth expand/collapse */
@keyframes expandDescription {
    from {
        max-height: 0;
        opacity: 0;
        padding-bottom: 0;
    }
    to {
        max-height: 500px;
        opacity: 1;
        padding-bottom: 20px;
    }
}

@keyframes collapseDescription {
    from {
        max-height: 500px;
        opacity: 1;
        padding-bottom: 20px;
    }
    to {
        max-height: 0;
        opacity: 0;
        padding-bottom: 0;
    }
}




        .action-btn.footnote-btn {
            background: #4caf50;
            color: white;
        }

        .action-btn.footnote-btn:hover {
            background: #45a049;
        }

        .action-btn.tafsir-btn {
            background: #ff9800;
            color: white;
        }

        .action-btn.tafsir-btn:hover {
            background: #f57c00;
        }

        .action-btn.active {
            background: #2196f3;
            color: white;
        }

        /* Responsive untuk mobile */
        @media (max-width: 768px) {
            .footnote-section,
            .tafsir-section {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .footnote-section h4,
            .tafsir-section h4 {
                font-size: 0.95rem;
            }
        }


        /* Dark Theme */
        body.dark-theme {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }

        body.dark-theme .container {
            background: #2c3e50;
            color: white;
        }

        body.dark-theme .controls {
            background: #34495e;
        }

        body.dark-theme .ayah-card {
            background: #445e79;
            border-color: #495057;
            color: white;
        }

        body.dark-theme .ayah-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        body.dark-theme .ayah-card.highlight {
            background: #fff3cd;
            border-color: #ffc107;
            animation: pulse 2s ease-in-out;
        }

        body.dark-theme .transliteration {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            color: white;
        }

        body.dark-theme .translation {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
            color: white;
        }

        body.dark-theme .arabic-text {
            background: #fff8e1;
            border-right: 4px solid #ff9800;
        }

        body.dark-theme .statistics {
            background: #34495e;
        }

        body.dark-theme .settings-panel {
            background: #fff;
            color: white;
        }

        body.dark-theme .setting-item {
            background: #fff;
            border: 1px solid #495057;
        }

        body.dark-theme .audio-controls {
            background: #495057;
        }

        body.dark-theme .bookmarks-panel {
            background: #2c3e50;
            color: white;
        }

        body.dark-theme .bookmark-item {
            border-bottom-color: #495057;
        }

        body.dark-theme .bookmark-item:hover {
            background: #495057;
        }

        body.dark-theme .search-history {
            background: #fff;
            color: white;
        }

        body.dark-theme .search-history-item {
            background: #34495e;
            color: #eee;
        }

        body.dark-theme .search-history-item:hover {
            background: #455a64;
        }

        body.dark-theme .search-history-text {
            color: #fff;
        }

        body.dark-theme .clear-history-btn {
            background: #495057;
        }

        body.dark-theme .search-history-delete,
        body.dark-theme .search-history-pin {
            color: #ccc;
        }

        body.dark-theme .search-history-delete:hover,
        body.dark-theme .search-history-pin:hover {
            color: white;
        }

        body.dark-theme .tajwid-legend {
            background: #34495e;
            color: white;
        }

        /* Dark theme tajwid colors with lower opacity */
        body.dark-theme .tajwid-mad { 
            background: linear-gradient(to bottom, rgba(255, 0, 255, 0.2), rgba(255, 0, 255, 0.05));
        }
        body.dark-theme .tajwid-ikhfa { 
            background: linear-gradient(to bottom, rgba(0, 255, 0, 0.2), rgba(0, 255, 0, 0.05));
        }
        body.dark-theme .tajwid-idgham { 
            background: linear-gradient(to bottom, rgba(255, 165, 0, 0.2), rgba(255, 165, 0, 0.05));
        }
        body.dark-theme .tajwid-ghunnah { 
            background: linear-gradient(to bottom, rgba(255, 255, 0, 0.2), rgba(255, 255, 0, 0.05));
        }
        body.dark-theme .tajwid-qalqalah { 
            background: linear-gradient(to bottom, rgba(0, 255, 255, 0.2), rgba(0, 255, 255, 0.05));
        }
        body.dark-theme .tajwid-iqlab { 
            background: linear-gradient(to bottom, rgba(255, 192, 203, 0.2), rgba(255, 192, 203, 0.05));
        }
        body.dark-theme .tajwid-waqf { 
            background: linear-gradient(to bottom, rgba(255, 0, 0, 0.2), rgba(255, 0, 0, 0.05));
        }
        body.dark-theme .tajwid-madd-lazim { 
            background: linear-gradient(to bottom, rgba(0, 0, 255, 0.2), rgba(0, 0, 255, 0.05));
        }
        body.dark-theme .tajwid-madd-wajib { 
            background: linear-gradient(to bottom, rgba(128, 0, 128, 0.2), rgba(128, 0, 128, 0.05));
        }

        /* ===== Dark theme MODAL PROGRESS PER SURAH ===== */
        body.dark-theme .progress-modal-v2 {
            background: #2c3e50;
            color: white;
        }

        body.dark-theme .progress-modal-v2 h3 {
            color: white;
        }

        body.dark-theme .progress-modal-v2 p {
            color: #bbb;
        }

        body.dark-theme .progress-info-v2 {
            background: #34495e;
            border-left-color: #3498db;
        }

        body.dark-theme .progress-info-v2 h4 {
            color: #3498db;
        }

        body.dark-theme .progress-text-v2 {
            color: #aaa;
        }

        /* ===== Dark theme PANEL PROGRESS BACA ===== */

        body.dark-theme .progress-panel {
            background: #2c3e50;
            color: white;
        }

        body.dark-theme .progress-item {
            border-bottom-color: #495057;
        }

        body.dark-theme .progress-item:hover {
            background: #495057;
        }

        body.dark-theme .progress-surah-name {
            color: white;
        }

        body.dark-theme .progress-date {
            color: #aaa;
        }

        body.dark-theme .progress-empty {
            color: #aaa;
        }

        body.dark-theme .progress-stats {
            background: #34495e;
            border-bottom-color: #495057;
        }

        body.dark-theme .progress-stats h4 {
            color: white;
        }

        body.dark-theme .progress-stat-label {
            color: #aaa;
        }

        @media (max-width: 768px) {
            .ayah-card {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 20px;
            }
            
            .arabic {
                font-size: 1.5rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .surah-header h2 {
                font-size: 1.5rem;
            }

            .bookmarks-panel {        /* penagturan di sini ( JS : function handleResize() )*/
                width: none;
                right: -110%;
            }

            .settings-panel {         /* penagturan di sini ( JS : function handleResize() )*/
                width: none;
                right: none;
            }

            .search-input {
                left: -1px;
                width: 350px;
            }

            /* Mobile responsive untuk progress panel */
            .progress-panel {
                width: 100%;
                right: -100%;
            }

            .progress-panel.open {
                right: 0;
            }
            
            /* Posisi Mobile Button*/
            .mobile-toolbar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 15px;
                gap: 5px;
            }

            .mobile-toolbar .left-group,
            .mobile-toolbar .center-group,
            .mobile-toolbar .right-group {
                display: flex;
                align-items: center;
            }

            .mobile-toolbar .left-group {
                justify-content: flex-start;
                flex: 1;
            }

            .mobile-toolbar .center-group {
            justify-content: center;
            flex: 2;
            gap: 10px;
        }

            .mobile-toolbar .right-group {
                justify-content: flex-end;
                flex: 1;
                
            }

            .circle-button {
                width: 50px;
                height: 50px;
                border-radius: 50%;
                border: none;
                display: flex;
                justify-content: center;
                align-items: center;
                background: linear-gradient(to right, rgba(123,47,247,0.9), rgba(241,7,163,0.9));
                color: white;
                cursor: pointer;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            }

            .rounded-button {
                padding: 10px 15px;
                border-radius: 12px;
                border: none;
                background: linear-gradient(to right, rgba(123,47,247,0.9), rgba(241,7,163,0.9));
                color: white;
                font-size: 0.9rem;
                display: inline-flex;
                align-items: center;
                gap: 5px;
                cursor: pointer;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
                transition: all 0.3s ease;
                white-space: nowrap; 
            }
        }

        #progressBtn {
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 9999;
            animation: slideInRight 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay" onclick="closeAllPanels()"></div>
    
    <div class="container">
        <div class="header">
            <button class="theme-toggle" onclick="toggleTheme()" title="Ubah Tema Gelap">🌙</button>
            <h1>📖 Al-Quran Digital Enhanced</h1>
            <p>Membaca Al-Quran dengan mudah dan nyaman</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="surah"></label>
                <select id="surah">
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>
            
            <div class="mobile-toolbar control-group">
                <div class="search-container" id="left-group">
                    <button class="icon-btn" onclick="toggleSearch()" title="Cari Ayat">🔍</button>
                    <div class="search-input" id="searchContainer">
                        <div class="search-input-wrapper">
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="searchInput" placeholder="Cari ayat..." />
                                <button onclick="searchVerse()">Cari</button>
                            </div>
                            <div class="search-history" id="searchHistory">
                                <div class="search-history-header">
                                    📚 Riwayat Pencarian
                                </div>
                                <div id="searchHistoryList">
                                    <!-- Items akan diisi oleh JavaScript -->
                                </div>
                                <div class="search-history-clear">
                                    <button class="clear-history-btn" onclick="clearSearchHistory(); keepSearchPanelOpen();">
                                        🗑️ Hapus Semua Riwayat
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="center-group">
                    <button class="rounded-button" id="loadSurahBtn">📖 Tampilkan Surah</button>
                    <button class="rounded-button" onclick="toggleBookmarks()">🔖 Bookmark</button>
                </div>
                <!-- Progress Panel -->
                <div class="progress-panel" id="progressPanel">
                    <div class="progress-header">
                        <h3>📈 Progress Baca</h3>
                        <button class="close-progress" onclick="toggleProgressPanel()">×</button>
                    </div>
                    <div class="progress-stats" id="progressStats">
                        <!-- Stats will be populated by JavaScript -->
                    </div>
                    <div class="progress-list" id="progressList">
                        <!-- Progress items will be populated by JavaScript -->
                    </div>
                </div>
                <div class="right-group">
                    <button class="icon-btn" onclick="toggleSettings()" title="Pengaturan">⚙️</button>
                </div>
                
                <!-- Settings Panel -->
                <div class="settings-panel" id="settingsPanel">
                    <h3>⚙️ Pengaturan</h3>
                    
                    <div class="setting-item2">
                        <span class="setting-label">Ukuran Font Arab</span>
                    </div>
                    <div class="setting-item">
                        <div class="font-size-control">
                            <button class="font-btn" onclick="setFontSize('small')" title="Kecil">A</button>
                            <button class="font-btn active" onclick="setFontSize('medium')" title="Sedang">A</button>
                            <button class="font-btn" onclick="setFontSize('large')" title="Besar">A</button>
                            <button class="font-btn" onclick="setFontSize('xlarge')" title="Sangat Besar">A</button>
                        </div>
                    </div>

                    <div class="setting-item">
                        <span class="setting-label">Tampilkan Tajwid</span>
                        <div class="toggle-switch" onclick="toggleTajwid()" id="tajwidToggle"></div>
                    </div>
                    
                    <div class="tajwid-legend" id="tajwidLegend" style="display: none;">
                        <div class="tajwid-legend-item">
                            <div class="tajwid-color-box tajwid-ghunnah"></div>
                            <span>Ghunnah</span>
                        </div>
                        <div class="tajwid-legend-item">
                            <div class="tajwid-color-box tajwid-idgham"></div>
                            <span>Idgham</span>
                        </div>
                        <div class="tajwid-legend-item">
                            <div class="tajwid-color-box tajwid-ikhfa"></div>
                            <span>Ikhfa</span>
                        </div>
                        <div class="tajwid-legend-item">
                            <div class="tajwid-color-box tajwid-iqlab"></div>
                            <span>Iqlab</span>
                        </div>
                        <div class="tajwid-legend-item">
                            <div class="tajwid-color-box tajwid-mad"></div>
                            <span>Mad Thabi'i</span>
                        </div>
                        <div class="tajwid-legend-item">
                            <div class="tajwid-color-box tajwid-qalqalah"></div>
                            <span>Qalqalah</span>
                        </div>
                        <div class="tajwid-legend-item">
                            <div class="tajwid-color-box tajwid-waqf"></div>
                            <span>Waqf</span>
                        </div>
                        <div class="tajwid-legend-item">
                            <div class="tajwid-color-box tajwid-madd-lazim"></div>
                            <span>Mad Lazim</span>
                        </div>
                        <div class="tajwid-legend-item">
                            <div class="tajwid-color-box tajwid-madd-wajib"></div>
                            <span>Mad Wajib</span>
                        </div>
                    </div>

                    <div class="setting-item">
                        <span class="setting-label">Tampilkan Transliterasi</span>
                        <div class="toggle-switch active" onclick="toggleTransliteration()" id="transliterationToggle"></div>
                    </div>

                    <div class="setting-item">
                        <span class="setting-label">Tampilkan Terjemahan</span>
                        <div class="toggle-switch active" onclick="toggleTranslation()" id="translationToggle"></div>
                    </div>

                    <div class="setting-item">
                        <span class="setting-label">Tampilkan Catatan Kaki</span>
                        <div class="toggle-switch" onclick="toggleAllFootnotes()" id="footnotesToggle"></div>
                    </div>
                    
                    <div class="setting-item">
                        <span class="setting-label">Tampilkan Tafsir</span>
                        <div class="toggle-switch" onclick="toggleAllTafsir()" id="tafsirToggle"></div>
                    </div>

                    <div class="setting-item2">
                        <span class="setting-label">Pilih Bahasa Terjemah</span>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                            Terjemahan dari QuranEnc.com
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="language-selector">
                            <button class="lang-btn active" onclick="setLanguage('id')" title="Bahasa Indonesia">ID</button>
                            <button class="lang-btn" onclick="setLanguage('en')" title="English">EN</button>
                            <button class="lang-btn" onclick="setLanguage('my')" title="Bahasa Melayu">MY</button>
                            <button class="lang-btn" onclick="setLanguage('fr')" title="Français">FR</button>
                            <button class="lang-btn" onclick="setLanguage('de')" title="Deutsch">DE</button>
                            <button class="lang-btn" onclick="setLanguage('tr')" title="Türkçe">TR</button>
                        </div>
                    </div>

                    <div class="setting-item2">
                        <span class="setting-label">Pilih Qari</span>
                    </div>
                    <div class="setting-item">
                        <select class="qari-select" id="qariSelect">
                            <option value="abdul-basit">Abdul Basit</option>
                            <option value="al-husary">Al Husary</option>
                            <option value="al-minshawi">Al Minshawi Mujawwad</option>
                            <option value="al-huzaifi">Ali bin Abdurrahman al-Huzaifi</option>
                            <option value="aziz-alili">Aziz Alili</option>
                            <option value="mishari-alafasy">Mishari Alafasy</option>
                            <option value="saad-al-ghamidi">Saad Al Ghamidi</option>
                            <option value="saud-ash-shuraym">Saud Ash-Shuraym</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="audio-controls">
            <button class="audio-btn" onclick="playAudio()" id="playAudioBtn" disabled>▶️ Putar Audio</button>
            <span id="audioStatus">🔇 Tidak ada audio yang tersedia</span>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="statistics" id="statistics">
            <div class="stat-item">
                <div class="stat-number" id="totalAyahs">0</div>
                <div class="stat-label">Total Ayat</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="readingProgress">0%</div>
                <div class="stat-label">Progress Baca</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="bookmarkCount">0</div>
                <div class="stat-label">Bookmark</div>
            </div>
        </div>

        <div class="navigation">
            <button class="nav-btn" onclick="previousSurah()" id="prevBtn">← Surah Sebelumnya</button>
            <button class="nav-btn" onclick="nextSurah()" id="nextBtn">Surah Selanjutnya →</button>
        </div>

        <div class="surah-container" id="surahContainer">
            <div class="loading">Pilih surah untuk mulai membaca</div>
        </div>
    </div>

    <button class="scroll-top" onclick="scrollToTop()" id="scrollTopBtn">↑</button>

    <!-- Bookmarks Panel -->
    <div class="bookmarks-panel" id="bookmarksPanel">
        <div class="bookmarks-header">
            <h3>📚 Bookmark Ayat</h3>
            <button class="close-bookmarks" onclick="toggleBookmarks()">×</button>
        </div>
        <div id="bookmarksList">
            <div style="padding: 20px; text-align: center; color: #666;">
                Belum ada bookmark
            </div>
        </div>
    </div>

    <script>
// Enhanced Quran data with more surahs
const tajwidData = {
    1: { // Al-Fatihah
        1: {
            tajwid: "بِسْمِ اللَّهِ الرَّحْمَ<span class='tajwid-mad'>ٰ</span>نِ الرَّحِيمِ"
        },
        2: {
            tajwid: "الْحَمْدُ لِللَّهِ رَبِّ الْعَ<span class='tajwid-mad'>ا</span>لَمِ<span class='tajwid-mad'>ي</span>نَ"
        },
        3: {
            tajwid: "الرَّحْمَ<span class='tajwid-mad'>ٰ</span>نِ الرَّحِ<span class='tajwid-mad'>ي</span>مِ"
        },
        4: {
            tajwid: "مَ<span class='tajwid-mad'>ا</span>لِكِ يَوْمِ الدِّ<span class='tajwid-mad'>ي</span>نِ"
        },
        5: {
            tajwid: "إِيَّ<span class='tajwid-mad'>ا</span>كَ نَعْبُدُ وَإِيَّ<span class='tajwid-mad'>ا</span>كَ نَسْتَعِ<span class='tajwid-mad'>ي</span>نُ"
        },
        6: {
            tajwid: "اهْدِنَا الصِّرَ<span class='tajwid-mad'>ا</span>طَ الْمُسْتَقِ<span class='tajwid-mad'>ي</span>مَ"
        },
        7: {
            tajwid: "صِرَ<span class='tajwid-mad'>ا</span>طَ الَّذِ<span class='tajwid-mad'>ي</span>نَ أَ<span class='tajwid-ikhfa'>نْ</span>عَمْتَ عَلَيْهِمْ غَيْ<span class='tajwid-mad'>ر</span> الْمَغْضُ<span class='tajwid-mad'>و</span>بِ عَلَيْهِمْ وَلَا الضَّ<span class='tajwid-mad'>ا</span>لِّ<span class='tajwid-mad'>ي</span>نَ"
        }
    },
    2: { // Al-Baqarah
        1: {
            tajwid: "الم"
        },
        2: {
            tajwid: "ذَ<span class='tajwid-mad'>ٰ</span>لِكَ الْكِتَ<span class='tajwid-mad'>ا</span>بُ لَا رَيْبَ ۛ فِ<span class='tajwid-mad'>ي</span>هِ ۛ هُدًى لِّلْمُتَّقِ<span class='tajwid-mad'>ي</span>نَ"
        },
        3: {
            tajwid: "الَّذِ<span class='tajwid-mad'>ي</span>نَ يُؤْمِنُ<span class='tajwid-mad'>و</span>نَ بِالْغَيْبِ وَيُقِ<span class='tajwid-mad'>ي</span>مُ<span class='tajwid-mad'>و</span>نَ الصَّلَ<span class='tajwid-mad'>ا</span>ةَ وَمِمَّا رَزَقْنَ<span class='tajwid-mad'>ا</span>هُمْ يُنفِقُ<span class='tajwid-mad'>و</span>نَ"
        }
    }
};

// 1. PERBAIKAN: Data quranData harus sebagai object, bukan function
const quranData = {
    1: {
        name: "Al-Fatihah",
        arabicName: "الفاتحة",
        meaning: "Pembukaan",
        revelation: "Makkah",
        verses: {
            1: {
                arabic: "بِسْمِ اللّٰهِ الرَّحْمٰنِ الرَّحِيْمِ ۝١",
                transliteration: "Bismillāhi'r-raḥmāni'r-raḥīm",
                translation: "Dengan menyebut nama Allah Yang Maha Pemurah lagi Maha Penyayang."
            },
            2: {
                arabic: "اَلْحَمْدُ لِلّٰهِ رَبِّ الْعٰلَمِيْنَۙ ۝٢",
                transliteration: "Al-ḥamdu lillāhi rabbi'l-'ālamīn",
                translation: "Segala puji bagi Allah, Tuhan semesta alam."
            },
            3: {
                arabic: "الرَّحْمٰنِ الرَّحِيْمِۙ ۝٣",
                transliteration: "Ar-raḥmāni'r-raḥīm", 
                translation: "Maha Pemurah lagi Maha Penyayang."
            },
            4: {
                arabic: "مٰلِكِ يَوْمِ الدِّيْنِۗ ۝٤",
                transliteration: "Māliki yawmi'd-dīn",
                translation: "Yang menguasai di Hari Pembalasan."
            },
            5: {
                arabic: "اِيَّاكَ نَعْبُدُ وَاِيَّاكَ نَسْتَعِيْنُۗ ۝٥",
                transliteration: "Iyyāka na'budu wa iyyāka nasta'īn",
                translation: "Hanya kepada Engkaulah kami menyembah dan hanya kepada Engkaulah kami meminta pertolongan."
            },
            6: {
                arabic: "اِهْدِنَا الصِّرَاطَ الْمُسْتَقِيْمَۙ ۝٦",
                transliteration: "Ihdinaṣ-ṣirāṭal-mustaqīm",
                translation: "Tunjukilah kami jalan yang lurus."
            },
            7: {
                arabic: "صِرَاطَ الَّذِيْنَ اَنْعَمْتَ عَلَيْهِمْ ەۙ غَيْرِ الْمَغْضُوْبِ عَلَيْهِمْ وَلَا الضَّاۤلِّيْنَࣖ ۝٧",
                transliteration: "Ṣirāṭal-ladhīna an'amta 'alayhim ghayril-maghḍūbi 'alayhim wa laḍ-ḍāllīn",
                translation: "(Yaitu) jalan orang-orang yang telah Engkau beri nikmat kepada mereka; bukan (jalan) mereka yang dimurkai dan bukan (pula jalan) mereka yang sesat."
            }
        }
    },
    2: {
        name: "Al-Baqarah",
        arabicName: "البقرة",
        meaning: "Sapi Betina",
        revelation: "Madinah",
        verses: {
            1: {
                arabic: "الم",
                transliteration: "Alif Lām Mīm",
                translation: "Alif Laam Miim."
            },
            2: {
                arabic: "ذَٰلِكَ الْكِتَابُ لَا رَيْبَ ۛ فِيهِ ۛ هُدًى لِّلْمُتَّقِينَ",
                transliteration: "Dhālika al-kitābu lā rayba fīhi hudal lil-muttaqīn",
                translation: "Kitab (Al Quran) ini tidak ada keraguan padanya; petunjuk bagi mereka yang bertakwa."
            },
            3: {
                arabic: "الَّذِينَ يُؤْمِنُونَ بِالْغَيْبِ وَيُقِيمُونَ الصَّلَاةَ وَمِمَّا رَزَقْنَاهُمْ يُنفِقُونَ",
                transliteration: "Alladhīna yu'minūna bil-ghaybi wa yuqīmūnaṣ-ṣalāta wa mimmā razaqnāhum yunfiqūn",
                translation: "(yaitu) mereka yang beriman kepada yang ghaib, yang mendirikan shalat, dan menafkahkan sebahagian rezeki yang Kami anugerahkan kepada mereka."
            }
        }
    },
    3: {
        name: "Ali 'Imran",
        arabicName: "آل عمران",
        meaning: "Keluarga Imran",
        revelation: "Madinah",
        verses: {
            1: {
                arabic: "الم",
                transliteration: "Alif Lām Mīm",
                translation: "Alif Laam Miim."
            },
            2: {
                arabic: "اللَّهُ لَا إِلَٰهَ إِلَّا هُوَ الْحَيُّ الْقَيُّومُ",
                transliteration: "Allāhu lā ilāha illā huwal-ḥayy ul-qayyūm",
                translation: "Allah, tidak ada Tuhan selain Dia Yang Hidup kekal lagi terus menerus mengurus (makhluk-Nya)."
            }
        }
    }
};

// Global state
let currentSurah = 1;

let bookmarks = [];
let currentAudio = null;
let searchResults = [];
let autoPlayQueue = [];
let currentAutoIndex = 0;
let searchHistory = [];
// Variabel global untuk backup functions
let currentSurahProgress = null;
let isProgressChanged = false;

// Current state variables
let currentSurahNumber = null;
let maxReadingProgress = 0;

let originalLoadSurah = null;
let originalPreviousSurah = null;
let originalNextSurah = null;

let isLoadingSurah = false;

let currentSettings = {
    fontSize: 'medium',
    showTransliteration: true,
    showTranslation: true,
    showTajwid: false,
    showFootnotes: false,
    showTafsir: false,
    language: 'id', // Default Indonesian
    qari: 'abdul-basit',
    darkTheme: false
};
let audioPlayer = {
    isVisible: false,
    currentSpeed: 1.0,
    speeds: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0],
    speedIndex: 2,
    isMuted: false,
    volume: 1.0
};

// Search History functions
function loadSearchHistory() {
    const saved = localStorage.getItem('quranSearchHistory');
    try {
        const parsed = JSON.parse(saved);
        searchHistory = Array.isArray(parsed)
            ? parsed.map(item => typeof item === 'string' ? { text: item, pinned: false } : item)
            : [];
    } catch {
        searchHistory = [];
    }
    renderSearchHistory();
}

function addToSearchHistory(query) {
    if (!query || typeof query !== 'string') return;

    const existingIndex = searchHistory.findIndex(item => item.text === query);
    if (existingIndex !== -1) {
        const existingItem = searchHistory.splice(existingIndex, 1)[0];
        searchHistory.unshift(existingItem);
    } else {
        searchHistory.unshift({ text: query, pinned: false });
    }

    // Limit history
    const pinned = searchHistory.filter(h => h.pinned);
    const nonPinned = searchHistory.filter(h => !h.pinned).slice(0, 10 - pinned.length);
    searchHistory = [...pinned, ...nonPinned];

    renderSearchHistory();
    saveSilently();
}

// FUNGSI renderSearchHistory()
function renderSearchHistory() {
    const container = document.getElementById('searchHistoryList');
    if (!container) return;
    
    container.innerHTML = '';

    if (!searchHistory.length) {
        container.innerHTML = '<div style="padding: 10px; color: #666; text-align: center;">Belum ada riwayat</div>';
        return;
    }

    // Sort sekali saja saat render
    const sorted = [...searchHistory].sort((a, b) => (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0));

    sorted.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'search-history-item';
        div.setAttribute('data-index', index);
        div.setAttribute('data-text', item.text);

        const icon = document.createElement('span');
        icon.className = 'search-history-icon';
        icon.textContent = '🕓';

        const text = document.createElement('span');
        text.className = 'search-history-text';
        text.textContent = item.text || '';
        
        // HANYA TEXT YANG BISA DIKLIK UNTUK SEARCH
        text.addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('searchInput').value = item.text;
            searchVerse();
            // HANYA SEARCH YANG MENUTUP PANEL
            document.getElementById('searchContainer').classList.remove('show');
            document.getElementById('searchHistory').classList.remove('show');
        });

        const actions = document.createElement('span');
        actions.style.display = 'flex';
        actions.style.gap = '5px';

        const pinBtn = document.createElement('button');
        pinBtn.className = 'search-history-pin';
        pinBtn.textContent = item.pinned ? '📌' : '📍';
        pinBtn.title = item.pinned ? 'Unpin dari atas' : 'Pin ke atas';
        pinBtn.setAttribute('data-text', item.text);
        
        // PIN BUTTON - TIDAK MENUTUP PANEL
        pinBtn.addEventListener('click', handleInstantPin);

        const delBtn = document.createElement('button');
        delBtn.className = 'search-history-delete';
        delBtn.textContent = '❌';
        delBtn.setAttribute('data-text', item.text);
        
        // DELETE BUTTON - TIDAK MENUTUP PANEL  
        delBtn.addEventListener('click', handleInstantDelete);

        actions.appendChild(pinBtn);
        actions.appendChild(delBtn);

        div.appendChild(icon);
        div.appendChild(text);
        div.appendChild(actions);
        container.appendChild(div);
    });
}

// HANDLER INSTANT PIN - TANPA RE-RENDER
function handleInstantPin(e) {
    e.stopPropagation();
    e.preventDefault();
    
    const button = e.target;
    const itemText = button.getAttribute('data-text');
    
    // Cari item di data
    const item = searchHistory.find(h => h.text === itemText);
    if (!item) return;
    
    // Toggle pin status
    item.pinned = !item.pinned;
    
    // Update button INSTANTLY
    button.textContent = item.pinned ? '📌' : '📍';
    button.title = item.pinned ? 'Unpin dari atas' : 'Pin ke atas';
    
    // Move item ke posisi yang tepat tanpa full re-render
    const itemDiv = button.closest('.search-history-item');
    const container = document.getElementById('searchHistoryList');
    
    if (item.pinned) {
        // Pindah ke atas (setelah item pinned lainnya)
        const pinnedItems = container.querySelectorAll('.search-history-item');
        let insertAfter = null;
        
        for (let pinnedItem of pinnedItems) {
            const pinnedBtn = pinnedItem.querySelector('.search-history-pin');
            if (pinnedBtn && pinnedBtn.textContent === '📌' && pinnedItem !== itemDiv) {
                insertAfter = pinnedItem;
            } else {
                break;
            }
        }
        
        if (insertAfter) {
            container.insertBefore(itemDiv, insertAfter.nextSibling);
        } else {
            container.insertBefore(itemDiv, container.firstChild);
        }
    } else {
        // Pindah ke bawah (setelah semua item pinned)
        const allItems = container.querySelectorAll('.search-history-item');
        let lastPinned = null;
        
        for (let anyItem of allItems) {
            const anyBtn = anyItem.querySelector('.search-history-pin');
            if (anyBtn && anyBtn.textContent === '📌') {
                lastPinned = anyItem;
            }
        }
        
        if (lastPinned && lastPinned !== itemDiv) {
            container.insertBefore(itemDiv, lastPinned.nextSibling);
        }
    }
    
    // Save ke localStorage di background (non-blocking)
    saveSilently();
    
    // PASTIKAN PANEL TETAP TERBUKA - FORCE KEEP OPEN
    setTimeout(() => {
        const searchContainer = document.getElementById('searchContainer');
        const searchHistoryPanel = document.getElementById('searchHistory');
        if (searchContainer) searchContainer.classList.add('show');
        if (searchHistoryPanel) searchHistoryPanel.classList.add('show');
    }, 10);
}

// HANDLER INSTANT DELETE
function handleInstantDelete(e) {
    e.stopPropagation();
    e.preventDefault();
    
    const button = e.target;
    const itemText = button.getAttribute('data-text');
    const itemDiv = button.closest('.search-history-item');
    
    // Instant visual feedback
    itemDiv.style.transform = 'translateX(100%)';
    itemDiv.style.opacity = '0';
    itemDiv.style.transition = 'all 0.2s ease';
    
    // Remove dari DOM setelah animasi
    setTimeout(() => {
        if (itemDiv.parentNode) {
            itemDiv.remove();
        }
        
        // Cek jika tidak ada history lagi, tampilkan pesan kosong
        const container = document.getElementById('searchHistoryList');
        if (container && container.children.length === 0) {
            container.innerHTML = '<div style="padding: 10px; color: #666; text-align: center;">Belum ada riwayat</div>';
        }
    }, 200);
    
    // Remove dari data
    searchHistory = searchHistory.filter(h => h.text !== itemText);
    
    // Save di background
    saveSilently();
    
    // PASTIKAN PANEL TETAP TERBUKA - FORCE KEEP OPEN
    setTimeout(() => {
        const searchContainer = document.getElementById('searchContainer');
        const searchHistoryPanel = document.getElementById('searchHistory');
        if (searchContainer) searchContainer.classList.add('show');
        if (searchHistoryPanel) searchHistoryPanel.classList.add('show');
    }, 10);
}

// SILENT SAVE - Non-blocking
function saveSilently() {
    // Gunakan setTimeout 0 untuk non-blocking save
    setTimeout(() => {
        try {
            localStorage.setItem('quranSearchHistory', JSON.stringify(searchHistory));
        } catch (error) {
            console.error('Error saving search history:', error);
        }
    }, 0);
}

// TAMBAHKAN FUNGSI BARU ini (letakkan setelah renderSearchHistory):

function quickTogglePin(itemText) {
    const item = searchHistory.find(h => h.text === itemText);
    if (!item) return;
    
    item.pinned = !item.pinned;
    
    // Update button instantly
    const pinBtn = document.querySelector(`[data-text="${itemText}"] .search-history-pin`);
    if (pinBtn) {
        pinBtn.textContent = item.pinned ? '📌' : '📍';
        pinBtn.title = item.pinned ? 'Unpin dari atas' : 'Pin ke atas';
    }
    
    // Save asynchronously
    requestIdleCallback(() => {
        try {
            localStorage.setItem('quranSearchHistory', JSON.stringify(searchHistory));
        } catch (error) {
            console.error('Error saving search history:', error);
        }
    });
}

function clearSearchHistory() {
    const container = document.getElementById('searchHistoryList');
    
    // Instant clear visual
    if (container) {
        container.innerHTML = '<div style="padding: 10px; color: #666; text-align: center;">Belum ada riwayat</div>';
    }
    
    // Clear data
    searchHistory = [];
    
    // Save di background
    saveSilently();
    
    showSuccess('Riwayat pencarian berhasil dihapus'); // SUCCESS - RIGHT SIDE
    
    // PASTIKAN PANEL TETAP TERBUKA SETELAH CLEAR
    setTimeout(() => {
        const searchContainer = document.getElementById('searchContainer');
        const searchHistoryPanel = document.getElementById('searchHistory');
        if (searchContainer) searchContainer.classList.add('show');
        if (searchHistoryPanel) searchHistoryPanel.classList.add('show');
    }, 10);
}

// TAMBAHAN: FUNGSI UNTUK MEMASTIKAN PANEL TETAP TERBUKA
function keepSearchPanelOpen() {
    const searchContainer = document.getElementById('searchContainer');
    const searchHistory = document.getElementById('searchHistory');
    
    if (searchContainer) searchContainer.classList.add('show');
    if (searchHistory) searchHistory.classList.add('show');
}

// Initialize bookmarks from localStorage
function initBookmarks() {
    try {
        const saved = localStorage.getItem('quranBookmarks');
        bookmarks = saved ? JSON.parse(saved) : [];
    } catch (error) {
        console.error('Error loading bookmarks:', error);
        bookmarks = [];
    }
}

function updateBookmarkCount() {
    try {
        const countElement = document.getElementById('bookmarkCount');
        if (countElement) {
            countElement.textContent = bookmarks.length;
        }
    } catch (error) {
        console.error('Error updating bookmark count:', error);
    }
}

function showError(message) {
    try {
        const container = document.getElementById('surahContainer');
        if (container) {
            container.innerHTML = `
                <div class="error">
                    ❌ ${message}
                </div>
            `;
        }
        
        // Show error notification on LEFT
        showNotification(message, 'error');
        console.error('Error:', message);
    } catch (error) {
        console.error('Error showing error message:', error);
    }
}

// FUNGSI KHUSUS UNTUK SUCCESS NOTIFICATIONS  
function showSuccess(message) {
    showNotification(message, 'success');
}

// FUNGSI KHUSUS UNTUK WARNING NOTIFICATIONS
function showWarning(message) {
    try {
        const existing = document.querySelectorAll('.notification-warning');
        existing.forEach(n => n.remove());

        const notification = document.createElement('div');
        notification.className = 'notification notification-warning';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff9800;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 9999;
            animation: slideInTop 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
            border-top: 4px solid #f57c00;
            max-width: 350px;
            word-wrap: break-word;
        `;
        
        notification.textContent = '⚠️ ' + message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideOutTop 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }
        }, 4000);
        
        console.log('WARNING Notification:', message);
    } catch (error) {
        console.error('Error showing warning:', error);
    }
}

// TAMBAHKAN CSS ANIMATIONS baru untuk slide in/out
function addNotificationStyles() {
    const style = document.createElement('style');
    style.innerHTML = `
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutLeft {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(-100px);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100px);
            }
        }

        @keyframes slideInTop {
            from {
                opacity: 0;
                transform: translate(-50%, -50px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        @keyframes slideOutTop {
            from {
                opacity: 1;
                transform: translate(-50%, 0);
            }
            to {
                opacity: 0;
                transform: translate(-50%, -50px);
            }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .notification-error {
                left: 10px !important;
                right: auto !important;
                max-width: calc(100vw - 20px) !important;
            }
            
            .notification-success {
                right: 10px !important;
                left: auto !important;
                max-width: calc(100vw - 20px) !important;
            }
            
            .notification-warning {
                left: 50% !important;
                max-width: calc(100vw - 20px) !important;
            }
        }
    `;
    document.head.appendChild(style);
}

// PERBAIKAN: Notification system dengan anti-spam
let lastNotificationTime = 0;
let lastNotificationMessage = '';

function showNotification(message, type = 'success') {
    try {
        const now = Date.now();
        
        // PERBAIKAN: Cegah notification yang sama dalam 2 detik
        if (message === lastNotificationMessage && (now - lastNotificationTime) < 2000) {
            console.log('Duplicate notification blocked:', message);
            return;
        }
        
        lastNotificationTime = now;
        lastNotificationMessage = message;
        
        // Remove existing notifications of the same type
        const existing = document.querySelectorAll(`.notification-${type}`);
        existing.forEach(n => n.remove());

        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        
        if (type === 'error') {
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 20px;
                background: #f44336;
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 9999;
                animation: slideInLeft 0.3s ease;
                box-shadow: 0 5px 15px rgba(244, 67, 54, 0.3);
                border-left: 4px solid #d32f2f;
                max-width: 350px;
                word-wrap: break-word;
            `;
        } else {
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4caf50;
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 9999;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
                border-right: 4px solid #388e3c;
                max-width: 350px;
                word-wrap: break-word;
            `;
        }
        
        const icon = type === 'error' ? '❌ ' : '✅ ';
        notification.textContent = icon + message;
        
        document.body.appendChild(notification);
        
        // PERBAIKAN: Kurangi delay auto remove
        const delay = type === 'error' ? 4000 : 2000; // Kurangi dari 5000/3000 ke 4000/2000
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = type === 'error' ? 'slideOutLeft 0.3s ease' : 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }
        }, delay);
        
    } catch (error) {
        console.error('Error showing notification:', error);
    }
}

// Setup event listeners
function setupEventListeners() {
    try {
        // Surah selection change handler
        const surahSelect = document.getElementById('surah');
        if (surahSelect) {
            surahSelect.addEventListener('change', function() {
                console.log('Surah changed to:', this.value);
                updateNavigationButtons();
            });
        }

        // Load surah button
        const loadBtn = document.getElementById('loadSurahBtn');
        if (loadBtn) {
            loadBtn.onclick = function(e) {
                e.preventDefault();
                console.log('Load button clicked');
                loadSurah();
            };
        }

        // Previous button
        const prevBtn = document.getElementById('prevBtn');
        if (prevBtn) {
            prevBtn.onclick = function(e) {
                e.preventDefault();
                console.log('Previous button clicked');
                previousSurah();
            };
        }

        // Next button
        const nextBtn = document.getElementById('nextBtn');
        if (nextBtn) {
            nextBtn.onclick = function(e) {
                e.preventDefault();
                console.log('Next button clicked');
                nextSurah();
            };
        }

        // Search input enter key
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchVerse();
                }
            });

            searchInput.addEventListener('focus', () => {
                const historyPanel = document.getElementById('searchHistory');
                if (historyPanel) {
                    renderSearchHistory();
                    historyPanel.classList.add('show');
                }
            });
        }

        console.log('✅ Event listeners setup completed');
    } catch (error) {
        console.error('Error setting up event listeners:', error);
    }
}

// PERBAIKAN 9: Fungsi khusus untuk scroll ke bagian tertentu
function scrollToSection(sectionClass, offset = 100) {
    const section = document.querySelector(sectionClass);
    if (section) {
        const elementTop = section.offsetTop;
        window.scrollTo({
            top: elementTop - offset,
            behavior: 'smooth'
        });
    }
}



// Load saved settings
function loadSettings() {
    try {
        const saved = localStorage.getItem('quranSettings');
        if (saved) {
            currentSettings = { ...currentSettings, ...JSON.parse(saved) };
            applySettings();
        }
    } catch (error) {
        console.error('Error loading settings:', error);
    }
}

// Save settings to localStorage
function saveSettings() {
    try {
        localStorage.setItem('quranSettings', JSON.stringify(currentSettings));
    } catch (error) {
        console.error('Error saving settings:', error);
    }
}

// Apply settings to UI
function applySettings() {
    try {
        // Apply theme
        if (currentSettings.darkTheme) {
            document.body.classList.add('dark-theme');
            const themeBtn = document.querySelector('.theme-toggle');
            if (themeBtn) themeBtn.textContent = '☀️';
        }

        // Apply font size
        document.querySelectorAll('.arabic').forEach(el => {
            el.className = el.className.replace(/\b(small|medium|large|xlarge)-text\b/, '');
            el.classList.add(currentSettings.fontSize + '-text');
        });

        // Update toggles
        const transliterationToggle = document.getElementById('transliterationToggle');
        const translationToggle = document.getElementById('translationToggle');
        const tajwidToggle = document.getElementById('tajwidToggle');
        const tajwidLegend = document.getElementById('tajwidLegend');
        
        if (transliterationToggle) {
            transliterationToggle.classList.toggle('active', currentSettings.showTransliteration);
        }
        if (translationToggle) {
            translationToggle.classList.toggle('active', currentSettings.showTranslation);
        }
        if (tajwidToggle) {
            tajwidToggle.classList.toggle('active', currentSettings.showTajwid);
        }
        if (tajwidLegend) {
            tajwidLegend.style.display = currentSettings.showTajwid ? 'grid' : 'none';
        }

        // Update font buttons
        document.querySelectorAll('.font-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        const activeFontBtn = document.querySelector(`[onclick="setFontSize('${currentSettings.fontSize}')"]`);
        if (activeFontBtn) activeFontBtn.classList.add('active');

        // Update language buttons
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        const activeLangBtn = document.querySelector(`[onclick="setLanguage('${currentSettings.language}')"]`);
        if (activeLangBtn) activeLangBtn.classList.add('active');

        // Update qari select
        const qariSelect = document.getElementById('qariSelect');
        if (qariSelect) qariSelect.value = currentSettings.qari;

        // Update Arabic text display
        updateArabicTextDisplay();
    } catch (error) {
        console.error('Error applying settings:', error);
    }
}

// Toggle tajwid
function toggleTajwid() {
    currentSettings.showTajwid = !currentSettings.showTajwid;
    const toggle = document.getElementById('tajwidToggle');
    const legend = document.getElementById('tajwidLegend');
    
    if (toggle) toggle.classList.toggle('active');
    if (legend) legend.style.display = currentSettings.showTajwid ? 'grid' : 'none';
    
    updateArabicTextDisplay();
    saveSettings();
}

// Update tampilan teks Arab dengan/tanpa tajwid
function updateArabicTextDisplay() {
    document.querySelectorAll('.arabic').forEach(el => {
        const surahNum = el.getAttribute('data-surah');
        const verseNum = el.getAttribute('data-verse');
        
        if (surahNum && verseNum) {
            if (currentSettings.showTajwid && tajwidData[surahNum] && tajwidData[surahNum][verseNum]) {
                el.innerHTML = tajwidData[surahNum][verseNum].tajwid;
            } else if (quranData[surahNum] && quranData[surahNum].verses[verseNum]) {
                el.innerHTML = quranData[surahNum].verses[verseNum].arabic;
            }
        }
    });
}

// Get Arabic Text with tajwid
function getArabicText(surahNum, verseNum) {
    if (currentSettings.showTajwid && tajwidData[surahNum] && tajwidData[surahNum][verseNum]) {
        return tajwidData[surahNum][verseNum].tajwid;
    }
    if (quranData[surahNum] && quranData[surahNum].verses[verseNum]) {
        return quranData[surahNum].verses[verseNum].arabic;
    }
    return '';
}

// Populate surah select
function populateSurahSelect() {
    try {
        const select = document.getElementById('surah');
        if (!select) {
            console.error('Surah select element not found');
            return;
        }
        
        select.innerHTML = '';
        
        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Pilih Surah...';
        select.appendChild(defaultOption);
        
        // Get available surahs from quranData
        const availableSurahs = Object.keys(quranData).map(Number).sort((a, b) => a - b);
        console.log('Populating select with surahs:', availableSurahs);
        
        // Add surah options
        availableSurahs.forEach(surahNum => {
            const surah = quranData[surahNum];
            if (surah) {
                const option = document.createElement('option');
                option.value = surahNum;
                option.textContent = `${surahNum}. ${surah.name} (${surah.arabicName})`;
                select.appendChild(option);
            }
        });
        
        console.log(`Surah select populated with ${availableSurahs.length} surahs`);
        
        // Initial navigation buttons update
        updateNavigationButtons();
    } catch (error) {
        console.error('Error populating surah select:', error);
    }
}

function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Jangan jalankan shortcut jika sedang mengetik di input field
        if (e.target.matches('input, textarea, select')) {
            return;
        }
        
        // Arrow keys untuk navigasi
        if (e.key === 'ArrowLeft' && !e.ctrlKey && !e.metaKey) {
            e.preventDefault();
            previousSurah();
        } else if (e.key === 'ArrowRight' && !e.ctrlKey && !e.metaKey) {
            e.preventDefault();
            nextSurah();
        }
        
        // Ctrl/Cmd + Arrow untuk navigasi dengan modifier
        if ((e.ctrlKey || e.metaKey) && e.key === 'ArrowLeft') {
            e.preventDefault();
            previousSurah();
        } else if ((e.ctrlKey || e.metaKey) && e.key === 'ArrowRight') {
            e.preventDefault();
            nextSurah();
        }
    });
    
    console.log('✅ Keyboard shortcuts for navigation setup completed');
}

// 8. PERBAIKAN: Update setupEventListeners untuk include navigation
function setupEventListenersWithNavigation() {
    try {
        // Setup basic event listeners
        setupEventListeners();
        
        // Setup navigation event listeners
        setupNavigationEventListeners();
        
        // Setup keyboard shortcuts
        setupKeyboardShortcuts();
        
        console.log('✅ All event listeners with navigation setup completed');
    } catch (error) {
        console.error('Error setting up event listeners with navigation:', error);
    }
}

// 9. PERBAIKAN: Override navigation functions dalam progress system
function overrideNavigationFunctionsForProgress() {
    try {
        // Backup original functions jika belum di-backup
        if (typeof previousSurah === 'function' && !window.originalPreviousSurah) {
            window.originalPreviousSurah = previousSurah;
            window.previousSurah = previousSurahWithProgressConfirm;
            console.log('previousSurah function overridden for progress system');
        }
        
        if (typeof nextSurah === 'function' && !window.originalNextSurah) {
            window.originalNextSurah = nextSurah;
            window.nextSurah = nextSurahWithProgressConfirm;
            console.log('nextSurah function overridden for progress system');
        }
        
        // Update event listeners untuk tombol navigasi dengan functions yang baru
        setTimeout(() => {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (prevBtn) {
                prevBtn.onclick = null;
                prevBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (typeof previousSurah === 'function') {
                        previousSurah();
                    }
                });
            }
            
            if (nextBtn) {
                nextBtn.onclick = null;
                nextBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (typeof nextSurah === 'function') {
                        nextSurah();
                    }
                });
            }
            
            console.log('✅ Navigation functions updated for progress system');
        }, 100);
        
    } catch (error) {
        console.error('Error overriding navigation functions for progress:', error);
    }
}

// 10. PERBAIKAN: Inisialisasi lengkap untuk navigation
function initializeNavigationSystem() {
    try {
        console.log('Initializing Navigation System...');
        
        // Setup event listeners
        setupNavigationEventListeners();
        
        // Setup keyboard shortcuts
        setupKeyboardShortcuts();
        
        // Update navigation buttons
        updateNavigationButtons();
        
        // Override untuk progress system (dengan delay)
        setTimeout(() => {
            overrideNavigationFunctionsForProgress();
        }, 2500);
        
        console.log('✅ Navigation System initialized successfully');
    } catch (error) {
        console.error('Error initializing navigation system:', error);
    }
}

// 1. FUNGSI LOADSURAH DIRECT (TANPA PROGRESS CONFIRMATION)
function loadSurahDirect() {
    try {
        const surahSelect = document.getElementById('surah');
        const surahNumber = parseInt(surahSelect.value);
        
        if (!surahNumber || isNaN(surahNumber)) {
            showError('Silakan pilih surah terlebih dahulu');
            return;
        }
        
        currentSurah = surahNumber;
        currentSurahNumber = surahNumber;
        
        const surah = quranData[surahNumber];
        if (!surah) {
            showError('Surah tidak ditemukan dalam database');
            return;
        }

        // Reset progress sebelum load surah baru
        resetProgress();

        // Update audio button
        const playBtn = document.getElementById('playAudioBtn');
        if (playBtn) {
            playBtn.disabled = false;
            playBtn.textContent = `▶️ Putar Surah ${surah.name}`;
        }

        updateAudioStatus(currentSurah);
        
        console.log('Loading surah:', surah.name);
        displaySurah(surah, surahNumber);
        updateStatistics();
        updateNavigationButtons();
        closeAllPanels();
        
        // Scroll ke header surah setelah render
        setTimeout(() => {
            const surahHeader = document.querySelector('.surah-header');
            if (surahHeader) {
                const headerTop = surahHeader.offsetTop;
                window.scrollTo({ 
                    top: headerTop - 20,
                    behavior: 'smooth'
                });
            }
            
            // Update progress setelah scroll dan render selesai
            setTimeout(() => {
                updateReadingProgress();
            }, 800);
        }, 500);
        
        showSuccess(`Surah ${surah.name} berhasil dimuat`);
    } catch (error) {
        console.error('Error loading surah:', error);
        showError('Terjadi kesalahan saat memuat surah');
    }
}

// 8. PERBAIKAN: Fungsi loadSurah normal tanpa konfirmasi progress
function loadSurah() {
    try {
        const surahSelect = document.getElementById('surah');
        if (!surahSelect) {
            showError('Surah select not found');
            return;
        }
        
        const newSurahNumber = parseInt(surahSelect.value);
        
        if (!newSurahNumber || isNaN(newSurahNumber)) {
            showError('Silakan pilih surah terlebih dahulu');
            return;
        }
        
        // Fungsi untuk melanjutkan load surah baru
        const proceedToNewSurah = () => {
            currentSurahNumber = newSurahNumber;
            
            // Cek apakah surah baru memiliki progress tersimpan
            if (hasSavedProgress(newSurahNumber)) {
                const savedProgress = loadProgressForSurah(newSurahNumber);
                
                // Tampilkan modal konfirmasi untuk melanjutkan atau mulai dari awal
                showContinueProgressModal(newSurahNumber, savedProgress, () => {
                    // PERBAIKAN: Gunakan loadSurahDirect(), BUKAN loadSurah()
                    loadSurahDirect();
                    currentSurah = newSurahNumber;
                });
            } else {
                // Surah baru, mulai dari 0%
                maxReadingProgress = 0;
                updateProgressBarDisplay();
                
                // PERBAIKAN: Gunakan loadSurahDirect(), BUKAN loadSurah()
                loadSurahDirect();
                currentSurah = newSurahNumber;
            }
        };
        
        // Jika ada surah sebelumnya dengan progress > 0, tanya save/delete
        if (currentSurahNumber && currentSurahNumber !== newSurahNumber && maxReadingProgress > 0) {
            showSaveProgressModal(currentSurahNumber, maxReadingProgress, proceedToNewSurah);
        } else {
            // Langsung ke surah baru
            proceedToNewSurah();
        }
    } catch (error) {
        console.error('Error in loadSurah:', error);
        showError('Terjadi kesalahan saat memuat surah');
    }
}

function pauseAudio() {
    if (currentAudio && !currentAudio.paused) {
        currentAudio.pause();
        const playBtn = document.getElementById('playPauseBtn');
        if (playBtn) playBtn.textContent = '▶️';
    }
}

// Display surah
function displaySurah(surah, surahNumber) {
    try {
        const container = document.getElementById('surahContainer');
        if (!container) {
            console.error('Surah container not found');
            return;
        }
        
        let html = `
            <div class="surah-header">
                <h2>${surah.name} - ${surah.arabicName}</h2>
                <p>Arti: ${surah.meaning} | Turun di: ${surah.revelation} | ${Object.keys(surah.verses).length} Ayat</p>
            </div>
        `;

        Object.keys(surah.verses).forEach(verseNum => {
            const verse = surah.verses[verseNum];
            const isBookmarked = bookmarks.some(b => b.surah === surahNumber && b.verse === parseInt(verseNum));
            
            html += `
                <div class="ayah-card" id="ayah-${surahNumber}-${verseNum}">
                    <div class="left-section">
                        <div class="ayah-number">Ayat ${verseNum}</div>
                        
                        ${currentSettings.showTransliteration ? `
                            <div class="transliteration" style="display: block;">
                                <h4>Transliterasi:</h4>
                                <p>${verse.transliteration}</p>
                            </div>
                        ` : `
                            <div class="transliteration" style="display: none;">
                                <h4>Transliterasi:</h4>
                                <p>${verse.transliteration}</p>
                            </div>
                        `}
                        
                        ${currentSettings.showTranslation ? `
                            <div class="translation" style="display: block;">
                                <h4>Terjemahan:</h4>
                                <p>${verse.translation}</p>
                            </div>
                        ` : `
                            <div class="translation" style="display: none;">
                                <h4>Terjemahan:</h4>
                                <p>${verse.translation}</p>
                            </div>
                        `}

                        <div class="verse-actions">
                            <button class="action-btn bookmark-btn ${isBookmarked ? 'bookmarked' : ''}" 
                                    onclick="toggleBookmark(${surahNumber}, ${verseNum})">
                                ${isBookmarked ? '🔖 Tersimpan' : '🔖 Simpan'}
                            </button>
                            <button class="action-btn" onclick="copyVerse(${surahNumber}, ${verseNum})">
                                📋 Salin
                            </button>
                            <button class="action-btn" onclick="shareVerse(${surahNumber}, ${verseNum})">
                                📤 Bagikan
                            </button>
                            <button class="action-btn" onclick="playVerseAudio(${surahNumber}, ${verseNum})">
                                🔊 Audio
                            </button>
                        </div>
                    </div>
                    
                    <div class="arabic-text">
                        <div class="arabic ${currentSettings.fontSize}-text" onclick="highlightVerse(${surahNumber}, ${verseNum})" data-surah="${surahNumber}" data-verse="${verseNum}">
                            ${getArabicText(surahNumber, verseNum)}
                        </div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
        console.log('Surah displayed successfully');
    } catch (error) {
        console.error('Error displaying surah:', error);
        showError('Terjadi kesalahan saat menampilkan surah');
    }
}

// Toggle theme
function toggleTheme() {
    currentSettings.darkTheme = !currentSettings.darkTheme;
    document.body.classList.toggle('dark-theme');
    const themeBtn = document.querySelector('.theme-toggle');
    if (themeBtn) {
        themeBtn.textContent = currentSettings.darkTheme ? '☀️' : '🌙';
    }
    saveSettings();
}

// Font size controls
function setFontSize(size) {
    currentSettings.fontSize = size;
    document.querySelectorAll('.font-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.querySelector(`[onclick="setFontSize('${size}')"]`);
    if (activeBtn) activeBtn.classList.add('active');
    
    document.querySelectorAll('.arabic').forEach(el => {
        el.className = el.className.replace(/\b(small|medium|large|xlarge)-text\b/, '');
        el.classList.add(size + '-text');
    });
    
    saveSettings();
}

// Toggle transliteration
function toggleTransliteration() {
    currentSettings.showTransliteration = !currentSettings.showTransliteration;
    const toggle = document.getElementById('transliterationToggle');
    if (toggle) toggle.classList.toggle('active');
    
    document.querySelectorAll('.transliteration').forEach(el => {
        el.style.display = currentSettings.showTransliteration ? 'block' : 'none';
    });
    
    saveSettings();
}

// Toggle translation
function toggleTranslation() {
    currentSettings.showTranslation = !currentSettings.showTranslation;
    const toggle = document.getElementById('translationToggle');
    if (toggle) toggle.classList.toggle('active');
    
    document.querySelectorAll('.translation').forEach(el => {
        el.style.display = currentSettings.showTranslation ? 'block' : 'none';
    });
    
    saveSettings();
}


// Toggle settings panel
function toggleSettings() {
    const panel = document.getElementById('settingsPanel');
    const overlay = document.getElementById('overlay');
    
    if (panel && overlay) {
        panel.classList.toggle('show');
        overlay.classList.toggle('show');
    }
}

// Toggle search
function toggleSearch() {
    const container = document.getElementById('searchContainer');
    if (container) {
        container.classList.toggle('show');
        
        if (container.classList.contains('show')) {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.focus();
        }
    }
}

// Search verse
function searchVerse() {
    const searchInput = document.getElementById('searchInput');
    const query = searchInput ? searchInput.value.toLowerCase().trim() : '';
    
    if (!query) {
        showError('Masukkan kata kunci pencarian'); // ERROR - LEFT SIDE
        return;
    }
    
    // Add to search history
    addToSearchHistory(query);
    
    // Show loading
    const container = document.getElementById('surahContainer');
    if (container) {
        container.innerHTML = '<div class="loading">Mencari ayat...</div>';
    }

    // Close search container
    const searchContainer = document.getElementById('searchContainer');
    if (searchContainer) {
        searchContainer.classList.remove('show');
    }
    
    // Clear search input
    if (searchInput) {
        searchInput.value = '';
    }
    
    // Perform search with delay for UI responsiveness
    setTimeout(() => {
        searchResults = [];
        Object.keys(quranData).forEach(surahNum => {
            const surah = quranData[surahNum];
            Object.keys(surah.verses).forEach(verseNum => {
                const verse = surah.verses[verseNum];
                if (verse.translation.toLowerCase().includes(query) || 
                    verse.transliteration.toLowerCase().includes(query) ||
                    verse.arabic.includes(query)) {
                    searchResults.push({
                        surah: parseInt(surahNum),
                        verse: parseInt(verseNum),
                        surahName: surah.name
                    });
                }
            });
        });
        
        if (searchResults.length === 0) {
            showError(`Tidak ditemukan ayat dengan kata kunci "${query}"`); // ERROR - LEFT SIDE
        } else {
            showSuccess(`Ditemukan ${searchResults.length} ayat untuk "${query}"`); // SUCCESS - RIGHT SIDE
        }
        
        displaySearchResults();
        
        // Auto-scroll to search results
        setTimeout(() => {
            const surahContainer = document.getElementById('surahContainer');
            if (surahContainer) {
                surahContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }, 100);
    }, 300);
}

// Display search results
function displaySearchResults() {
    const container = document.getElementById('surahContainer');
    if (!container) return;

    if (searchResults.length === 0) {
        showError('Tidak ada hasil pencarian yang ditemukan'); // ERROR - LEFT SIDE
        return;
    }
    
    let html = `
        <div class="surah-header">
            <h2>🔍 Hasil Pencarian</h2>
            <p>Ditemukan ${searchResults.length} ayat</p>
        </div>
    `;
    
    searchResults.forEach(result => {
        const verse = quranData[result.surah].verses[result.verse];
        const isBookmarked = bookmarks.some(b => b.surah === result.surah && b.verse === result.verse);
        
        html += `
            <div class="ayah-card highlight" id="ayah-${result.surah}-${result.verse}">
                <div class="left-section">
                    <div class="ayah-number">${result.surahName} - Ayat ${result.verse}</div>
                    <div class="transliteration">
                        <h4>Transliterasi:</h4>
                        <p>${verse.transliteration}</p>
                    </div>
                    <div class="translation">
                        <h4>Terjemahan:</h4>
                        <p>${verse.translation}</p>
                    </div>
                    <div class="verse-actions">
                        <button class="action-btn" onclick="goToVerse(${result.surah}, ${result.verse})">
                            📖 Lihat Surah
                        </button>
                        <button class="action-btn bookmark-btn ${isBookmarked ? 'bookmarked' : ''}" 
                                onclick="toggleBookmark(${result.surah}, ${result.verse})">
                            ${isBookmarked ? '🔖 Tersimpan' : '🔖 Simpan'}
                        </button>
                    </div>
                </div>
                <div class="arabic-text">
                    <div class="arabic ${currentSettings.fontSize}-text">
                        ${getArabicText(result.surah, result.verse)}
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// PERBAIKAN: Go to verse tanpa delay berlebihan
function goToVerse(surahNum, verseNum) {
    const surahSelect = document.getElementById('surah');
    if (surahSelect) {
        surahSelect.value = surahNum;
        currentSurah = surahNum;
        loadSurah();
        
        // Kurangi delay dari 1000ms ke 500ms
        setTimeout(() => {
            const element = document.getElementById(`ayah-${surahNum}-${verseNum}`);
            if (element) {
                const elementTop = element.offsetTop;
                const offset = 100; // Kurangi offset dari 120 ke 100
                
                window.scrollTo({
                    top: elementTop - offset,
                    behavior: 'smooth'
                });
                
                // Highlight langsung
                element.classList.add('highlight');
                setTimeout(() => element.classList.remove('highlight'), 2000);
                
                // Update progress tanpa delay tambahan
                updateReadingProgressFast();
            }
        }, 500); // Kurangi dari 1000ms ke 500ms
    }
}

// 9. FUNGSI INITIALIZATION YANG LENGKAP
function initializeProgressBar() {
    console.log('Initializing Progress Bar System...');
    
    // Setup scroll handler
    setupScrollHandler();
    
    // Force update progress setelah DOM benar-benar ready
    if (document.readyState === 'complete') {
        setTimeout(updateReadingProgressFast, 100); // Kurangi dari 1500ms ke 100ms
    } else {
        window.addEventListener('load', () => {
            setTimeout(updateReadingProgressFast, 100);
        });
    }
    
    // Observer untuk perubahan DOM (ketika ayah cards ditambahkan)
    if (typeof MutationObserver !== 'undefined') {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    // Cek apakah ada ayah card yang ditambahkan
                    const hasAyahCard = Array.from(mutation.addedNodes).some(node => 
                        node.nodeType === 1 && (
                            node.classList.contains('ayah-card') || 
                            node.querySelector('.ayah-card')
                        )
                    );
                    
                    if (hasAyahCard) {
                        setTimeout(() => {
                            updateReadingProgress();
                        }, 500);
                    }
                }
            });
        });
        
        // Observe perubahan di surah container
        const surahContainer = document.getElementById('surahContainer');
        if (surahContainer) {
            observer.observe(surahContainer, {
                childList: true,
                subtree: true
            });
        }
    }
    
    console.log('Progress Bar System initialized successfully');
    console.log('Optimized Progress Bar initialized');
}

// 10. FUNGSI UNTUK FORCE UPDATE PROGRESS (UNTUK DEBUGGING)
function forceUpdateProgress() {
    console.log('Force updating progress...');
    updateReadingProgress();
}

function handleProgressOnResize() {
    setTimeout(() => {
        updateReadingProgress();
    }, 200);
}

// PERBAIKAN 7: Tambahkan fungsi ini untuk reset progress saat ganti surah
function resetProgress() {
    const progressFill = document.getElementById('progressFill');
    const progressElement = document.getElementById('readingProgress');
    
    if (progressFill) {
        progressFill.style.width = '0%';
        progressFill.style.transition = 'width 0.3s ease';
    }
    if (progressElement) {
        progressElement.textContent = '0%';
    }
    
    console.log('Progress reset to 0%');
}

// Bookmark functions
function toggleBookmark(surahNum, verseNum) {
    try {
        const index = bookmarks.findIndex(b => b.surah === surahNum && b.verse === verseNum);
        
        if (index > -1) {
            bookmarks.splice(index, 1);
            showSuccess('Bookmark berhasil dihapus');
        } else {
            const verse = quranData[surahNum].verses[verseNum]; // Langsung dari quranData
            if (!verse) {
                showError('Ayat tidak ditemukan');
                return;
            }
            
            bookmarks.push({
                surah: surahNum,
                verse: verseNum,
                surahName: quranData[surahNum].name,
                text: verse.translation || 'Terjemahan tidak tersedia'
            });
            showSuccess('Bookmark berhasil ditambahkan');
        }
        
        // Save to localStorage
        try {
            localStorage.setItem('quranBookmarks', JSON.stringify(bookmarks));
        } catch (error) {
            console.error('Error saving bookmarks:', error);
            showError('Gagal menyimpan bookmark');
        }
        
        updateBookmarkCount();
        updateBookmarkButton(surahNum, verseNum);
        displayBookmarks();
        
    } catch (error) {
        console.error('Error toggling bookmark:', error);
        showError('Gagal mengatur bookmark');
    }
}

function updateBookmarkButton(surahNum, verseNum) {
    const isBookmarked = bookmarks.some(b => b.surah === surahNum && b.verse === verseNum);
    const button = document.querySelector(`#ayah-${surahNum}-${verseNum} .bookmark-btn`);
    
    if (button) {
        button.classList.toggle('bookmarked', isBookmarked);
        button.textContent = isBookmarked ? '🔖 Tersimpan' : '🔖 Simpan';
    }
}

function toggleBookmarks() {
    const panel = document.getElementById('bookmarksPanel');
    const overlay = document.getElementById('overlay');
    
    if (panel && overlay) {
        panel.classList.toggle('open');
        overlay.classList.toggle('show');
        
        if (panel.classList.contains('open')) {
            displayBookmarks();
        }
    }
}

function displayBookmarks() {
    const container = document.getElementById('bookmarksList');
    if (!container) return;
    
    if (bookmarks.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Belum ada bookmark</div>';
        return;
    }

    let html = '';
    bookmarks.forEach(bookmark => {
        html += `
            <div class="bookmark-item" onclick="goToVerse(${bookmark.surah}, ${bookmark.verse})">
                <h4>${bookmark.surahName} - Ayat ${bookmark.verse}</h4>
                <p>${bookmark.text.substring(0, 100)}...</p>
                <button onclick="event.stopPropagation(); removeBookmark(${bookmark.surah}, ${bookmark.verse})" 
                        style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; margin-top: 10px;">
                    🗑️ Hapus
                </button>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function removeBookmark(surahNum, verseNum) {
    toggleBookmark(surahNum, verseNum);
}

// Audio functions
function playAudio() {
    if (!currentSurah || !quranData[currentSurah]) {
        showError("Silakan pilih surah terlebih dahulu"); // ERROR - LEFT SIDE
        return;
    }

    const surah = quranData[currentSurah];
    const ayatKeys = Object.keys(surah.verses).map(Number);
    autoPlayQueue = ayatKeys.map(n => ({ surah: currentSurah, ayah: n }));
    currentAutoIndex = 0;

    showSuccess(`Memulai audio Surah ${surah.name}`); // SUCCESS - RIGHT SIDE
    playNextInQueue();
}

function getFormattedAyahNumber(surah, ayah) {
    return String(surah).padStart(3, '0') + String(ayah).padStart(3, '0');
}

function playVerseAudio(surahNum, verseNum) {
    const surah = quranData[surahNum];
    if (!surah || !surah.verses[verseNum]) {
        showNotification("❌ Ayat tidak ditemukan.");
        return;
    }

    // Prepare list of all verses from current verse to end of surah
    const ayatKeys = Object.keys(surah.verses).map(Number).filter(n => n >= verseNum);
    autoPlayQueue = ayatKeys.map(n => ({ surah: surahNum, ayah: n }));
    currentAutoIndex = 0;

    playNextInQueue();
}


// FUNGSI AUDIO
function playNextInQueue() {
    if (currentAutoIndex >= autoPlayQueue.length) {
        showSuccess("✅ Semua ayat selesai diputar.");
        closeAudioPlayer();
        currentAudio = null;
        autoPlayQueue = [];
        currentAutoIndex = 0;
        return;
    }

    const item = autoPlayQueue[currentAutoIndex];
    const surah = item.surah;
    const ayah = item.ayah;

    const qariMap = {
        'abdul-basit': 'AbdulBaset',
        'al-husary': 'Husary',
        'al-minshawi': 'Minshawi',
        'al-huzaifi': 'Hudzaifi',
        'aziz-alili': 'AzizAlili',
        'mishari-alafasy': 'Alafasy',
        'saad-al-ghamidi': 'SaadAlGhamdi',
        'saud-ash-shuraym': 'Shuraym'
    };

    const qariRaw = currentSettings.qari;
    const qari = qariMap[qariRaw] || 'AbdulBaset';

    const formattedNum = getFormattedAyahNumber(surah, ayah);
    const url = `https://verses.quran.com/${qari}/Mujawwad/mp3/${formattedNum}.mp3`;

    if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
    }

    currentAudio = new Audio(url);

        // Set audio properties
        currentAudio.playbackRate = audioPlayer.currentSpeed;
    currentAudio.volume = audioPlayer.isMuted ? 0 : audioPlayer.volume;
    
    // Update volume slider to reflect current volume
    const volumeSlider = document.getElementById('volumeSlider');
    if (volumeSlider) {
        volumeSlider.value = audioPlayer.isMuted ? 0 : audioPlayer.volume;
    }
    
    // Set audio properties
    currentAudio.playbackRate = audioPlayer.currentSpeed;
    currentAudio.volume = audioPlayer.isMuted ? 0 : audioPlayer.volume;
    
    // Show audio player
    if (!audioPlayer.isVisible) {
        showAudioPlayer();
    }
    
    // Update player info
    const totalVerses = Object.keys(quranData[surah].verses).length;
    updatePlayerInfo(quranData[surah].name, ayah, totalVerses);
    
    currentAudio.play().then(() => {
        const playPauseBtn = document.getElementById('playPauseBtn');
        if (playPauseBtn) playPauseBtn.textContent = '⏸️';
        
        // Highlight current verse being played
        const currentVerse = document.getElementById(`ayah-${surah}-${ayah}`);
        if (currentVerse) {
            // Remove previous highlights
            document.querySelectorAll('.ayah-card.highlight').forEach(el => {
                el.classList.remove('highlight');
            });
            // Add highlight to current verse
            currentVerse.classList.add('highlight');
            currentVerse.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }).catch((error) => {
        console.error('Audio playback error:', error);
        showError("❌ Gagal memutar audio. Melanjutkan ke ayat berikutnya...");
        // Continue to next verse even if current fails
        currentAutoIndex++;
        setTimeout(() => playNextInQueue(), 1000);
    });

    // Audio event listeners
    currentAudio.addEventListener('timeupdate', updateAudioProgress);
    
    currentAudio.addEventListener('ended', () => {
        currentAutoIndex++;
        setTimeout(() => playNextInQueue(), 500);
    });

    currentAudio.addEventListener('error', () => {
        console.error('Audio loading error for:', url);
        showError(`Gagal memuat audio ayat ${ayah}`);
        currentAutoIndex++;
        setTimeout(() => playNextInQueue(), 1000);
    });
    
    currentAudio.addEventListener('pause', () => {
        const playPauseBtn = document.getElementById('playPauseBtn');
        if (playPauseBtn) playPauseBtn.textContent = '▶️';
    });
    
    currentAudio.addEventListener('play', () => {
        const playPauseBtn = document.getElementById('playPauseBtn');
        if (playPauseBtn) playPauseBtn.textContent = '⏸️';
    });
}

// SETUP VOLUME SLIDER
function setupVolumeSlider() {
    const volumeSlider = document.getElementById('volumeSlider');
    if (!volumeSlider) {
        console.error('Volume slider not found');
        return;
    }
    
    console.log('Setting up volume slider...');
    
    // Remove existing listeners first
    volumeSlider.removeEventListener('input', handleVolumeChange);
    volumeSlider.removeEventListener('change', handleVolumeChange);
    
    // Add event listeners
    volumeSlider.addEventListener('input', handleVolumeChange);
    volumeSlider.addEventListener('change', handleVolumeChange);
    
    console.log('Volume slider setup complete');
}

function handleVolumeChange(e) {
    const newVolume = parseFloat(e.target.value);
    console.log('Volume changed to:', newVolume);
    
    audioPlayer.volume = newVolume;
    audioPlayer.isMuted = newVolume === 0;
    
    if (currentAudio) {
        currentAudio.volume = newVolume;
        console.log('Audio volume set to:', currentAudio.volume);
    }
    
    const muteBtn = document.getElementById('muteBtn');
    if (muteBtn) {
        muteBtn.textContent = newVolume === 0 ? '🔇' : '🔊';
    }
}

// INISIALISASI AUDIO PLAYER
function initializeAudioPlayer() {
    addAudioPlayerStyles();
    createAudioPlayer();
    // Setup volume slider setelah element dibuat
    setTimeout(() => {
        setupVolumeSlider();
    }, 100);
}

// Utility functions

function fallbackCopyText(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showNotification('Ayat berhasil disalin!');
    } catch (err) {
        console.error('Fallback copy failed:', err);
        showNotification('Gagal menyalin ayat');
    }
    
    document.body.removeChild(textArea);
}

function shareVerse(surahNum, verseNum) {
    const verse = quranData[surahNum].verses[verseNum];
    const surah = quranData[surahNum];
    const text = `${surah.name} - Ayat ${verseNum}\n\n${verse.arabic}\n\n${verse.transliteration}\n\n${verse.translation}`;
    
    if (navigator.share) {
        navigator.share({
            title: `${surah.name} - Ayat ${verseNum}`,
            text: text
        }).catch((error) => {
            console.error('Share failed:', error);
            copyVerse(surahNum, verseNum);
            showNotification('Ayat disalin, silakan bagikan secara manual');
        });
    } else {
        copyVerse(surahNum, verseNum);
        showNotification('Ayat disalin, silakan bagikan secara manual');
    }
}

function highlightVerse(surahNum, verseNum) {
    const element = document.getElementById(`ayah-${surahNum}-${verseNum}`);
    if (element) {
        element.classList.add('highlight');
        setTimeout(() => element.classList.remove('highlight'), 2000);
    }
}

// Navigation functions
function previousSurah() {
    try {
        const surahSelect = document.getElementById('surah');
        if (!surahSelect) return;
        
        const currentValue = parseInt(surahSelect.value);
        
        if (currentValue && currentValue > 1) {
            const availableSurahs = Object.keys(quranData).map(Number).sort((a, b) => a - b);
            const currentIndex = availableSurahs.indexOf(currentValue);
            
            if (currentIndex > 0) {
                const prevSurah = availableSurahs[currentIndex - 1];
                
                // Fungsi untuk pindah ke surah sebelumnya
                const proceedToPrevSurah = () => {
                    surahSelect.value = prevSurah;
                    updateNavigationButtons();
                    
                    // PERBAIKAN: Gunakan loadSurah() yang sudah smart
                    loadSurah();
                };
                
                // Jika ada progress pada surah saat ini, tanya save/delete
                if (currentSurahNumber && maxReadingProgress > 0) {
                    showSaveProgressModal(currentSurahNumber, maxReadingProgress, proceedToPrevSurah);
                } else {
                    proceedToPrevSurah();
                }
            } else {
                showWarning('⚠️ Sudah di surah pertama yang tersedia');
            }
        } else {
            showWarning('⚠️ Pilih surah terlebih dahulu');
        }
    } catch (error) {
        console.error('Error in previousSurah:', error);
        showError('❌ Gagal pindah ke surah sebelumnya');
    }
}

function nextSurah() {
    try {
        const surahSelect = document.getElementById('surah');
        if (!surahSelect) return;
        
        const currentValue = parseInt(surahSelect.value);
        
        if (currentValue) {
            const availableSurahs = Object.keys(quranData).map(Number).sort((a, b) => a - b);
            const currentIndex = availableSurahs.indexOf(currentValue);
            
            if (currentIndex < availableSurahs.length - 1) {
                const nextSurahNum = availableSurahs[currentIndex + 1];
                
                // Fungsi untuk pindah ke surah selanjutnya
                const proceedToNextSurah = () => {
                    surahSelect.value = nextSurahNum;
                    updateNavigationButtons();
                    
                    // PERBAIKAN: Gunakan loadSurah() yang sudah smart
                    loadSurah();
                };
                
                // Jika ada progress pada surah saat ini, tanya save/delete
                if (currentSurahNumber && maxReadingProgress > 0) {
                    showSaveProgressModal(currentSurahNumber, maxReadingProgress, proceedToNextSurah);
                } else {
                    proceedToNextSurah();
                }
            } else {
                showWarning('⚠️ Sudah di surah terakhir yang tersedia');
            }
        } else {
            showWarning('⚠️ Pilih surah terlebih dahulu');
        }
    } catch (error) {
        console.error('Error in nextSurah:', error);
        showError('❌ Gagal pindah ke surah selanjutnya');
    }
}

// 4. FUNGSI OVERRIDE YANG AMAN - TIDAK PERLU OVERRIDE KARENA SUDAH JADI DEFAULT
function initPerSurahProgressSystemFixed() {
    try {
        console.log('Initializing Per-Surah Progress System (Fixed)...');
        
        // Setup scroll listener
        setupPerSurahProgressListener();
        
        // TIDAK PERLU OVERRIDE - loadSurah() sudah smart dengan progress confirmation
        console.log('loadSurah() is now smart - no override needed');
        
        // Reset progress bar
        maxReadingProgress = 0;
        currentSurahNumber = null;
        updateProgressBarDisplay();
        
        console.log('✅ Per-Surah Progress System (Fixed) initialized');
    } catch (error) {
        console.error('Error initializing per-surah progress system:', error);
    }
}

// 5. FUNGSI UPDATE EVENT LISTENERS - TIDAK PERLU KARENA SUDAH DEFAULT
function updateEventListenersForProgress() {
    try {
        console.log('Event listeners already use default loadSurah() - no update needed');
        console.log('✅ Event listeners are already correct');
    } catch (error) {
        console.error('Error updating event listeners:', error);
    }
}

// 6. FUNGSI UNTUK GO TO PROGRESS SURAH (UNTUK PANEL PROGRESS)
function goToProgressSurahFixed(surahNumber, progress) {
    try {
        const surahSelect = document.getElementById('surah');
        if (!surahSelect) return;
        
        // Tutup panel progress
        toggleProgressPanel();
        
        // Set surah di select
        surahSelect.value = surahNumber;
        
        // Set progress yang akan digunakan
        currentSurahNumber = surahNumber;
        maxReadingProgress = progress;
        
        // PERBAIKAN: Gunakan loadSurahDirect langsung tanpa confirmation
        loadSurahDirect();
        
        // Update currentSurah global
        currentSurah = surahNumber;
        
        // Update progress bar display
        setTimeout(() => {
            updateProgressBarDisplay();
            
            // Scroll ke posisi progress
            setTimeout(() => {
                scrollToProgressPosition(progress);
                safeShowSuccess(`📖 Membuka ${getSurahName(surahNumber)} di progress ${progress}%`);
            }, 1000);
        }, 500);
        
    } catch (error) {
        console.error('Error going to progress surah:', error);
        safeShowError('Gagal membuka surah');
    }
}

function updateNavigationButtons() {
    try {
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const surahSelect = document.getElementById('surah');
        
        if (!surahSelect) {
            console.error('Surah select not found for navigation update');
            return;
        }
        
        const selectedSurah = parseInt(surahSelect.value);
        console.log('Updating navigation for surah:', selectedSurah);

        if (selectedSurah && prevBtn && nextBtn) {
            // Dapatkan daftar surah yang tersedia
            const availableSurahs = Object.keys(quranData).map(Number).sort((a, b) => a - b);
            const currentIndex = availableSurahs.indexOf(selectedSurah);
            
            // Update previous button
            if (currentIndex > 0) {
                const prevSurahKey = availableSurahs[currentIndex - 1];
                if (quranData[prevSurahKey]) {
                    prevBtn.textContent = `← ${quranData[prevSurahKey].name}`;
                    prevBtn.disabled = false;
                    prevBtn.title = `Pindah ke ${quranData[prevSurahKey].name}`;
                }
            } else {
                prevBtn.textContent = '← Surah Pertama';
                prevBtn.disabled = true;
                prevBtn.title = 'Sudah di surah pertama';
            }

            // Update next button
            if (currentIndex < availableSurahs.length - 1) {
                const nextSurahKey = availableSurahs[currentIndex + 1];
                if (quranData[nextSurahKey]) {
                    nextBtn.textContent = `${quranData[nextSurahKey].name} →`;
                    nextBtn.disabled = false;
                    nextBtn.title = `Pindah ke ${quranData[nextSurahKey].name}`;
                }
            } else {
                nextBtn.textContent = 'Surah Terakhir →';
                nextBtn.disabled = true;
                nextBtn.title = 'Sudah di surah terakhir';
            }
        } else {
            // Reset buttons jika tidak ada surah yang dipilih
            if (prevBtn) {
                prevBtn.textContent = '← Surah Sebelumnya';
                prevBtn.disabled = true;
                prevBtn.title = 'Pilih surah terlebih dahulu';
            }
            if (nextBtn) {
                nextBtn.textContent = 'Surah Selanjutnya →';
                nextBtn.disabled = true;
                nextBtn.title = 'Pilih surah terlebih dahulu';
            }
        }
        
        console.log('Navigation buttons updated successfully');
    } catch (error) {
        console.error('Error updating navigation buttons:', error);
    }
}

// SETUP EVENT LISTENERS UNTUK NAVIGATION
function setupNavigationEventListeners() {
    try {
        console.log('Setting up navigation event listeners...');

        // Previous button
        const prevBtn = document.getElementById('prevBtn');
        if (prevBtn) {
            // Remove existing event listeners
            prevBtn.onclick = null;
            const newPrevBtn = prevBtn.cloneNode(true);
            prevBtn.parentNode.replaceChild(newPrevBtn, prevBtn);
            
            // Add new event listener
            newPrevBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Previous button clicked');
                previousSurah();
            });
            console.log('✅ Previous button event listener attached');
        } else {
            console.warn('Previous button not found');
        }

        // Next button
        const nextBtn = document.getElementById('nextBtn');
        if (nextBtn) {
            // Remove existing event listeners
            nextBtn.onclick = null;
            const newNextBtn = nextBtn.cloneNode(true);
            nextBtn.parentNode.replaceChild(newNextBtn, nextBtn);
            
            // Add new event listener
            newNextBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Next button clicked');
                nextSurah();
            });
            console.log('✅ Next button event listener attached');
        } else {
            console.warn('Next button not found');
        }

        // Surah selection change handler
        const surahSelect = document.getElementById('surah');
        if (surahSelect) {
            surahSelect.addEventListener('change', function() {
                console.log('Surah selection changed to:', this.value);
                updateNavigationButtons();
            });
            console.log('✅ Surah select change listener attached');
        } else {
            console.warn('Surah select not found');
        }
        
        console.log('✅ All navigation event listeners setup completed');
    } catch (error) {
        console.error('Error setting up navigation event listeners:', error);
    }
}

// Statistics and progress
function updateStatistics() {
    try {
        const surah = quranData[currentSurah];
        if (!surah) return;
        
        const totalVerses = Object.keys(surah.verses).length;
        const totalAyahsElement = document.getElementById('totalAyahs');
        
        if (totalAyahsElement) {
            totalAyahsElement.textContent = totalVerses;
        }
        
        // Reset progress saat load surah baru
        resetProgress();
        
        // Update progress setelah render selesai (delay lebih lama)
        setTimeout(() => {
            updateReadingProgress();
        }, 1200);
        
    } catch (error) {
        console.error('Error updating statistics:', error);
    }
}

// PERBAIKAN: Setup scroll handler yang lebih efisien
function setupScrollHandler() {
    let scrollTimeout;
    let isUpdating = false;
    
    function updateOnScroll() {
        if (isUpdating) return;
        isUpdating = true;
        
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollBtn = document.getElementById('scrollTopBtn');
        
        // Update scroll to top button (langsung tanpa delay)
        if (scrollBtn) {
            scrollBtn.style.display = scrollTop > 500 ? 'block' : 'none';
        }
        
        // Update reading progress (langsung)
        updateReadingProgressFast();
        
        isUpdating = false;
    }
    
    // Gunakan throttle yang lebih ringan
    window.addEventListener('scroll', () => {
        if (scrollTimeout) return;
        
        scrollTimeout = requestAnimationFrame(() => {
            updateOnScroll();
            scrollTimeout = null;
        });
    }, { passive: true });
    
    console.log('Optimized scroll handler setup');
}

// PERBAIKAN: Update progress yang lebih cepat tanpa delay
function updateReadingProgressFast() {
    try {
        const progressFill = document.getElementById('progressFill');
        const progressElement = document.getElementById('readingProgress');
        
        if (!progressFill || !progressElement) return;
        
        const ayahCards = document.querySelectorAll('.ayah-card');
        if (ayahCards.length === 0) {
            progressFill.style.width = '0%';
            progressElement.textContent = '0%';
            return;
        }
        
        const windowHeight = window.innerHeight;
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const viewportCenter = scrollTop + (windowHeight * 0.3); // Ubah dari 0.5 ke 0.3 untuk lebih responsif
        
        let readAyahs = 0;
        
        // Optimasi: hitung hanya yang visible
        ayahCards.forEach((card) => {
            const rect = card.getBoundingClientRect();
            if (rect.top + scrollTop < viewportCenter) {
                readAyahs++;
            }
        });
        
        const progress = Math.min(100, Math.max(0, Math.floor((readAyahs / ayahCards.length) * 100)));
        
        // Update langsung tanpa transisi untuk responsivitas
        progressFill.style.transition = 'none';
        progressFill.style.width = progress + '%';
        progressElement.textContent = progress + '%';
        
        // Restore transisi setelah update
        setTimeout(() => {
            progressFill.style.transition = 'width 0.1s ease';
        }, 0);
        
        // Update progress per surah jika diperlukan
        if (currentSurahNumber && progress > maxReadingProgress) {
            maxReadingProgress = progress;
            // Silent save tanpa blocking
            setTimeout(() => {
                saveProgressForSurah(currentSurahNumber, maxReadingProgress);
            }, 0);
        }
        
    } catch (error) {
        console.error('Error in fast progress update:', error);
    }
}

function updateReadingProgress() {
    try {
        const progressFill = document.getElementById('progressFill');
        const progressElement = document.getElementById('readingProgress');
        
        if (!progressFill || !progressElement) {
            console.log('Progress elements not found');
            return;
        }
        
        // Ambil semua ayah cards yang ada di halaman
        const ayahCards = document.querySelectorAll('.ayah-card');
        if (ayahCards.length === 0) {
            progressFill.style.width = '0%';
            progressElement.textContent = '0%';
            return;
        }
        
        const windowHeight = window.innerHeight;
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const viewportCenter = scrollTop + (windowHeight / 2);
        
        let readAyahs = 0;
        const totalAyahs = ayahCards.length;
        
        // Hitung ayah yang sudah terbaca (melewati tengah viewport)
        ayahCards.forEach((card) => {
            const rect = card.getBoundingClientRect();
            const cardTop = rect.top + scrollTop;
            
            // Ayah dianggap terbaca jika sudah melewati tengah viewport
            if (cardTop < viewportCenter) {
                readAyahs++;
            }
        });
        
        // Hitung persentase
        const progress = Math.min(100, Math.max(0, Math.floor((readAyahs / totalAyahs) * 100)));
        
        // Update UI dengan animasi smooth
        progressFill.style.width = progress + '%';
        progressElement.textContent = progress + '%';
        
        // Debug info
        console.log(`Progress Update: ${progress}% (${readAyahs}/${totalAyahs} ayat)`);
        
    } catch (error) {
        console.error('Error updating reading progress:', error);
    }
}

function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

// Close all panels
function closeAllPanels() {
    try {
        const panels = [
            'settingsPanel',
            'searchContainer',
            'bookmarksPanel',
            'progressPanel',
            'overlay'
        ];
        
        panels.forEach(panelId => {
            const panel = document.getElementById(panelId);
            if (panel) {
                if (panelId === 'bookmarksPanel' || panelId === 'progressPanel') {
                    panel.classList.remove('open');
                } else {
                    panel.classList.remove('show');
                }
            }
        });

        // Also hide search history
        const searchHistory = document.getElementById('searchHistory');
        if (searchHistory) {
            searchHistory.classList.remove('show');
        }
    } catch (error) {
        console.error('Error closing panels:', error);
    }
}

// Error handling for missing elements
function safeGetElement(id) {
    const element = document.getElementById(id);
    if (!element) {
        console.warn(`Element with id '${id}' not found`);
    }
    return element;
}

// Initialize error handlers
window.addEventListener('error', function(event) {
    console.error('Global error:', event.error);
    showNotification('Terjadi kesalahan pada aplikasi');
});

window.addEventListener('unhandledrejection', function(event) {
    console.error('Unhandled promise rejection:', event.reason);
    showNotification('Terjadi kesalahan jaringan');
});

// Responsive handling
function handleResize() {
    // Adjust panels for mobile
    const settingsPanel = document.getElementById('settingsPanel');
    const bookmarksPanel = document.getElementById('bookmarksPanel');
    
    if (window.innerWidth <= 768) {
        if (settingsPanel) {
            settingsPanel.style.width = '65vw';
            settingsPanel.style.right = '13vw';
        }
        if (bookmarksPanel) {
            bookmarksPanel.style.width = '41vw';
        }
    } else {
        if (settingsPanel) {
            settingsPanel.style.width = '400px';
            settingsPanel.style.right = '20px';
        }
        if (bookmarksPanel) {
            bookmarksPanel.style.width = '400px';
        }
    }
}

window.addEventListener('resize', handleResize);

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + F for search
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        toggleSearch();
    }
    
    // Escape to close panels
    if (e.key === 'Escape') {
        closeAllPanels();
    }
    
    // Arrow keys for navigation (when not in input fields)
    if (!e.target.matches('input, textarea, select')) {
        if (e.key === 'ArrowLeft') {
            previousSurah();
        } else if (e.key === 'ArrowRight') {
            nextSurah();
        }
    }
    
    // Space for play/pause audio (when not in input fields)
    if (e.key === ' ' && !e.target.matches('input, textarea, select')) {
        e.preventDefault();
        if (currentAudio && !currentAudio.paused) {
            pauseAudio();
        } else if (currentSurah) {
            playAudio();
        }
    }
});

// TAMBAHKAN CSS untuk Modern Audio Player
function addAudioPlayerStyles() {
    const style = document.createElement('style');
    style.innerHTML = `
        /* Modern Audio Player Styles */
        .modern-audio-player {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 10000;
            box-shadow: 0 2px 20px rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
        }

        .modern-audio-player.show {
            display: flex;
            animation: slideDownPlayer 0.3s ease;
        }

        @keyframes slideDownPlayer {
            from {
                opacity: 0;
                transform: translateY(-100%);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .audio-player-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .audio-player-info {
            flex: 1;
            min-width: 0;
        }

        .audio-player-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .audio-player-subtitle {
            font-size: 12px;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .audio-player-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .audio-control-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .audio-control-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .audio-control-btn.play-pause {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.9);
            color: #667eea;
            font-size: 18px;
        }

        .audio-control-btn.play-pause:hover {
            background: white;
            transform: scale(1.05);
        }

        .speed-control {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .speed-control:hover {
            background: rgba(255,255,255,0.3);
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
        }

        .volume-slider {
            width: 100px;
            height: 8px; /* Lebih tebal untuk garis putih yang jelas */
            background: rgba(255,255,255,0.8); /* Background putih lebih terang */
            border-radius: 4px;
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            border: 1px solid rgba(255,255,255,0.9); /* Border putih */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); /* Shadow dalam untuk efek 3D */
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: white;
            border: 2px solid #667eea; /* Border biru */
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }

        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            border-color: #764ba2;
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
        }

        .volume-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .volume-slider::-moz-range-track {
            height: 8px;
            background: rgba(255,255,255,0.8);
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.9);
        }

        .volume-slider::-ms-thumb {
            width: 18px;
            height: 18px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 50%;
            cursor: pointer;
        }

        .volume-slider::-ms-track {
            height: 8px;
            background: rgba(255,255,255,0.8);
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.9);
            color: transparent;
        }

        /* Efek saat slider aktif/fokus */
        .volume-slider:focus {
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2), 
                        0 0 8px rgba(102, 126, 234, 0.5);
        }

        /* Desktop - slider lebih panjang */
        @media (min-width: 1024px) {
            .volume-container {
                min-width: 160px;
            }
            
            .volume-slider {
                width: 120px;
            }
        }

        /* Mobile - sembunyikan */
        @media (max-width: 768px) {
            .volume-container {
                display: none;
            }
        }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .time-display {
            font-size: 11px;
            opacity: 0.9;
            white-space: nowrap;
        }

        .close-player {
            width: 28px;
            height: 28px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .close-player:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .modern-audio-player {
                padding: 10px 15px;
                gap: 10px;
            }

            .audio-player-icon {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }

            .audio-player-title {
                font-size: 13px;
            }

            .audio-player-subtitle {
                font-size: 11px;
            }

            .audio-control-btn {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }

            .audio-control-btn.play-pause {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }

            .volume-container {
                display: none;
            }

            .progress-container {
                min-width: 80px;
            }

            .speed-control {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .modern-audio-player {
                padding: 8px 12px;
                gap: 8px;
            }

            .progress-container {
                min-width: 60px;
            }

            .time-display {
                font-size: 10px;
            }
        }
    `;
    document.head.appendChild(style);
}

// TAMBAHKAN HTML Audio Player ke body
function createAudioPlayer() {
    const playerHTML = `
        <div class="modern-audio-player" id="modernAudioPlayer">
            <div class="audio-player-icon">
                📖
            </div>
            
            <div class="audio-player-info">
                <div class="audio-player-title" id="audioPlayerTitle">Putar Surah</div>
                <div class="audio-player-subtitle" id="audioPlayerSubtitle">Al-Fatihah - 1/7</div>
            </div>
            
            <div class="audio-player-controls">
                <button class="audio-control-btn" onclick="seekBackward()" title="Mundur 10 detik">
                    ⏪
                </button>
                
                <button class="audio-control-btn play-pause" onclick="togglePlayPause()" id="playPauseBtn" title="Play/Pause">
                    ▶️
                </button>
                
                <button class="audio-control-btn" onclick="seekForward()" title="Maju 10 detik">
                    ⏩
                </button>
                
                <button class="speed-control" onclick="togglePlaybackSpeed()" id="speedControl" title="Kecepatan Putar">
                    1.0x
                </button>
            </div>
            
            <div class="volume-container">
                <button class="audio-control-btn" onclick="toggleMute()" id="muteBtn" title="Mute/Unmute">
                    🔊
                </button>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.1" value="1">
            </div>
            
            <div class="progress-container">
                <div class="progress-bar" onclick="seekToPosition(event)" id="audioProgressBar">
                    <div class="progress-fill" id="audioProgressFill"></div>
                </div>
                <div class="time-display" id="timeDisplay">0:00/0:00</div>
            </div>
            
            <button class="close-player" onclick="closeAudioPlayer()" title="Tutup Player">
                ✕
            </button>
        </div>
    `;
    
    document.body.insertAdjacentHTML('afterbegin', playerHTML);
}

// FUNGSI KONTROL AUDIO PLAYER
function showAudioPlayer() {
    const player = document.getElementById('modernAudioPlayer');
    if (player) {
        player.classList.add('show');
        audioPlayer.isVisible = true;
        
        // Push down main content
        const container = document.querySelector('.container');
        if (container) {
            container.style.marginTop = '70px';
            container.style.transition = 'margin-top 0.3s ease';
        }
    }
}

function closeAudioPlayer() {
    const player = document.getElementById('modernAudioPlayer');
    if (player) {
        player.classList.remove('show');
        audioPlayer.isVisible = false;
        
        // Reset main content position
        const container = document.querySelector('.container');
        if (container) {
            container.style.marginTop = '0';
        }
        
        // Stop current audio
        if (currentAudio) {
            currentAudio.pause();
            currentAudio = null;
            autoPlayQueue = [];
            currentAutoIndex = 0;
        }
    }
}

function togglePlayPause() {
    const btn = document.getElementById('playPauseBtn');
    
    if (!currentAudio) {
        // Start new audio if none playing
        if (currentSurah && quranData[currentSurah]) {
            playAudio();
        } else {
            showError('Silakan pilih surah terlebih dahulu');
        }
        return;
    }
    
    if (currentAudio.paused) {
        currentAudio.play();
        btn.textContent = '⏸️';
    } else {
        currentAudio.pause();
        btn.textContent = '▶️';
    }
}

function seekBackward() {
    if (currentAudio) {
        currentAudio.currentTime = Math.max(0, currentAudio.currentTime - 10);
    }
}

function seekForward() {
    if (currentAudio) {
        currentAudio.currentTime = Math.min(currentAudio.duration || 0, currentAudio.currentTime + 10);
    }
}

function togglePlaybackSpeed() {
    audioPlayer.speedIndex = (audioPlayer.speedIndex + 1) % audioPlayer.speeds.length;
    audioPlayer.currentSpeed = audioPlayer.speeds[audioPlayer.speedIndex];
    
    const speedBtn = document.getElementById('speedControl');
    speedBtn.textContent = audioPlayer.currentSpeed + 'x';
    
    if (currentAudio) {
        currentAudio.playbackRate = audioPlayer.currentSpeed;
    }
}

function toggleMute() {
    const muteBtn = document.getElementById('muteBtn');
    const volumeSlider = document.getElementById('volumeSlider');
    
    if (!muteBtn || !volumeSlider) return;
    
    audioPlayer.isMuted = !audioPlayer.isMuted;
    
    if (audioPlayer.isMuted) {
        // Mute: simpan volume saat ini dan set ke 0
        audioPlayer.volume = audioPlayer.volume > 0 ? audioPlayer.volume : 1.0;
        muteBtn.textContent = '🔇';
        volumeSlider.value = 0;
        if (currentAudio) currentAudio.volume = 0;
    } else {
        // Unmute: kembalikan ke volume sebelumnya
        muteBtn.textContent = '🔊';
        volumeSlider.value = audioPlayer.volume;
        if (currentAudio) currentAudio.volume = audioPlayer.volume;
    }
    
    console.log('Mute toggled:', audioPlayer.isMuted, 'Volume:', audioPlayer.volume);
}

function seekToPosition(event) {
    if (!currentAudio || !currentAudio.duration) return;
    
    const progressBar = event.currentTarget;
    const rect = progressBar.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const percentage = clickX / rect.width;
    
    currentAudio.currentTime = currentAudio.duration * percentage;
}

function updateAudioProgress() {
    if (!currentAudio) return;
    
    const progressFill = document.getElementById('audioProgressFill');
    const timeDisplay = document.getElementById('timeDisplay');
    
    if (currentAudio.duration) {
        const progress = (currentAudio.currentTime / currentAudio.duration) * 100;
        progressFill.style.width = progress + '%';
        
        const currentTime = formatTime(currentAudio.currentTime);
        const totalTime = formatTime(currentAudio.duration);
        timeDisplay.textContent = `${currentTime}/${totalTime}`;
    }
}

function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function updatePlayerInfo(surahName, currentVerse, totalVerses) {
    const title = document.getElementById('audioPlayerTitle');
    const subtitle = document.getElementById('audioPlayerSubtitle');
    
    if (title) title.textContent = `Putar Surah`;
    if (subtitle) subtitle.textContent = `${surahName} - ${currentVerse}/${totalVerses}`;
}



// Performance optimization: Lazy loading for long surahs
function createIntersectionObserver() {
    if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, {
            threshold: 0.1,
            rootMargin: '50px'
        });

        // Observe ayah cards when they're created
        document.querySelectorAll('.ayah-card').forEach(card => {
            observer.observe(card);
        });
    }
}

// Service Worker registration for offline functionality (optional)
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        // Uncomment to enable service worker
        // navigator.serviceWorker.register('/sw.js')
        //   .then(registration => console.log('SW registered'))
        //   .catch(error => console.log('SW registration failed'));
    });
}

// Initialize app when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        console.log('App initialized');
        handleResize(); // Initial responsive setup
    });
} else {
    console.log('App initialized');
    handleResize(); // Initial responsive setup
}

// Debugging helper
window.QuranApp = {
    currentSurah,
    currentSettings,
    bookmarks,
    searchHistory,
    searchResults,
    showError,
    showNotification,
    loadSurah,
    toggleTheme,
    version: '2.0.0'
};

console.log('Progress Bar System v2.0 loaded successfully!');

function getAudioUrl(surah, ayah) {
    return `https://verses.quran.com/AbdulBaset/Mujawwad/mp3/${String(surah).padStart(3, '0')}${String(ayah).padStart(3, '0')}.mp3`;
}

function updateAudioStatus(surahNumber) {
    const statusEl = document.getElementById('audioStatus');
    if (!statusEl) return;

    if (!surahNumber || !quranData[surahNumber]) {
        statusEl.textContent = '🔇 Tidak ada audio yang tersedia';
        return;
    }

    const surah = quranData[surahNumber];
    statusEl.textContent = `🔊 Audio tersedia untuk ${surah.name}`;
}

// 4. PERBAIKAN: Fungsi copyVerse yang hilang
function copyVerse(surahNum, verseNum) {
    try {
        const verse = quranData[surahNum].verses[verseNum];
        const surah = quranData[surahNum];
        const text = `${surah.name} - Ayat ${verseNum}\n\n${verse.arabic}\n\n${verse.transliteration}\n\n${verse.translation}`;
        
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                showSuccess('Ayat berhasil disalin!');
            }).catch(() => {
                fallbackCopyText(text);
            });
        } else {
            fallbackCopyText(text);
        }
    } catch (error) {
        console.error('Error copying verse:', error);
        showError('Gagal menyalin ayat');
    }
}

// 5. PERBAIKAN: Fungsi setLanguage dan toggleAllFootnotes yang hilang
function setLanguage(lang) {
    currentSettings.language = lang;
    
    // Update active button
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    const activeBtn = document.querySelector(`[onclick="setLanguage('${lang}')"]`);
    if (activeBtn) activeBtn.classList.add('active');
    
    saveSettings();
    showSuccess(`Bahasa diubah ke ${lang.toUpperCase()}`);
}

function toggleAllFootnotes() {
    currentSettings.showFootnotes = !currentSettings.showFootnotes;
    const toggle = document.getElementById('footnotesToggle');
    if (toggle) toggle.classList.toggle('active');
    
    document.querySelectorAll('.footnote-section').forEach(el => {
        el.style.display = currentSettings.showFootnotes ? 'block' : 'none';
    });
    
    saveSettings();
}

function toggleAllTafsir() {
    currentSettings.showTafsir = !currentSettings.showTafsir;
    const toggle = document.getElementById('tafsirToggle');
    if (toggle) toggle.classList.toggle('active');
    
    document.querySelectorAll('.tafsir-section').forEach(el => {
        el.style.display = currentSettings.showTafsir ? 'block' : 'none';
    });
    
    saveSettings();
}

// ===== SISTEM PROGRESS PER SURAH =====

// CSS untuk modal progress per surah
// Fungsi untuk menampilkan notifikasi (fallback jika showSuccess tidak ada)
function safeShowSuccess(message) {
    try {
        if (typeof showSuccess === 'function') {
            showSuccess(message);
        } else if (typeof showNotification === 'function') {
            showNotification(message, 'success');
        } else {
            console.log('SUCCESS:', message);
        }
    } catch (error) {
        console.log('SUCCESS (fallback):', message);
    }
}

function safeShowError(message) {
    try {
        if (typeof showError === 'function') {
            showError(message);
        } else if (typeof showNotification === 'function') {
            showNotification(message, 'error');
        } else {
            console.error('ERROR:', message);
        }
    } catch (error) {
        console.error('ERROR (fallback):', message);
    }
}


// Load progress surah dari localStorage
function loadProgressForSurah(surahNumber) {
    try {
        if (!surahNumber) return 0;
        
        const progressData = JSON.parse(localStorage.getItem('quranSurahProgress') || '{}');
        if (progressData[surahNumber]) {
            return progressData[surahNumber].progress || 0;
        }
        return 0;
    } catch (error) {
        console.error('Error loading progress:', error);
        return 0;
    }
}

// Hapus progress surah dari localStorage
function deleteProgressForSurah(surahNumber) {
    try {
        if (!surahNumber) return;
        
        const progressData = JSON.parse(localStorage.getItem('quranSurahProgress') || '{}');
        delete progressData[surahNumber];
        localStorage.setItem('quranSurahProgress', JSON.stringify(progressData));
        console.log(`Progress deleted for surah ${surahNumber}`);
    } catch (error) {
        console.error('Error deleting progress:', error);
    }
}

// Cek apakah surah memiliki progress tersimpan
function hasSavedProgress(surahNumber) {
    try {
        if (!surahNumber) return false;
        
        const progressData = JSON.parse(localStorage.getItem('quranSurahProgress') || '{}');
        return progressData[surahNumber] && progressData[surahNumber].progress > 0;
    } catch (error) {
        return false;
    }
}

function getSurahName(surahNumber) {
    try {
        // Gunakan quranData yang sudah diperbaiki sebagai object
        if (quranData[surahNumber]) {
            return quranData[surahNumber].name;
        }
        
        // Fallback dari select option
        const surahSelect = document.getElementById('surah');
        if (surahSelect) {
            const option = surahSelect.querySelector(`option[value="${surahNumber}"]`);
            if (option) {
                const optionText = option.textContent;
                const match = optionText.match(/^\d+\.\s*([^(]+)/);
                if (match) {
                    return match[1].trim();
                }
            }
        }
        
        return `Surah ${surahNumber}`;
    } catch (error) {
        console.error('Error getting surah name:', error);
        return `Surah ${surahNumber}`;
    }
}

// UPDATE: Modal konfirmasi untuk menyimpan/menghapus progress saat pindah surah
function showSaveProgressModal(previousSurahNumber, previousProgress, callback) {
    try {
        // Hapus modal lama jika ada
        const existingModal = document.getElementById('progressModalV2');
        if (existingModal) existingModal.remove();

        const previousSurahName = getSurahName(previousSurahNumber);
        
        const modalHTML = `
            <div class="progress-modal-overlay-v2" id="progressModalV2">
                <div class="progress-modal-v2">
                    <h3>💾 Simpan Progress Baca?</h3>
                    
                    <div class="progress-info-v2">
                        <h4>Progress Baca ${previousSurahName}</h4>
                        <div class="progress-bar-preview-v2">
                            <div class="progress-fill-preview-v2" style="width: ${previousProgress}%"></div>
                        </div>
                        <div class="progress-text-v2">Progress saat ini: ${previousProgress}%</div>
                    </div>
                    
                    <p>Apakah Anda ingin <strong>menyimpan</strong> atau <strong>menghapus</strong> progress baca <strong>${previousSurahName}</strong>?</p>
                    
                    <div class="progress-modal-buttons-v2">
                        <button class="progress-modal-btn-v2 save" onclick="confirmSaveProgressV2(${previousSurahNumber}, ${previousProgress}, true)">
                            💾 Simpan
                        </button>
                        <button class="progress-modal-btn-v2 delete" onclick="confirmSaveProgressV2(${previousSurahNumber}, ${previousProgress}, false)">
                            🗑️ Hapus
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = modalHTML;
        document.body.appendChild(tempDiv.firstElementChild);
        
        // Store callback
        window.saveProgressCallbackV2 = callback;
        
    } catch (error) {
        console.error('Error showing save progress modal:', error);
        if (callback) callback();
    }
}

// UPDATE: Modal konfirmasi untuk melanjutkan atau memulai dari awal
function showContinueProgressModal(surahNumber, savedProgress, callback) {
    try {
        // Hapus modal lama jika ada
        const existingModal = document.getElementById('progressModalV2');
        if (existingModal) existingModal.remove();

        const surahName = getSurahName(surahNumber);
        
        // Hitung total ayat dan ayat terakhir yang dibaca
        let totalVerses = 0;
        let lastVerseRead = 0;
        
        try {
            if (typeof quranData !== 'undefined' && quranData(surahNumber)) {
                totalVerses = Object.keys(quranData(surahNumber).verses).length;
            } else if (window.quranData && window.quranData(surahNumber)) {
                totalVerses = Object.keys(window.quranData(surahNumber).verses).length;
            }
            
            if (totalVerses > 0) {
                lastVerseRead = Math.ceil((savedProgress / 100) * totalVerses);
            }
        } catch (error) {
            console.error('Error calculating verses:', error);
        }
        
        const modalHTML = `
            <div class="progress-modal-overlay-v2" id="progressModalV2">
                <div class="progress-modal-v2">
                    <h3>📖 Lanjutkan Membaca?</h3>
                    
                    <div class="progress-info-v2">
                        <h4>Progress Tersimpan ${surahName}</h4>
                        <div class="progress-bar-preview-v2">
                            <div class="progress-fill-preview-v2" style="width: ${savedProgress}%"></div>
                        </div>
                        <div class="progress-text-v2">Progress tersimpan: ${savedProgress}% ${totalVerses > 0 ? `(sekitar ayat ${lastVerseRead} dari ${totalVerses})` : ''}</div>
                    </div>
                    
                    <p>Apakah Anda ingin <strong>melanjutkan membaca</strong> dari progress terakhir atau <strong>memulai dari awal</strong>?</p>
                    
                    <div class="progress-modal-buttons-v2">
                        <button class="progress-modal-btn-v2 continue" onclick="confirmContinueProgressV2(${surahNumber}, ${savedProgress}, true)">
                            📖 Lanjutkan
                        </button>
                        <button class="progress-modal-btn-v2 restart" onclick="confirmContinueProgressV2(${surahNumber}, ${savedProgress}, false)">
                            🔄 Mulai Awal
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = modalHTML;
        document.body.appendChild(tempDiv.firstElementChild);
        
        // Store callback
        window.continueProgressCallbackV2 = callback;
        
    } catch (error) {
        console.error('Error showing continue progress modal:', error);
        if (callback) callback();
    }
}

// UPDATE: Simpan progress surah ke localStorage dengan nama yang benar
function saveProgressForSurah(surahNumber, progress) {
    try {
        if (!surahNumber || progress < 0) return;
        
        const progressData = JSON.parse(localStorage.getItem('quranSurahProgress') || '{}');
        progressData[surahNumber] = {
            progress: progress,
            lastRead: new Date().toISOString(),
            surahName: getSurahName(surahNumber)
        };
        localStorage.setItem('quranSurahProgress', JSON.stringify(progressData));
        console.log(`Progress saved for ${getSurahName(surahNumber)}: ${progress}%`);
    } catch (error) {
        console.error('Error saving progress:', error);
    }
}

// UPDATE: Handle konfirmasi save/delete progress
function confirmSaveProgressV2(surahNumber, progress, shouldSave) {
    try {
        const modal = document.getElementById('progressModalV2');
        const surahName = getSurahName(surahNumber);
        
        if (shouldSave) {
            saveProgressForSurah(surahNumber, progress);
            safeShowSuccess(`✅ Progress ${surahName} (${progress}%) disimpan`);
        } else {
            deleteProgressForSurah(surahNumber);
            safeShowSuccess(`🗑️ Progress ${surahName} dihapus`);
        }
        
        // Tutup modal
        if (modal) modal.remove();
        
        // Jalankan callback
        if (window.saveProgressCallbackV2) {
            window.saveProgressCallbackV2();
            window.saveProgressCallbackV2 = null;
        }
    } catch (error) {
        console.error('Error confirming save progress:', error);
    }
}

// UPDATE: Handle konfirmasi continue/restart progress
function confirmContinueProgressV2(surahNumber, savedProgress, shouldContinue) {
    try {
        const modal = document.getElementById('progressModalV2');
        const surahName = getSurahName(surahNumber);
        
        if (shouldContinue) {
            // Lanjutkan dari progress tersimpan
            maxReadingProgress = savedProgress;
            updateProgressBarDisplay();
            safeShowSuccess(`📖 Melanjutkan ${surahName} dari ${savedProgress}%`);
            
            // Scroll ke posisi yang sesuai dengan progress
            setTimeout(() => {
                scrollToProgressPosition(savedProgress);
            }, 1000);
        } else {
            // Mulai dari awal - reset progress
            deleteProgressForSurah(surahNumber);
            maxReadingProgress = 0;
            updateProgressBarDisplay();
            safeShowSuccess(`🔄 Memulai ${surahName} dari awal`);
            
            // Scroll ke atas
            setTimeout(() => {
                if (typeof scrollToTop === 'function') {
                    scrollToTop();
                } else {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }, 500);
        }
        
        // Tutup modal
        if (modal) modal.remove();
        
        // Jalankan callback
        if (window.continueProgressCallbackV2) {
            window.continueProgressCallbackV2();
            window.continueProgressCallbackV2 = null;
        }
    } catch (error) {
        console.error('Error confirming continue progress:', error);
    }
}

// PERBAIKAN: Scroll ke posisi tanpa delay berlebihan
function scrollToProgressPosition(progress) {
    try {
        const ayahCards = document.querySelectorAll('.ayah-card');
        if (ayahCards.length === 0) return;
        
        const targetIndex = Math.floor((progress / 100) * ayahCards.length);
        const targetCard = ayahCards[Math.min(targetIndex, ayahCards.length - 1)];
        
        if (targetCard) {
            // Scroll langsung tanpa delay
            targetCard.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            
            // Highlight tanpa delay
            targetCard.classList.add('highlight');
            setTimeout(() => {
                targetCard.classList.remove('highlight');
            }, 2000); // Kurangi dari 3000 ke 2000
        }
    } catch (error) {
        console.error('Error scrolling to progress position:', error);
    }
}

// Update tampilan progress bar
function updateProgressBarDisplay() {
    try {
        const progressFill = document.getElementById('progressFill');
        const progressElement = document.getElementById('readingProgress');
        
        if (progressFill) progressFill.style.width = maxReadingProgress + '%';
        if (progressElement) progressElement.textContent = maxReadingProgress + '%';
    } catch (error) {
        console.error('Error updating progress bar display:', error);
    }
}

// Update progress berdasarkan scroll (hanya bisa naik)
function updateReadingProgressPerSurah() {
    try {
        if (!currentSurahNumber) return;
        
        const ayahCards = document.querySelectorAll('.ayah-card');
        if (ayahCards.length === 0) return;
        
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const viewportMiddle = scrollTop + (windowHeight / 2);
        
        let currentReadCount = 0;
        const totalCount = ayahCards.length;
        
        // Hitung ayah yang sudah terbaca
        ayahCards.forEach((card) => {
            const rect = card.getBoundingClientRect();
            const cardTop = rect.top + scrollTop;
            
            if (cardTop < viewportMiddle) {
                currentReadCount++;
            }
        });
        
        const currentProgress = Math.floor((currentReadCount / totalCount) * 100);
        
        // Progress hanya bisa naik
        if (currentProgress > maxReadingProgress) {
            maxReadingProgress = currentProgress;
            updateProgressBarDisplay();
            
            // Auto save progress (silent save)
            saveProgressForSurah(currentSurahNumber, maxReadingProgress);
        }
    } catch (error) {
        console.error('Error updating reading progress per surah:', error);
    }
}

// Setup scroll listener untuk progress per surah
function setupPerSurahProgressListener() {
    try {
        let isScrolling = false;
        
        function handleScroll() {
            if (isScrolling) return;
            
            isScrolling = true;
            
            requestAnimationFrame(() => {
                updateReadingProgressPerSurah();
                isScrolling = false;
            });
        }
        
        // Remove existing listener
        window.removeEventListener('scroll', handleScroll);
        // Add new listener
        window.addEventListener('scroll', handleScroll, { passive: true });
        
        console.log('Per-surah progress integrated with main scroll handler');
    } catch (error) {
        console.error('Error setting up scroll listener:', error);
    }
}

// Override loadSurah dengan konfirmasi progress
function loadSurahWithProgressConfirm() {
    try {
        const surahSelect = document.getElementById('surah');
        if (!surahSelect) {
            showError('Surah select not found');
            return;
        }
        
        const newSurahNumber = parseInt(surahSelect.value);
        
        if (!newSurahNumber || isNaN(newSurahNumber)) {
            showError('Silakan pilih surah terlebih dahulu');
            return;
        }
        
        // Fungsi untuk melanjutkan load surah baru
        const proceedToNewSurah = () => {
            currentSurahNumber = newSurahNumber;
            
            // Cek apakah surah baru memiliki progress tersimpan
            if (hasSavedProgress(newSurahNumber)) {
                const savedProgress = loadProgressForSurah(newSurahNumber);
                
                // Tampilkan modal konfirmasi untuk melanjutkan atau mulai dari awal
                showContinueProgressModal(newSurahNumber, savedProgress, () => {
                    // Load surah setelah konfirmasi - gunakan loadSurah biasa
                    loadSurah();
                    
                    // Update currentSurah global variable
                    currentSurah = newSurahNumber;
                });
            } else {
                // Surah baru, mulai dari 0%
                maxReadingProgress = 0;
                updateProgressBarDisplay();
                
                loadSurah();
                currentSurah = newSurahNumber;
            }
        };
        
        // Jika ada surah sebelumnya dengan progress > 0, tanya save/delete
        if (currentSurahNumber && currentSurahNumber !== newSurahNumber && maxReadingProgress > 0) {
            showSaveProgressModal(currentSurahNumber, maxReadingProgress, proceedToNewSurah);
        } else {
            // Langsung ke surah baru
            proceedToNewSurah();
        }
    } catch (error) {
        console.error('Error in loadSurahWithProgressConfirm:', error);
        showError('Terjadi kesalahan saat memuat surah');
    }
}

// Override navigation functions  
function previousSurahWithProgressConfirm() {
    try {
        const surahSelect = document.getElementById('surah');
        if (!surahSelect) return;
        
        const currentValue = parseInt(surahSelect.value);
        
        if (currentValue && currentValue > 1) {
            const availableSurahs = Object.keys(quranData).map(Number).sort((a, b) => a - b);
            const currentIndex = availableSurahs.indexOf(currentValue);
            
            if (currentIndex > 0) {
                const prevSurah = availableSurahs[currentIndex - 1];
                
                // Fungsi untuk pindah ke surah sebelumnya
                const proceedToPrevSurah = () => {
                    surahSelect.value = prevSurah;
                    updateNavigationButtons();
                    
                    // Load surah dengan konfirmasi progress
                    if (typeof loadSurahWithProgressConfirm === 'function') {
                        loadSurahWithProgressConfirm();
                    } else if (typeof loadSurah === 'function') {
                        loadSurah();
                    } else {
                        loadSurahNormal();
                    }
                };
                
                // Jika ada progress pada surah saat ini, tanya save/delete
                if (currentSurahNumber && maxReadingProgress > 0) {
                    showSaveProgressModal(currentSurahNumber, maxReadingProgress, proceedToPrevSurah);
                } else {
                    proceedToPrevSurah();
                }
            } else {
                showWarning('⚠️ Sudah di surah pertama yang tersedia');
            }
        } else {
            showWarning('⚠️ Pilih surah terlebih dahulu');
        }
    } catch (error) {
        console.error('Error in previousSurahWithProgressConfirm:', error);
        showError('❌ Gagal pindah ke surah sebelumnya');
    }
}

function nextSurahWithProgressConfirm() {
    try {
        const surahSelect = document.getElementById('surah');
        if (!surahSelect) return;
        
        const currentValue = parseInt(surahSelect.value);
        
        if (currentValue) {
            const availableSurahs = Object.keys(quranData).map(Number).sort((a, b) => a - b);
            const currentIndex = availableSurahs.indexOf(currentValue);
            
            if (currentIndex < availableSurahs.length - 1) {
                const nextSurahNum = availableSurahs[currentIndex + 1];
                
                // Fungsi untuk pindah ke surah selanjutnya
                const proceedToNextSurah = () => {
                    surahSelect.value = nextSurahNum;
                    updateNavigationButtons();
                    
                    // Load surah dengan konfirmasi progress
                    if (typeof loadSurahWithProgressConfirm === 'function') {
                        loadSurahWithProgressConfirm();
                    } else if (typeof loadSurah === 'function') {
                        loadSurah();
                    } else {
                        loadSurahNormal();
                    }
                };
                
                // Jika ada progress pada surah saat ini, tanya save/delete
                if (currentSurahNumber && maxReadingProgress > 0) {
                    showSaveProgressModal(currentSurahNumber, maxReadingProgress, proceedToNextSurah);
                } else {
                    proceedToNextSurah();
                }
            } else {
                showWarning('⚠️ Sudah di surah terakhir yang tersedia');
            }
        } else {
            showWarning('⚠️ Pilih surah terlebih dahulu');
        }
    } catch (error) {
        console.error('Error in nextSurahWithProgressConfirm:', error);
        showError('❌ Gagal pindah ke surah selanjutnya');
    }
}

// Inisialisasi sistem progress per surah
function initPerSurahProgressSystem() {
    try {
        console.log('Initializing Per-Surah Progress System...');
        
        // Setup scroll listener
        setupPerSurahProgressListener();
        
        // Override functions setelah delay yang cukup
        setTimeout(() => {
            try {
                // Backup dan override loadSurah
                if (typeof loadSurah === 'function') {
                    window.originalLoadSurah = loadSurah;
                    window.loadSurah = loadSurahWithProgressConfirm;
                    console.log('loadSurah function overridden');
                } else {
                    // Jika loadSurah belum ada, buat yang baru
                    window.loadSurah = loadSurahWithProgressConfirm;
                    console.log('loadSurah function created');
                }
                
                // Backup dan override navigation functions
                if (typeof previousSurah === 'function') {
                    window.originalPreviousSurah = previousSurah;
                    window.previousSurah = previousSurahWithProgressConfirm;
                    console.log('previousSurah function overridden');
                }
                
                if (typeof nextSurah === 'function') {
                    window.originalNextSurah = nextSurah;
                    window.nextSurah = nextSurahWithProgressConfirm;
                    console.log('nextSurah function overridden');
                }
                
            } catch (error) {
                console.error('Error overriding functions:', error);
            }
        }, 2000); // Naikkan delay ke 2000ms
        
        // Reset progress bar
        maxReadingProgress = 0;
        currentSurahNumber = null;
        updateProgressBarDisplay();
        
        console.log('✅ Per-Surah Progress System initialized');
    } catch (error) {
        console.error('Error initializing per-surah progress system:', error);
    }
}

// Expose functions untuk debugging
window.PerSurahProgressV2 = {
    save: saveProgressForSurah,
    load: loadProgressForSurah,
    delete: deleteProgressForSurah,
    hasSaved: hasSavedProgress,
    current: () => ({ surah: currentSurahNumber, progress: maxReadingProgress }),
    init: initPerSurahProgressSystem
};

// Expose global functions untuk modal callbacks
window.confirmSaveProgressV2 = confirmSaveProgressV2;
window.confirmContinueProgressV2 = confirmContinueProgressV2;

// Auto init when DOM ready dengan multiple fallbacks
(function() {
    function tryInitFixed() {
        if (document.body && document.head) {
            initPerSurahProgressSystemFixed();
            return true;
        }
        return false;
    }
    
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        if (!tryInitFixed()) {
            setTimeout(tryInitFixed, 500);
        }
    } else {
        document.addEventListener('DOMContentLoaded', () => {
            if (!tryInitFixed()) {
                setTimeout(tryInitFixed, 500);
            }
        });
        
        window.addEventListener('load', () => {
            setTimeout(tryInitFixed, 1000);
        });
    }
})();

console.log('✅ Fixed Progress System - loadSurah() is now the default smart function!');

// ===== PANEL PROGRESS BACA =====
// Fungsi untuk mendapatkan semua progress yang tersimpan
function getAllSavedProgress() {
    try {
        const progressData = JSON.parse(localStorage.getItem('quranSurahProgress') || '{}');
        return progressData;
    } catch (error) {
        console.error('Error loading all progress:', error);
        return {};
    }
}

// Fungsi untuk menghitung statistik progress
function calculateProgressStats() {
    const allProgress = getAllSavedProgress();
    const surahCount = Object.keys(allProgress).length;
    
    if (surahCount === 0) {
        return { totalSurah: 0, averageProgress: 0, completedSurah: 0 };
    }
    
    const progressValues = Object.values(allProgress).map(item => item.progress || 0);
    const totalProgress = progressValues.reduce((sum, progress) => sum + progress, 0);
    const averageProgress = Math.floor(totalProgress / surahCount);
    const completedSurah = progressValues.filter(progress => progress >= 100).length;
    
    return {
        totalSurah: surahCount,
        averageProgress: averageProgress,
        completedSurah: completedSurah
    };
}

// Fungsi untuk format tanggal
function formatDate(dateString) {
    try {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) {
            return 'Hari ini';
        } else if (diffDays === 1) {
            return 'Kemarin';
        } else if (diffDays < 7) {
            return `${diffDays} hari lalu`;
        } else {
            return date.toLocaleDateString('id-ID', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric' 
            });
        }
    } catch (error) {
        return 'Tidak diketahui';
    }
}

// Fungsi untuk menampilkan panel progress
function toggleProgressPanel() {
    const panel = document.getElementById('progressPanel');
    const overlay = document.getElementById('overlay');
    
    if (panel && overlay) {
        panel.classList.toggle('open');
        overlay.classList.toggle('show');
        
        if (panel.classList.contains('open')) {
            displayProgressList();
        }
    }
}

// Fungsi untuk menampilkan daftar progress
function displayProgressList() {
    const container = document.getElementById('progressList');
    const statsContainer = document.getElementById('progressStats');
    
    if (!container) return;
    
    const allProgress = getAllSavedProgress();
    const progressEntries = Object.entries(allProgress);
    
    // Update statistik
    if (statsContainer) {
        const stats = calculateProgressStats();
        statsContainer.innerHTML = `
            <h4>📊 Statistik Progress Baca</h4>
            <div class="progress-stats-grid">
                <div class="progress-stat-item">
                    <span class="progress-stat-number">${stats.totalSurah}</span>
                    <span class="progress-stat-label">Surah Dibaca</span>
                </div>
                <div class="progress-stat-item">
                    <span class="progress-stat-number">${stats.averageProgress}%</span>
                    <span class="progress-stat-label">Rata-rata Progress</span>
                </div>
            </div>
        `;
    }
    
    if (progressEntries.length === 0) {
        container.innerHTML = `
            <div class="progress-empty">
                <div class="progress-empty-icon">📖</div>
                <h4>Belum Ada Progress</h4>
                <p>Mulai membaca surah untuk melihat progress Anda di sini</p>
            </div>
        `;
        return;
    }
    
    // Sort berdasarkan tanggal terakhir dibaca (terbaru dulu)
    progressEntries.sort((a, b) => {
        const dateA = new Date(a[1].lastRead || 0);
        const dateB = new Date(b[1].lastRead || 0);
        return dateB - dateA;
    });
    
    let html = '';
    progressEntries.forEach(([surahNumber, progressData]) => {
        const surahName = getSurahName(parseInt(surahNumber));
        const progress = progressData.progress || 0;
        const lastRead = progressData.lastRead;
        const formattedDate = formatDate(lastRead);
        
        // Hitung ayat terakhir yang dibaca
        let estimatedVerse = '';
        try {
            let totalVerses = 0;
            if (typeof quranData !== 'undefined' && quranData(surahNumber)) {
                totalVerses = Object.keys(quranData(surahNumber).verses).length;
            }
            if (totalVerses > 0) {
                const lastVerseRead = Math.ceil((progress / 100) * totalVerses);
                estimatedVerse = ` (≈ ayat ${lastVerseRead}/${totalVerses})`;
            }
        } catch (error) {
            // Ignore error
        }
        
        html += `
            <div class="progress-item" onclick="goToProgressSurah(${surahNumber}, ${progress})">
                <div class="progress-surah-name">${surahName}</div>
                <div class="progress-details">
                    <span class="progress-percentage">${progress}%${estimatedVerse}</span>
                    <span class="progress-date">${formattedDate}</span>
                </div>
                <div class="progress-bar-mini">
                    <div class="progress-fill-mini" style="width: ${progress}%"></div>
                </div>
                <div class="progress-actions">
                    <button class="progress-action-btn continue" 
                            onclick="event.stopPropagation(); continueFromProgress(${surahNumber}, ${progress})"
                            title="Lanjutkan membaca">
                        📖 Lanjutkan
                    </button>
                    <button class="progress-action-btn delete" 
                            onclick="event.stopPropagation(); deleteProgressFromPanel(${surahNumber})"
                            title="Hapus progress">
                        🗑️ Hapus
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Fungsi untuk pergi ke surah dengan progress tertentu
function goToProgressSurah(surahNumber, progress) {
    try {
        const surahSelect = document.getElementById('surah');
        if (!surahSelect) return;
        
        // Tutup panel progress
        toggleProgressPanel();
        
        // Set surah di select
        surahSelect.value = surahNumber;
        
        // Set progress yang akan digunakan
        currentSurahNumber = surahNumber;
        maxReadingProgress = progress;
        
        // Load surah
        if (originalLoadSurah) {
            originalLoadSurah();
        }
        
        // Update currentSurah global
        if (typeof window.currentSurah !== 'undefined') {
            window.currentSurah = surahNumber;
        }
        
        // Update progress bar display
        setTimeout(() => {
            updateProgressBarDisplay();
            
            // Scroll ke posisi progress
            setTimeout(() => {
                scrollToProgressPosition(progress);
                safeShowSuccess(`📖 Membuka ${getSurahName(surahNumber)} di progress ${progress}%`);
            }, 1000);
        }, 500);
        
    } catch (error) {
        console.error('Error going to progress surah:', error);
        safeShowError('Gagal membuka surah');
    }
}

// Fungsi untuk melanjutkan dari progress
function continueFromProgress(surahNumber, progress) {
    goToProgressSurah(surahNumber, progress);
}

// Fungsi untuk menghapus progress dari panel
function deleteProgressFromPanel(surahNumber) {
    try {
        const surahName = getSurahName(surahNumber);
        
        if (confirm(`Hapus progress baca ${surahName}?`)) {
            deleteProgressForSurah(surahNumber);
            displayProgressList(); // Refresh list
            safeShowSuccess(`🗑️ Progress ${surahName} berhasil dihapus`);
        }
    } catch (error) {
        console.error('Error deleting progress from panel:', error);
        safeShowError('Gagal menghapus progress');
    }
}

// Fungsi untuk menambahkan tombol progress di toolbar
function addProgressButtonToToolbar() {
    // Cek apakah tombol sudah ada di HTML
    const existingBtn = document.getElementById('progressBtn');
    if (existingBtn) {
        // Tombol sudah ada di HTML, hanya setup event listener
        existingBtn.onclick = toggleProgressPanel;
        existingBtn.title = 'Lihat Progress Baca';
        console.log('Progress button found and configured');
        return;
    }
    
    // Fallback: buat tombol jika belum ada (untuk backward compatibility)
    const bookmarkBtn = document.querySelector('button[onclick*="toggleBookmarks"]');
    if (bookmarkBtn && !document.getElementById('progressBtn')) {
        const progressBtn = document.createElement('button');
        progressBtn.id = 'progressBtn';
        progressBtn.className = 'rounded-button';
        progressBtn.onclick = toggleProgressPanel;
        progressBtn.innerHTML = '📈 Progress';
        progressBtn.title = 'Lihat Progress Baca';
        bookmarkBtn.parentNode.insertBefore(progressBtn, bookmarkBtn.nextSibling);
        console.log('Progress button created dynamically');
    }
}

// Fungsi inisialisasi panel progress
function initProgressPanel() {
    try {
        addProgressButtonToToolbar(); // Langsung panggil, tanpa delay
        console.log('✅ Progress Panel initialized');
    } catch (error) {
        console.error('Error initializing progress panel:', error);
    }
}

// Expose functions for global access
window.toggleProgressPanel = toggleProgressPanel;
window.goToProgressSurah = goToProgressSurah;
window.continueFromProgress = continueFromProgress;
window.deleteProgressFromPanel = deleteProgressFromPanel;
// Expose functions to global scope
window.previousSurah = previousSurah;
window.nextSurah = nextSurah;
window.updateNavigationButtons = updateNavigationButtons;
window.setupNavigationEventListeners = setupNavigationEventListeners;
window.initializeNavigationSystem = initializeNavigationSystem;

window.loadSurahDirect = loadSurahDirect;
window.loadSurah = loadSurah; // Ini adalah fungsi utama yang smart
window.previousSurah = previousSurah; // Sudah default dengan progress confirmation
window.nextSurah = nextSurah; // Sudah default dengan progress confirmation
window.initPerSurahProgressSystemFixed = initPerSurahProgressSystemFixed;
window.goToProgressSurahFixed = goToProgressSurahFixed;

console.log('✅ Navigation system functions loaded successfully!');
// Auto init panel progress
(function() {
    function tryInitPanel() {
        if (document.body && document.head) {
            setTimeout(() => {
                initProgressPanel();
            }, 100); // Kurangi delay ke 100ms
            return true;
        }
        return false;
    }
    
    // Sederhanakan init
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', tryInitPanel);
    } else {
        tryInitPanel();
    }
})();

console.log('✅ Progress Panel System Loaded!');



// Initialize app
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing app...');
    
    try {
        // Initialize systems in correct order
        addNotificationStyles();
        initializeAudioPlayer();
        initBookmarks();
        loadSettings();
        loadSearchHistory();
        updateBookmarkCount();
        populateSurahSelect();
        
        // Setup event listeners
        setupEventListeners();
        
        // Initialize progress systems dengan delay
        setTimeout(() => {
            initializeProgressBar();
        }, 500);
        
        updateAudioStatus(null);
        
        console.log('✅ Enhanced Al-Quran app initialized successfully!');
    } catch (error) {
        console.error('Error during initialization:', error);
    }
});

console.log('✅ All fixes applied successfully!');

</script>
</body>
</html>