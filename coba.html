<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al-Quran Digital Enhanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Light Mode */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .controls {
            background: #f8f9fa;
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            position: relative;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        select, button, input {
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select:hover, button:hover, input:focus {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
        }

        .icon-btn {
            width: 50px;
            height: 50px;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            border-radius: 50%;
        }

        /* Search History Styles */
        .search-history {
            display: none;
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-top: 8px;
            z-index: 999;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
        }

        .search-history.show {
            display: block;
        }

        .search-history-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .search-history-item {
            padding: 8px;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s ease;
            font-size: 14px;
            color: #333;
            background: #f9f9f9;
            margin-bottom: 5px;
        }

        .search-history-item:hover {
            background: #e0f7fa;
        }

        .search-history-icon {
            margin-right: 6px;
        }

        .search-history-text {
            color: #333;
            flex: 1;
            margin-left: 8px;
        }

        .search-history-delete,
        .search-history-pin {
            background: none;
            border: none;
            font-size: 14px;
            cursor: pointer;
            padding: 2px 5px;
            color: #666;
        }

        .search-history-delete:hover,
        .search-history-pin:hover {
            color: #000;
        }

        .search-history-clear {
            text-align: center;
            margin-top: 10px;
        }

        .clear-history-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
        }

        .search-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-input {
            position: absolute;
            top: 60px;
            right: 0;
            width: 300px;
            display: none;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .search-input.show {
            display: flex;
            gap: 10px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .settings-panel {
            position: absolute;
            overflow: auto;
            flex-direction: column;
            align-items: flex-start;
            max-height: 500px;
            top: 80px;
            right: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 20px;
            width: 400px;
            display: none;
            z-index: 1000;
            border: 2px solid #667eea;
        }

        .settings-panel.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .settings-panel h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.3rem;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .setting-item2 {
            display: flex;
            align-items: left;
            flex-direction: column;
            margin-bottom: 5px;
        }

        .setting-label {
            color: #2c3e50;
            font-weight: 500;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: #ccc;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }

        .toggle-switch.active::after {
            transform: translateX(25px);
        }

        .font-size-control {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .font-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
        }

        .font-btn:hover, .font-btn.active {
            background: #667eea;
            color: white;
        }

        .qari-select {
            width: 100%;
            margin-top: 10px;
        }

        .language-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .lang-btn {
            padding: 6px 12px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .lang-btn:hover, .lang-btn.active {
            background: #667eea;
            color: white;
        }

        /* Tajwid Colors */
        .tajwid-mad { 
            background: linear-gradient(to bottom, rgba(255, 0, 255, 0.3), rgba(255, 0, 255, 0.1));
            border-radius: 2px;
            padding: 0 1px;
        }

        .tajwid-ikhfa { 
            background: linear-gradient(to bottom, rgba(0, 255, 0, 0.4), rgba(0, 255, 0, 0.2));
            border-radius: 2px;
            padding: 0 1px;
        }

        .tajwid-idgham { 
            background: linear-gradient(to bottom, rgba(255, 165, 0, 0.4), rgba(255, 165, 0, 0.2));
            border-radius: 2px;
            padding: 0 1px;
        }

        .tajwid-ghunnah { 
            background: linear-gradient(to bottom, rgba(255, 255, 0, 0.4), rgba(255, 255, 0, 0.2));
            border-radius: 2px;
            padding: 0 1px;
        }

        .tajwid-qalqalah { 
            background: linear-gradient(to bottom, rgba(0, 255, 255, 0.4), rgba(0, 255, 255, 0.2));
            border-radius: 2px;
            padding: 0 1px;
        }

        .tajwid-iqlab { 
            background: linear-gradient(to bottom, rgba(255, 192, 203, 0.4), rgba(255, 192, 203, 0.2));
            border-radius: 2px;
            padding: 0 1px;
        }

        .tajwid-waqf { 
            background: linear-gradient(to bottom, rgba(255, 0, 0, 0.3), rgba(255, 0, 0, 0.1));
            border-radius: 2px;
            padding: 0 1px;
        }

        .tajwid-madd-lazim { 
            background: linear-gradient(to bottom, rgba(0, 0, 255, 0.4), rgba(0, 0, 255, 0.2));
            border-radius: 2px;
            padding: 0 1px;
        }

        .tajwid-madd-wajib { 
            background: linear-gradient(to bottom, rgba(128, 0, 128, 0.4), rgba(128, 0, 128, 0.2));
            border-radius: 2px;
            padding: 0 1px;
        }

        .tajwid-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 10px;
            margin-bottom: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 12px;
        }

        .tajwid-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tajwid-color-box {
            width: 20px;
            height: 15px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }

        .audio-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            background: #e8f5e8;
            padding: 15px;
            border-radius: 10px;
            margin: 20px;
        }

        .audio-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .audio-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .audio-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .surah-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            text-align: center;
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .surah-header h2 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .surah-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .surah-container {
            padding: 20px;
        }

        .ayah-card {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 25px;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            margin-bottom: 20px;
            background: #fafafa;
            transition: all 0.3s ease;
            position: relative;
        }

        .ayah-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .ayah-card.highlight {
            background: #fff3cd;
            border-color: #ffc107;
            animation: pulse 2s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .left-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .ayah-number {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-weight: bold;
            text-align: center;
            width: fit-content;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .verse-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .bookmark-btn.bookmarked {
            background: #ffc107;
            color: #212529;
        }

        .transliteration {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #2196f3;
            display: block;
        }

        .transliteration h4 {
            color: #1976d2;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .transliteration p {
            font-style: italic;
            line-height: 1.5;
            color: #424242;
        }

        .translation {
            background: #f3e5f5;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #9c27b0;
            display: block;
        }

        .translation h4 {
            color: #7b1fa2;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .translation p {
            line-height: 1.6;
            color: #424242;
        }

        .arabic-text {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff8e1;
            padding: 25px;
            border-radius: 10px;
            border-right: 4px solid #ff9800;
        }

        .arabic {
            font-size: 1.8rem;
            line-height: 1.8;
            text-align: right;
            direction: rtl;
            color: #2c3e50;
            font-family: 'Arabic Typesetting', 'Traditional Arabic', serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .arabic:hover {
            color: #667eea;
            transform: scale(1.02);
        }

        .arabic.small-text { font-size: 1.5rem; }
        .arabic.medium-text { font-size: 1.8rem; }
        .arabic.large-text { font-size: 2.2rem; }
        .arabic.xlarge-text { font-size: 2.8rem; }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 1.2rem;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #f44336;
            text-align: center;
            margin: 20px;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            padding: 20px;
        }

        .nav-btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .nav-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .progress-bar {
            background: #e9ecef;
            height: 6px;
            border-radius: 3px;
            margin: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(45deg, #667eea, #764ba2);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .statistics {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .scroll-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            display: none;
            font-size: 20px;
        }

        .scroll-top:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }

        .bookmarks-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 100%;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .bookmarks-panel.open {
            right: 0;
        }

        .bookmarks-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-bookmarks {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .bookmark-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .bookmark-item:hover {
            background: #f8f9fa;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .overlay.show {
            display: block;
        }

        .mobile-toolbar .center-group {
            display: flex;
            align-items: center;
            gap: 10px; /* tambahkan atau ubah ini */
        }

        /* ===== MODAL PROGRESS PER SURAH ===== */
        .progress-modal-overlay-v2 {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .progress-modal-v2 {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 500px;
            min-width: 350px;
            animation: modalSlideInV2 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalSlideInV2 {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .progress-modal-v2 h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .progress-modal-v2 p {
            color: #555;
            margin-bottom: 25px;
            line-height: 1.5;
            font-size: 1rem;
        }

        .progress-info-v2 {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border-left: 4px solid #2196F3;
        }

        .progress-info-v2 h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .progress-bar-preview-v2 {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill-preview-v2 {
            background: linear-gradient(45deg, #667eea, #764ba2);
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text-v2 {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .progress-modal-buttons-v2 {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .progress-modal-btn-v2 {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .progress-modal-btn-v2.save {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .progress-modal-btn-v2.save:hover {
            background: linear-gradient(45deg, #45a049, #3e8e41);
            transform: translateY(-2px);
        }

        .progress-modal-btn-v2.delete {
            background: linear-gradient(45deg, #f44336, #da190b);
            color: white;
        }

        .progress-modal-btn-v2.delete:hover {
            background: linear-gradient(45deg, #da190b, #c62828);
            transform: translateY(-2px);
        }

        .progress-modal-btn-v2.continue {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }

        .progress-modal-btn-v2.continue:hover {
            background: linear-gradient(45deg, #1976D2, #1565C0);
            transform: translateY(-2px);
        }

        .progress-modal-btn-v2.restart {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
        }

        .progress-modal-btn-v2.restart:hover {
            background: linear-gradient(45deg, #F57C00, #EF6C00);
            transform: translateY(-2px);
        }

        /* ===== PANEL PROGRESS BACA ===== */
        .progress-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .progress-panel.open {
            right: 0;
        }

        .progress-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .close-progress {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background 0.3s ease;
        }

        .close-progress:hover {
            background: rgba(255,255,255,0.2);
        }

        .progress-list {
            padding: 0;
        }

        .progress-item {
            padding: 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.3s ease;
            position: relative;
        }

        .progress-item:hover {
            background: #f8f9fa;
        }

        .progress-item:last-child {
            border-bottom: none;
        }

        .progress-surah-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .progress-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .progress-percentage {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .progress-date {
            color: #666;
            font-size: 0.85rem;
        }

        .progress-bar-mini {
            background: #e0e0e0;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill-mini {
            background: linear-gradient(45deg, #667eea, #764ba2);
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .progress-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .progress-action-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .progress-action-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .progress-action-btn.continue {
            background: #28a745;
        }

        .progress-action-btn.continue:hover {
            background: #218838;
        }

        .progress-action-btn.delete {
            background: #dc3545;
        }

        .progress-action-btn.delete:hover {
            background: #c82333;
        }

        .progress-empty {
            padding: 60px 20px;
            text-align: center;
            color: #666;
        }

        .progress-empty-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .progress-stats {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .progress-stats h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 1rem;
        }

        .progress-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .progress-stat-item {
            text-align: center;
        }

        .progress-stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            display: block;
        }

        .progress-stat-label {
            font-size: 0.8rem;
            color: #666;
        }


        /* Dark Theme */
        body.dark-theme {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }

        body.dark-theme .container {
            background: #2c3e50;
            color: white;
        }

        body.dark-theme .controls {
            background: #34495e;
        }

        body.dark-theme .ayah-card {
            background: #445e79;
            border-color: #495057;
            color: white;
        }

        body.dark-theme .ayah-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        body.dark-theme .ayah-card.highlight {
            background: #fff3cd;
            border-color: #ffc107;
            animation: pulse 2s ease-in-out;
        }

        body.dark-theme .transliteration {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            color: white;
        }

        body.dark-theme .translation {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
            color: white;
        }

        body.dark-theme .arabic-text {
            background: #fff8e1;
            border-right: 4px solid #ff9800;
        }

        body.dark-theme .statistics {
            background: #34495e;
        }

        body.dark-theme .settings-panel {
            background: #fff;
            color: white;
        }

        body.dark-theme .setting-item {
            background: #fff;
            border: 1px solid #495057;
        }

        body.dark-theme .audio-controls {
            background: #495057;
        }

        body.dark-theme .bookmarks-panel {
            background: #2c3e50;
            color: white;
        }

        body.dark-theme .bookmark-item {
            border-bottom-color: #495057;
        }

        body.dark-theme .bookmark-item:hover {
            background: #495057;
        }

        body.dark-theme .search-history {
            background: #fff;
            color: white;
        }

        body.dark-theme .search-history-item {
            background: #34495e;
            color: #eee;
        }

        body.dark-theme .search-history-item:hover {
            background: #455a64;
        }

        body.dark-theme .search-history-text {
            color: #fff;
        }

        body.dark-theme .clear-history-btn {
            background: #495057;
        }

        body.dark-theme .search-history-delete,
        body.dark-theme .search-history-pin {
            color: #ccc;
        }

        body.dark-theme .search-history-delete:hover,
        body.dark-theme .search-history-pin:hover {
            color: white;
        }

        body.dark-theme .tajwid-legend {
            background: #34495e;
            color: white;
        }

        /* Dark theme tajwid colors with lower opacity */
        body.dark-theme .tajwid-mad { 
            background: linear-gradient(to bottom, rgba(255, 0, 255, 0.2), rgba(255, 0, 255, 0.05));
        }
        body.dark-theme .tajwid-ikhfa { 
            background: linear-gradient(to bottom, rgba(0, 255, 0, 0.2), rgba(0, 255, 0, 0.05));
        }
        body.dark-theme .tajwid-idgham { 
            background: linear-gradient(to bottom, rgba(255, 165, 0, 0.2), rgba(255, 165, 0, 0.05));
        }
        body.dark-theme .tajwid-ghunnah { 
            background: linear-gradient(to bottom, rgba(255, 255, 0, 0.2), rgba(255, 255, 0, 0.05));
        }
        body.dark-theme .tajwid-qalqalah { 
            background: linear-gradient(to bottom, rgba(0, 255, 255, 0.2), rgba(0, 255, 255, 0.05));
        }
        body.dark-theme .tajwid-iqlab { 
            background: linear-gradient(to bottom, rgba(255, 192, 203, 0.2), rgba(255, 192, 203, 0.05));
        }
        body.dark-theme .tajwid-waqf { 
            background: linear-gradient(to bottom, rgba(255, 0, 0, 0.2), rgba(255, 0, 0, 0.05));
        }
        body.dark-theme .tajwid-madd-lazim { 
            background: linear-gradient(to bottom, rgba(0, 0, 255, 0.2), rgba(0, 0, 255, 0.05));
        }
        body.dark-theme .tajwid-madd-wajib { 
            background: linear-gradient(to bottom, rgba(128, 0, 128, 0.2), rgba(128, 0, 128, 0.05));
        }

        /* ===== Dark theme MODAL PROGRESS PER SURAH ===== */
        body.dark-theme .progress-modal-v2 {
            background: #2c3e50;
            color: white;
        }

        body.dark-theme .progress-modal-v2 h3 {
            color: white;
        }

        body.dark-theme .progress-modal-v2 p {
            color: #bbb;
        }

        body.dark-theme .progress-info-v2 {
            background: #34495e;
            border-left-color: #3498db;
        }

        body.dark-theme .progress-info-v2 h4 {
            color: #3498db;
        }

        body.dark-theme .progress-text-v2 {
            color: #aaa;
        }

        /* ===== Dark theme PANEL PROGRESS BACA ===== */

        body.dark-theme .progress-panel {
            background: #2c3e50;
            color: white;
        }

        body.dark-theme .progress-item {
            border-bottom-color: #495057;
        }

        body.dark-theme .progress-item:hover {
            background: #495057;
        }

        body.dark-theme .progress-surah-name {
            color: white;
        }

        body.dark-theme .progress-date {
            color: #aaa;
        }

        body.dark-theme .progress-empty {
            color: #aaa;
        }

        body.dark-theme .progress-stats {
            background: #34495e;
            border-bottom-color: #495057;
        }

        body.dark-theme .progress-stats h4 {
            color: white;
        }

        body.dark-theme .progress-stat-label {
            color: #aaa;
        }

        @media (max-width: 768px) {
            .ayah-card {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 20px;
            }
            
            .arabic {
                font-size: 1.5rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .surah-header h2 {
                font-size: 1.5rem;
            }

            .bookmarks-panel {        /* penagturan di sini ( JS : function handleResize() )*/
                width: none;
                right: -110%;
            }

            .settings-panel {         /* penagturan di sini ( JS : function handleResize() )*/
                width: none;
                right: none;
            }

            .search-input {
                left: -1px;
                width: 350px;
            }

            /* Mobile responsive untuk progress panel */
            .progress-panel {
                width: 100%;
                right: -100%;
            }

            .progress-panel.open {
                right: 0;
            }
            
            /* Posisi Mobile Button*/
            .mobile-toolbar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 15px;
                gap: 5px;
            }

            .mobile-toolbar .left-group,
            .mobile-toolbar .center-group,
            .mobile-toolbar .right-group {
                display: flex;
                align-items: center;
            }

            .mobile-toolbar .left-group {
                justify-content: flex-start;
                flex: 1;
            }

            .mobile-toolbar .center-group {
            justify-content: center;
            flex: 2;
            gap: 10px;
        }

            .mobile-toolbar .right-group {
                justify-content: flex-end;
                flex: 1;
                
            }

            .circle-button {
                width: 50px;
                height: 50px;
                border-radius: 50%;
                border: none;
                display: flex;
                justify-content: center;
                align-items: center;
                background: linear-gradient(to right, rgba(123,47,247,0.9), rgba(241,7,163,0.9));
                color: white;
                cursor: pointer;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            }

            .rounded-button {
                padding: 10px 15px;
                border-radius: 12px;
                border: none;
                background: linear-gradient(to right, rgba(123,47,247,0.9), rgba(241,7,163,0.9));
                color: white;
                font-size: 0.9rem;
                display: inline-flex;
                align-items: center;
                gap: 5px;
                cursor: pointer;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
                transition: all 0.3s ease;
                white-space: nowrap; 
            }
        }

        #progressBtn {
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 9999;
            animation: slideInRight 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay" onclick="closeAllPanels()"></div>
    
    <div class="container">
        <div class="header">
            <button class="theme-toggle" onclick="toggleTheme()" title="Ubah Tema Gelap">üåô</button>
            <h1>üìñ Al-Quran Digital Enhanced</h1>
            <p>Membaca Al-Quran dengan mudah dan nyaman</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="surah"></label>
                <select id="surah">
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>
            
            <div class="mobile-toolbar control-group">
                <div class="search-container" id="left-group">
                    <button class="icon-btn" onclick="toggleSearch()" title="Cari Ayat">üîç</button>
                    <div class="search-input" id="searchContainer">
                        <div class="search-input-wrapper">
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="searchInput" placeholder="Cari ayat..." />
                                <button onclick="searchVerse()">Cari</button>
                            </div>
                            <div class="search-history" id="searchHistory">
                                <div class="search-history-header">
                                    üìö Riwayat Pencarian
                                </div>
                                <div id="searchHistoryList">
                                    <!-- Items akan diisi oleh JavaScript -->
                                </div>
                                <div class="search-history-clear">
                                    <button class="clear-history-btn" onclick="clearSearchHistory(); keepSearchPanelOpen();">
                                        üóëÔ∏è Hapus Semua Riwayat
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="center-group">
                    <button class="rounded-button" id="loadSurahBtn">üìñ Tampilkan Surah</button>
                    <button class="rounded-button" onclick="toggleBookmarks()">üîñ Bookmark</button>
                </div>
                <!-- Progress Panel -->
                <div class="progress-panel" id="progressPanel">
                    <div class="progress-header">
                        <h3>üìà Progress Baca</h3>
                        <button class="close-progress" onclick="toggleProgressPanel()">√ó</button>
                    </div>
                    <div class="progress-stats" id="progressStats">
                        <!-- Stats will be populated by JavaScript -->
                    </div>
                    <div class="progress-list" id="progressList">
                        <!-- Progress items will be populated by JavaScript -->
                    </div>
                </div>
                <div class="right-group">
                    <button class="icon-btn" onclick="toggleSettings()" title="Pengaturan">‚öôÔ∏è</button>
                </div>
                
                <!-- Settings Panel -->
                <div class="settings-panel" id="settingsPanel">
                    <h3>‚öôÔ∏è Pengaturan</h3>
                    
                    <div class="setting-item2">
                        <span class="setting-label">Ukuran Font Arab</span>
                    </div>
                    <div class="setting-item">
                        <div class="font-size-control">
                            <button class="font-btn" onclick="setFontSize('small')" title="Kecil">A</button>
                            <button class="font-btn active" onclick="setFontSize('medium')" title="Sedang">A</button>
                            <button class="font-btn" onclick="setFontSize('large')" title="Besar">A</button>
                            <button class="font-btn" onclick="setFontSize('xlarge')" title="Sangat Besar">A</button>
                        </div>
                    </div>

                    <div class="setting-item">
                        <span class="setting-label">Tampilkan Tajwid</span>
                        <div class="toggle-switch" onclick="toggleTajwid()" id="tajwidToggle"></div>
                    </div>
                    
                    <div class="tajwid-legend" id="tajwidLegend" style="display: none;">
                        <div class="tajwid-legend-item">
                            <div class="tajwid-color-box tajwid-ghunnah"></div>
                            <span>Ghunnah</span>
                        </div>
                        <div class="tajwid-legend-item">
                            <div class="tajwid-color-box tajwid-idgham"></div>
                            <span>Idgham</span>
                        </div>
                        <div class="tajwid-legend-item">
                            <div class="tajwid-color-box tajwid-ikhfa"></div>
                            <span>Ikhfa</span>
                        </div>
                        <div class="tajwid-legend-item">
                            <div class="tajwid-color-box tajwid-iqlab"></div>
                            <span>Iqlab</span>
                        </div>
                        <div class="tajwid-legend-item">
                            <div class="tajwid-color-box tajwid-mad"></div>
                            <span>Mad Thabi'i</span>
                        </div>
                        <div class="tajwid-legend-item">
                            <div class="tajwid-color-box tajwid-qalqalah"></div>
                            <span>Qalqalah</span>
                        </div>
                        <div class="tajwid-legend-item">
                            <div class="tajwid-color-box tajwid-waqf"></div>
                            <span>Waqf</span>
                        </div>
                        <div class="tajwid-legend-item">
                            <div class="tajwid-color-box tajwid-madd-lazim"></div>
                            <span>Mad Lazim</span>
                        </div>
                        <div class="tajwid-legend-item">
                            <div class="tajwid-color-box tajwid-madd-wajib"></div>
                            <span>Mad Wajib</span>
                        </div>
                    </div>

                    <div class="setting-item">
                        <span class="setting-label">Tampilkan Transliterasi</span>
                        <div class="toggle-switch active" onclick="toggleTransliteration()" id="transliterationToggle"></div>
                    </div>

                    <div class="setting-item">
                        <span class="setting-label">Tampilkan Terjemahan</span>
                        <div class="toggle-switch active" onclick="toggleTranslation()" id="translationToggle"></div>
                    </div>

                    <div class="setting-item2">
                        <span class="setting-label">Pilih Bahasa Terjemah</span>
                    </div>
                    <div class="setting-item">
                        <div class="language-selector">
                            <button class="lang-btn active" onclick="setLanguage('id')">ID</button>
                            <button class="lang-btn" onclick="setLanguage('en')">EN</button>
                            <button class="lang-btn" onclick="setLanguage('my')">MY</button>
                            <button class="lang-btn" onclick="setLanguage('fr')">FR</button>
                            <button class="lang-btn" onclick="setLanguage('de')">DE</button>
                            <button class="lang-btn" onclick="setLanguage('tr')">TR</button>
                        </div>
                    </div>

                    <div class="setting-item2">
                        <span class="setting-label">Pilih Qari</span>
                    </div>
                    <div class="setting-item">
                        <select class="qari-select" id="qariSelect">
                            <option value="abdul-basit">Abdul Basit</option>
                            <option value="al-husary">Al Husary</option>
                            <option value="al-minshawi">Al Minshawi Mujawwad</option>
                            <option value="al-huzaifi">Ali bin Abdurrahman al-Huzaifi</option>
                            <option value="aziz-alili">Aziz Alili</option>
                            <option value="mishari-alafasy">Mishari Alafasy</option>
                            <option value="saad-al-ghamidi">Saad Al Ghamidi</option>
                            <option value="saud-ash-shuraym">Saud Ash-Shuraym</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="audio-controls">
            <button class="audio-btn" onclick="playAudio()" id="playAudioBtn" disabled>‚ñ∂Ô∏è Putar Audio</button>
            <span id="audioStatus">üîá Tidak ada audio yang tersedia</span>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="statistics" id="statistics">
            <div class="stat-item">
                <div class="stat-number" id="totalAyahs">0</div>
                <div class="stat-label">Total Ayat</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="readingProgress">0%</div>
                <div class="stat-label">Progress Baca</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="bookmarkCount">0</div>
                <div class="stat-label">Bookmark</div>
            </div>
        </div>

        <div class="navigation">
            <button class="nav-btn" onclick="previousSurah()" id="prevBtn">‚Üê Surah Sebelumnya</button>
            <button class="nav-btn" onclick="nextSurah()" id="nextBtn">Surah Selanjutnya ‚Üí</button>
        </div>

        <div class="surah-container" id="surahContainer">
            <div class="loading">Pilih surah untuk mulai membaca</div>
        </div>
    </div>

    <button class="scroll-top" onclick="scrollToTop()" id="scrollTopBtn">‚Üë</button>

    <!-- Bookmarks Panel -->
    <div class="bookmarks-panel" id="bookmarksPanel">
        <div class="bookmarks-header">
            <h3>üìö Bookmark Ayat</h3>
            <button class="close-bookmarks" onclick="toggleBookmarks()">√ó</button>
        </div>
        <div id="bookmarksList">
            <div style="padding: 20px; text-align: center; color: #666;">
                Belum ada bookmark
            </div>
        </div>
    </div>

    <script>
// Enhanced Quran data with more surahs
const tajwidData = {
    1: { // Al-Fatihah
        1: {
            tajwid: "ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸé<span class='tajwid-mad'>Ÿ∞</span>ŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê"
        },
        2: {
            tajwid: "ÿßŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸÑŸéŸëŸáŸê ÿ±Ÿéÿ®ŸêŸë ÿßŸÑŸíÿπŸé<span class='tajwid-mad'>ÿß</span>ŸÑŸéŸÖŸê<span class='tajwid-mad'>Ÿä</span>ŸÜŸé"
        },
        3: {
            tajwid: "ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸé<span class='tajwid-mad'>Ÿ∞</span>ŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠Ÿê<span class='tajwid-mad'>Ÿä</span>ŸÖŸê"
        },
        4: {
            tajwid: "ŸÖŸé<span class='tajwid-mad'>ÿß</span>ŸÑŸêŸÉŸê ŸäŸéŸàŸíŸÖŸê ÿßŸÑÿØŸêŸë<span class='tajwid-mad'>Ÿä</span>ŸÜŸê"
        },
        5: {
            tajwid: "ÿ•ŸêŸäŸéŸë<span class='tajwid-mad'>ÿß</span>ŸÉŸé ŸÜŸéÿπŸíÿ®ŸèÿØŸè ŸàŸéÿ•ŸêŸäŸéŸë<span class='tajwid-mad'>ÿß</span>ŸÉŸé ŸÜŸéÿ≥Ÿíÿ™ŸéÿπŸê<span class='tajwid-mad'>Ÿä</span>ŸÜŸè"
        },
        6: {
            tajwid: "ÿßŸáŸíÿØŸêŸÜŸéÿß ÿßŸÑÿµŸêŸëÿ±Ÿé<span class='tajwid-mad'>ÿß</span>ÿ∑Ÿé ÿßŸÑŸíŸÖŸèÿ≥Ÿíÿ™ŸéŸÇŸê<span class='tajwid-mad'>Ÿä</span>ŸÖŸé"
        },
        7: {
            tajwid: "ÿµŸêÿ±Ÿé<span class='tajwid-mad'>ÿß</span>ÿ∑Ÿé ÿßŸÑŸéŸëÿ∞Ÿê<span class='tajwid-mad'>Ÿä</span>ŸÜŸé ÿ£Ÿé<span class='tajwid-ikhfa'>ŸÜŸí</span>ÿπŸéŸÖŸíÿ™Ÿé ÿπŸéŸÑŸéŸäŸíŸáŸêŸÖŸí ÿ∫ŸéŸäŸí<span class='tajwid-mad'>ÿ±</span> ÿßŸÑŸíŸÖŸéÿ∫Ÿíÿ∂Ÿè<span class='tajwid-mad'>Ÿà</span>ÿ®Ÿê ÿπŸéŸÑŸéŸäŸíŸáŸêŸÖŸí ŸàŸéŸÑŸéÿß ÿßŸÑÿ∂ŸéŸë<span class='tajwid-mad'>ÿß</span>ŸÑŸêŸë<span class='tajwid-mad'>Ÿä</span>ŸÜŸé"
        }
    },
    2: { // Al-Baqarah
        1: {
            tajwid: "ÿßŸÑŸÖ"
        },
        2: {
            tajwid: "ÿ∞Ÿé<span class='tajwid-mad'>Ÿ∞</span>ŸÑŸêŸÉŸé ÿßŸÑŸíŸÉŸêÿ™Ÿé<span class='tajwid-mad'>ÿß</span>ÿ®Ÿè ŸÑŸéÿß ÿ±ŸéŸäŸíÿ®Ÿé €õ ŸÅŸê<span class='tajwid-mad'>Ÿä</span>ŸáŸê €õ ŸáŸèÿØŸãŸâ ŸÑŸêŸëŸÑŸíŸÖŸèÿ™ŸéŸëŸÇŸê<span class='tajwid-mad'>Ÿä</span>ŸÜŸé"
        },
        3: {
            tajwid: "ÿßŸÑŸéŸëÿ∞Ÿê<span class='tajwid-mad'>Ÿä</span>ŸÜŸé ŸäŸèÿ§ŸíŸÖŸêŸÜŸè<span class='tajwid-mad'>Ÿà</span>ŸÜŸé ÿ®ŸêÿßŸÑŸíÿ∫ŸéŸäŸíÿ®Ÿê ŸàŸéŸäŸèŸÇŸê<span class='tajwid-mad'>Ÿä</span>ŸÖŸè<span class='tajwid-mad'>Ÿà</span>ŸÜŸé ÿßŸÑÿµŸéŸëŸÑŸé<span class='tajwid-mad'>ÿß</span>ÿ©Ÿé ŸàŸéŸÖŸêŸÖŸéŸëÿß ÿ±Ÿéÿ≤ŸéŸÇŸíŸÜŸé<span class='tajwid-mad'>ÿß</span>ŸáŸèŸÖŸí ŸäŸèŸÜŸÅŸêŸÇŸè<span class='tajwid-mad'>Ÿà</span>ŸÜŸé"
        }
    }
};

const quranData = {
    1: {
        name: "Al-Fatihah",
        arabicName: "ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©",
        meaning: "Pembukaan",
        revelation: "Makkah",
        verses: {
            1: {
                arabic: "ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸëŸ∞ŸáŸê ÿßŸÑÿ±ŸëŸéÿ≠ŸíŸÖŸ∞ŸÜŸê ÿßŸÑÿ±ŸëŸéÿ≠ŸêŸäŸíŸÖŸê €ùŸ°",
                transliteration: "BismillƒÅhi'r-ra·∏•mƒÅni'r-ra·∏•ƒ´m",
                translation: "Dengan menyebut nama Allah Yang Maha Pemurah lagi Maha Penyayang."
            },
            2: {
                arabic: "ÿßŸéŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸëŸ∞ŸáŸê ÿ±Ÿéÿ®ŸëŸê ÿßŸÑŸíÿπŸ∞ŸÑŸéŸÖŸêŸäŸíŸÜŸé€ô €ùŸ¢",
                transliteration: "Al-·∏•amdu lillƒÅhi rabbi'l-'ƒÅlamƒ´n",
                translation: "Segala puji bagi Allah, Tuhan semesta alam."
            },
            3: {
                arabic: "ÿßŸÑÿ±ŸëŸéÿ≠ŸíŸÖŸ∞ŸÜŸê ÿßŸÑÿ±ŸëŸéÿ≠ŸêŸäŸíŸÖŸê€ô €ùŸ£",
                transliteration: "Ar-ra·∏•mƒÅni'r-ra·∏•ƒ´m", 
                translation: "Maha Pemurah lagi Maha Penyayang."
            },
            4: {
                arabic: "ŸÖŸ∞ŸÑŸêŸÉŸê ŸäŸéŸàŸíŸÖŸê ÿßŸÑÿØŸëŸêŸäŸíŸÜŸê€ó €ùŸ§",
                transliteration: "MƒÅliki yawmi'd-dƒ´n",
                translation: "Yang menguasai di Hari Pembalasan."
            },
            5: {
                arabic: "ÿßŸêŸäŸëŸéÿßŸÉŸé ŸÜŸéÿπŸíÿ®ŸèÿØŸè ŸàŸéÿßŸêŸäŸëŸéÿßŸÉŸé ŸÜŸéÿ≥Ÿíÿ™ŸéÿπŸêŸäŸíŸÜŸè€ó €ùŸ•",
                transliteration: "IyyƒÅka na'budu wa iyyƒÅka nasta'ƒ´n",
                translation: "Hanya kepada Engkaulah kami menyembah dan hanya kepada Engkaulah kami meminta pertolongan."
            },
            6: {
                arabic: "ÿßŸêŸáŸíÿØŸêŸÜŸéÿß ÿßŸÑÿµŸëŸêÿ±Ÿéÿßÿ∑Ÿé ÿßŸÑŸíŸÖŸèÿ≥Ÿíÿ™ŸéŸÇŸêŸäŸíŸÖŸé€ô €ùŸ¶",
                transliteration: "Ihdina·π£-·π£irƒÅ·π≠al-mustaqƒ´m",
                translation: "Tunjukilah kami jalan yang lurus."
            },
            7: {
                arabic: "ÿµŸêÿ±Ÿéÿßÿ∑Ÿé ÿßŸÑŸëŸéÿ∞ŸêŸäŸíŸÜŸé ÿßŸéŸÜŸíÿπŸéŸÖŸíÿ™Ÿé ÿπŸéŸÑŸéŸäŸíŸáŸêŸÖŸí €ï€ô ÿ∫ŸéŸäŸíÿ±Ÿê ÿßŸÑŸíŸÖŸéÿ∫Ÿíÿ∂ŸèŸàŸíÿ®Ÿê ÿπŸéŸÑŸéŸäŸíŸáŸêŸÖŸí ŸàŸéŸÑŸéÿß ÿßŸÑÿ∂ŸëŸéÿß€§ŸÑŸêŸëŸäŸíŸÜŸé‡£ñ €ùŸß",
                transliteration: "·π¢irƒÅ·π≠al-ladhƒ´na an'amta 'alayhim ghayril-magh·∏ç≈´bi 'alayhim wa la·∏ç-·∏çƒÅllƒ´n",
                translation: "(Yaitu) jalan orang-orang yang telah Engkau beri nikmat kepada mereka; bukan (jalan) mereka yang dimurkai dan bukan (pula jalan) mereka yang sesat."
            }
        }
    },
    2: {
        name: "Al-Baqarah",
        arabicName: "ÿßŸÑÿ®ŸÇÿ±ÿ©",
        meaning: "Sapi Betina",
        revelation: "Madinah",
        verses: {
            1: {
                arabic: "ÿßŸÑŸÖ",
                transliteration: "Alif LƒÅm Mƒ´m",
                translation: "Alif Laam Miim."
            },
            2: {
                arabic: "ÿ∞ŸéŸ∞ŸÑŸêŸÉŸé ÿßŸÑŸíŸÉŸêÿ™Ÿéÿßÿ®Ÿè ŸÑŸéÿß ÿ±ŸéŸäŸíÿ®Ÿé €õ ŸÅŸêŸäŸáŸê €õ ŸáŸèÿØŸãŸâ ŸÑŸêŸëŸÑŸíŸÖŸèÿ™ŸéŸëŸÇŸêŸäŸÜŸé",
                transliteration: "DhƒÅlika al-kitƒÅbu lƒÅ rayba fƒ´hi hudal lil-muttaqƒ´n",
                translation: "Kitab (Al Quran) ini tidak ada keraguan padanya; petunjuk bagi mereka yang bertakwa."
            },
            3: {
                arabic: "ÿßŸÑŸéŸëÿ∞ŸêŸäŸÜŸé ŸäŸèÿ§ŸíŸÖŸêŸÜŸèŸàŸÜŸé ÿ®ŸêÿßŸÑŸíÿ∫ŸéŸäŸíÿ®Ÿê ŸàŸéŸäŸèŸÇŸêŸäŸÖŸèŸàŸÜŸé ÿßŸÑÿµŸéŸëŸÑŸéÿßÿ©Ÿé ŸàŸéŸÖŸêŸÖŸéŸëÿß ÿ±Ÿéÿ≤ŸéŸÇŸíŸÜŸéÿßŸáŸèŸÖŸí ŸäŸèŸÜŸÅŸêŸÇŸèŸàŸÜŸé",
                transliteration: "Alladhƒ´na yu'min≈´na bil-ghaybi wa yuqƒ´m≈´na·π£-·π£alƒÅta wa mimmƒÅ razaqnƒÅhum yunfiq≈´n",
                translation: "(yaitu) mereka yang beriman kepada yang ghaib, yang mendirikan shalat, dan menafkahkan sebahagian rezeki yang Kami anugerahkan kepada mereka."
            },
            4: {
                arabic: "ŸàŸéÿßŸÑŸéŸëÿ∞ŸêŸäŸÜŸé ŸäŸèÿ§ŸíŸÖŸêŸÜŸèŸàŸÜŸé ÿ®ŸêŸÖŸéÿß ÿ£ŸèŸÜÿ≤ŸêŸÑŸé ÿ•ŸêŸÑŸéŸäŸíŸÉŸé ŸàŸéŸÖŸéÿß ÿ£ŸèŸÜÿ≤ŸêŸÑŸé ŸÖŸêŸÜ ŸÇŸéÿ®ŸíŸÑŸêŸÉŸé ŸàŸéÿ®ŸêÿßŸÑŸíÿ¢ÿÆŸêÿ±Ÿéÿ©Ÿê ŸáŸèŸÖŸí ŸäŸèŸàŸÇŸêŸÜŸèŸàŸÜŸé",
                transliteration: "Wa alladhƒ´na yu'min≈´na bimƒÅ unzila ilayka wa mƒÅ unzila min qablika wa bil-ƒÅkhirati hum y≈´qin≈´n",
                translation: "Dan mereka yang beriman kepada kitab (Al Quran) yang telah diturunkan kepadamu dan kitab-kitab yang telah diturunkan sebelummu, serta mereka yakin akan adanya (kehidupan) akhirat."
            },
            5: {
                arabic: "ÿ£ŸèŸàŸÑŸéŸ∞ÿ¶ŸêŸÉŸé ÿπŸéŸÑŸéŸâŸ∞ ŸáŸèÿØŸãŸâ ŸÖŸêŸëŸÜ ÿ±ŸéŸëÿ®ŸêŸëŸáŸêŸÖŸí €ñ ŸàŸéÿ£ŸèŸàŸÑŸéŸ∞ÿ¶ŸêŸÉŸé ŸáŸèŸÖŸè ÿßŸÑŸíŸÖŸèŸÅŸíŸÑŸêÿ≠ŸèŸàŸÜŸé",
                transliteration: "UlƒÅ'ika 'alƒÅ hudal mir rabbihim wa ulƒÅ'ika humul muflih≈´n",
                translation: "Mereka itulah yang tetap mendapat petunjuk dari Tuhan mereka, dan merekalah orang-orang yang beruntung."
            }
        }
    },
    3: {
        name: "Ali 'Imran",
        arabicName: "ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ",
        meaning: "Keluarga Imran",
        revelation: "Madinah",
        verses: {
            1: {
                arabic: "ÿßŸÑŸÖ",
                transliteration: "Alif LƒÅm Mƒ´m",
                translation: "Alif Laam Miim."
            },
            2: {
                arabic: "ÿßŸÑŸÑŸéŸëŸáŸè ŸÑŸéÿß ÿ•ŸêŸÑŸéŸ∞ŸáŸé ÿ•ŸêŸÑŸéŸëÿß ŸáŸèŸàŸé ÿßŸÑŸíÿ≠ŸéŸäŸèŸë ÿßŸÑŸíŸÇŸéŸäŸèŸëŸàŸÖŸè",
                transliteration: "AllƒÅhu lƒÅ ilƒÅha illƒÅ huwal-·∏•ayy ul-qayy≈´m",
                translation: "Allah, tidak ada Tuhan selain Dia Yang Hidup kekal lagi terus menerus mengurus (makhluk-Nya)."
            },
            3: {
                arabic: "ŸÜŸéÿ≤ŸéŸëŸÑŸé ÿπŸéŸÑŸéŸäŸíŸÉŸé ÿßŸÑŸíŸÉŸêÿ™Ÿéÿßÿ®Ÿé ÿ®ŸêÿßŸÑŸíÿ≠ŸéŸÇŸêŸë ŸÖŸèÿµŸéÿØŸêŸëŸÇŸãÿß ŸÑŸêŸëŸÖŸéÿß ÿ®ŸéŸäŸíŸÜŸé ŸäŸéÿØŸéŸäŸíŸáŸê ŸàŸéÿ£ŸéŸÜÿ≤ŸéŸÑŸé ÿßŸÑÿ™ŸéŸëŸàŸíÿ±Ÿéÿßÿ©Ÿé ŸàŸéÿßŸÑŸíÿ•ŸêŸÜÿ¨ŸêŸäŸÑŸé",
                transliteration: "Nazzala 'alaykal kitƒÅba bil haqqi mu·π£addiqal limƒÅ bayna yadayhi wa anzalat tawrƒÅta wal injƒ´l",
                translation: "Dia menurunkan Al Kitab (Al Quran) kepadamu dengan sebenarnya; membenarkan kitab yang telah diturunkan sebelumnya dan menurunkan Taurat dan Injil."
            }
        }
    },
    4: {
        name: "An-Nisa",
        arabicName: "ÿßŸÑŸÜÿ≥ÿßÿ°",
        meaning: "Wanita",
        revelation: "Madinah",
        verses: {
            1: {
                arabic: "ŸäŸéÿß ÿ£ŸéŸäŸèŸëŸáŸéÿß ÿßŸÑŸÜŸéŸëÿßÿ≥Ÿè ÿßÿ™ŸéŸëŸÇŸèŸàÿß ÿ±Ÿéÿ®ŸéŸëŸÉŸèŸÖŸè ÿßŸÑŸéŸëÿ∞ŸêŸä ÿÆŸéŸÑŸéŸÇŸéŸÉŸèŸÖ ŸÖŸêŸëŸÜ ŸÜŸéŸëŸÅŸíÿ≥Ÿç ŸàŸéÿßÿ≠ŸêÿØŸéÿ©Ÿç",
                transliteration: "YƒÅ ayyuhan nƒÅsuttaq≈´ rabbakumul ladhƒ´ khalaqakum min nafsiw wƒÅhidah",
                translation: "Hai sekalian manusia, bertakwalah kepada Tuhan-mu yang telah menciptakan kamu dari seorang diri."
            }
        }
    },
    5: {
        name: "Al-Ma'idah",
        arabicName: "ÿßŸÑŸÖÿßÿ¶ÿØÿ©",
        meaning: "Hidangan",
        revelation: "Madinah",
        verses: {
            1: {
                arabic: "ŸäŸéÿß ÿ£ŸéŸäŸèŸëŸáŸéÿß ÿßŸÑŸéŸëÿ∞ŸêŸäŸÜŸé ÿ¢ŸÖŸéŸÜŸèŸàÿß ÿ£ŸéŸàŸíŸÅŸèŸàÿß ÿ®ŸêÿßŸÑŸíÿπŸèŸÇŸèŸàÿØŸê",
                transliteration: "YƒÅ ayyuhal ladhƒ´na ƒÅman≈´ awf≈´ bil 'uq≈´d",
                translation: "Hai orang-orang yang beriman, penuhilah aqad-aqad itu."
            }
        }
    }
};

// Global state
let currentSurah = 1;

let bookmarks = [];
let currentAudio = null;
let searchResults = [];
let autoPlayQueue = [];
let currentAutoIndex = 0;
let searchHistory = [];

let currentSurahProgress = null;
let currentSurahNumber = null;
let maxReadingProgress = 0;
let isProgressChanged = false;
let originalLoadSurah = null;
let originalPreviousSurah = null;
let originalNextSurah = null;

let currentSettings = {
    fontSize: 'medium',
    showTransliteration: true,
    showTranslation: true,
    showTajwid: false,
    language: 'id',
    qari: 'abdul-basit',
    darkTheme: false
};
let audioPlayer = {
    isVisible: false,
    currentSpeed: 1.0,
    speeds: [0.5, 0.75, 1.0, 1.25, 1.5, 2.0],
    speedIndex: 2,
    isMuted: false,
    volume: 1.0
};

// Search History functions
function loadSearchHistory() {
    const saved = localStorage.getItem('quranSearchHistory');
    try {
        const parsed = JSON.parse(saved);
        searchHistory = Array.isArray(parsed)
            ? parsed.map(item => typeof item === 'string' ? { text: item, pinned: false } : item)
            : [];
    } catch {
        searchHistory = [];
    }
    renderSearchHistory();
}

function addToSearchHistory(query) {
    if (!query || typeof query !== 'string') return;

    const existingIndex = searchHistory.findIndex(item => item.text === query);
    if (existingIndex !== -1) {
        const existingItem = searchHistory.splice(existingIndex, 1)[0];
        searchHistory.unshift(existingItem);
    } else {
        searchHistory.unshift({ text: query, pinned: false });
    }

    // Limit history
    const pinned = searchHistory.filter(h => h.pinned);
    const nonPinned = searchHistory.filter(h => !h.pinned).slice(0, 10 - pinned.length);
    searchHistory = [...pinned, ...nonPinned];

    renderSearchHistory();
    saveSilently();
}

// FUNGSI renderSearchHistory()
function renderSearchHistory() {
    const container = document.getElementById('searchHistoryList');
    if (!container) return;
    
    container.innerHTML = '';

    if (!searchHistory.length) {
        container.innerHTML = '<div style="padding: 10px; color: #666; text-align: center;">Belum ada riwayat</div>';
        return;
    }

    // Sort sekali saja saat render
    const sorted = [...searchHistory].sort((a, b) => (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0));

    sorted.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'search-history-item';
        div.setAttribute('data-index', index);
        div.setAttribute('data-text', item.text);

        const icon = document.createElement('span');
        icon.className = 'search-history-icon';
        icon.textContent = 'üïì';

        const text = document.createElement('span');
        text.className = 'search-history-text';
        text.textContent = item.text || '';
        
        // HANYA TEXT YANG BISA DIKLIK UNTUK SEARCH
        text.addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('searchInput').value = item.text;
            searchVerse();
            // HANYA SEARCH YANG MENUTUP PANEL
            document.getElementById('searchContainer').classList.remove('show');
            document.getElementById('searchHistory').classList.remove('show');
        });

        const actions = document.createElement('span');
        actions.style.display = 'flex';
        actions.style.gap = '5px';

        const pinBtn = document.createElement('button');
        pinBtn.className = 'search-history-pin';
        pinBtn.textContent = item.pinned ? 'üìå' : 'üìç';
        pinBtn.title = item.pinned ? 'Unpin dari atas' : 'Pin ke atas';
        pinBtn.setAttribute('data-text', item.text);
        
        // PIN BUTTON - TIDAK MENUTUP PANEL
        pinBtn.addEventListener('click', handleInstantPin);

        const delBtn = document.createElement('button');
        delBtn.className = 'search-history-delete';
        delBtn.textContent = '‚ùå';
        delBtn.setAttribute('data-text', item.text);
        
        // DELETE BUTTON - TIDAK MENUTUP PANEL  
        delBtn.addEventListener('click', handleInstantDelete);

        actions.appendChild(pinBtn);
        actions.appendChild(delBtn);

        div.appendChild(icon);
        div.appendChild(text);
        div.appendChild(actions);
        container.appendChild(div);
    });
}

// HANDLER INSTANT PIN - TANPA RE-RENDER
function handleInstantPin(e) {
    e.stopPropagation();
    e.preventDefault();
    
    const button = e.target;
    const itemText = button.getAttribute('data-text');
    
    // Cari item di data
    const item = searchHistory.find(h => h.text === itemText);
    if (!item) return;
    
    // Toggle pin status
    item.pinned = !item.pinned;
    
    // Update button INSTANTLY
    button.textContent = item.pinned ? 'üìå' : 'üìç';
    button.title = item.pinned ? 'Unpin dari atas' : 'Pin ke atas';
    
    // Move item ke posisi yang tepat tanpa full re-render
    const itemDiv = button.closest('.search-history-item');
    const container = document.getElementById('searchHistoryList');
    
    if (item.pinned) {
        // Pindah ke atas (setelah item pinned lainnya)
        const pinnedItems = container.querySelectorAll('.search-history-item');
        let insertAfter = null;
        
        for (let pinnedItem of pinnedItems) {
            const pinnedBtn = pinnedItem.querySelector('.search-history-pin');
            if (pinnedBtn && pinnedBtn.textContent === 'üìå' && pinnedItem !== itemDiv) {
                insertAfter = pinnedItem;
            } else {
                break;
            }
        }
        
        if (insertAfter) {
            container.insertBefore(itemDiv, insertAfter.nextSibling);
        } else {
            container.insertBefore(itemDiv, container.firstChild);
        }
    } else {
        // Pindah ke bawah (setelah semua item pinned)
        const allItems = container.querySelectorAll('.search-history-item');
        let lastPinned = null;
        
        for (let anyItem of allItems) {
            const anyBtn = anyItem.querySelector('.search-history-pin');
            if (anyBtn && anyBtn.textContent === 'üìå') {
                lastPinned = anyItem;
            }
        }
        
        if (lastPinned && lastPinned !== itemDiv) {
            container.insertBefore(itemDiv, lastPinned.nextSibling);
        }
    }
    
    // Save ke localStorage di background (non-blocking)
    saveSilently();
    
    // PASTIKAN PANEL TETAP TERBUKA - FORCE KEEP OPEN
    setTimeout(() => {
        const searchContainer = document.getElementById('searchContainer');
        const searchHistoryPanel = document.getElementById('searchHistory');
        if (searchContainer) searchContainer.classList.add('show');
        if (searchHistoryPanel) searchHistoryPanel.classList.add('show');
    }, 10);
}

// HANDLER INSTANT DELETE
function handleInstantDelete(e) {
    e.stopPropagation();
    e.preventDefault();
    
    const button = e.target;
    const itemText = button.getAttribute('data-text');
    const itemDiv = button.closest('.search-history-item');
    
    // Instant visual feedback
    itemDiv.style.transform = 'translateX(100%)';
    itemDiv.style.opacity = '0';
    itemDiv.style.transition = 'all 0.2s ease';
    
    // Remove dari DOM setelah animasi
    setTimeout(() => {
        if (itemDiv.parentNode) {
            itemDiv.remove();
        }
        
        // Cek jika tidak ada history lagi, tampilkan pesan kosong
        const container = document.getElementById('searchHistoryList');
        if (container && container.children.length === 0) {
            container.innerHTML = '<div style="padding: 10px; color: #666; text-align: center;">Belum ada riwayat</div>';
        }
    }, 200);
    
    // Remove dari data
    searchHistory = searchHistory.filter(h => h.text !== itemText);
    
    // Save di background
    saveSilently();
    
    // PASTIKAN PANEL TETAP TERBUKA - FORCE KEEP OPEN
    setTimeout(() => {
        const searchContainer = document.getElementById('searchContainer');
        const searchHistoryPanel = document.getElementById('searchHistory');
        if (searchContainer) searchContainer.classList.add('show');
        if (searchHistoryPanel) searchHistoryPanel.classList.add('show');
    }, 10);
}

// SILENT SAVE - Non-blocking
function saveSilently() {
    // Gunakan setTimeout 0 untuk non-blocking save
    setTimeout(() => {
        try {
            localStorage.setItem('quranSearchHistory', JSON.stringify(searchHistory));
        } catch (error) {
            console.error('Error saving search history:', error);
        }
    }, 0);
}

// TAMBAHKAN FUNGSI BARU ini (letakkan setelah renderSearchHistory):

function quickTogglePin(itemText) {
    const item = searchHistory.find(h => h.text === itemText);
    if (!item) return;
    
    item.pinned = !item.pinned;
    
    // Update button instantly
    const pinBtn = document.querySelector(`[data-text="${itemText}"] .search-history-pin`);
    if (pinBtn) {
        pinBtn.textContent = item.pinned ? 'üìå' : 'üìç';
        pinBtn.title = item.pinned ? 'Unpin dari atas' : 'Pin ke atas';
    }
    
    // Save asynchronously
    requestIdleCallback(() => {
        try {
            localStorage.setItem('quranSearchHistory', JSON.stringify(searchHistory));
        } catch (error) {
            console.error('Error saving search history:', error);
        }
    });
}

function clearSearchHistory() {
    const container = document.getElementById('searchHistoryList');
    
    // Instant clear visual
    if (container) {
        container.innerHTML = '<div style="padding: 10px; color: #666; text-align: center;">Belum ada riwayat</div>';
    }
    
    // Clear data
    searchHistory = [];
    
    // Save di background
    saveSilently();
    
    showSuccess('Riwayat pencarian berhasil dihapus'); // SUCCESS - RIGHT SIDE
    
    // PASTIKAN PANEL TETAP TERBUKA SETELAH CLEAR
    setTimeout(() => {
        const searchContainer = document.getElementById('searchContainer');
        const searchHistoryPanel = document.getElementById('searchHistory');
        if (searchContainer) searchContainer.classList.add('show');
        if (searchHistoryPanel) searchHistoryPanel.classList.add('show');
    }, 10);
}

// TAMBAHAN: FUNGSI UNTUK MEMASTIKAN PANEL TETAP TERBUKA
function keepSearchPanelOpen() {
    const searchContainer = document.getElementById('searchContainer');
    const searchHistory = document.getElementById('searchHistory');
    
    if (searchContainer) searchContainer.classList.add('show');
    if (searchHistory) searchHistory.classList.add('show');
}

// Initialize bookmarks from localStorage
function initBookmarks() {
    try {
        const saved = localStorage.getItem('quranBookmarks');
        bookmarks = saved ? JSON.parse(saved) : [];
    } catch (error) {
        console.error('Error loading bookmarks:', error);
        bookmarks = [];
    }
}

function updateBookmarkCount() {
    try {
        const countElement = document.getElementById('bookmarkCount');
        if (countElement) {
            countElement.textContent = bookmarks.length;
        }
    } catch (error) {
        console.error('Error updating bookmark count:', error);
    }
}

function showError(message) {
    try {
        const container = document.getElementById('surahContainer');
        if (container) {
            container.innerHTML = `
                <div class="error">
                    ‚ùå ${message}
                </div>
            `;
        }
        
        // Show error notification on LEFT
        showNotification(message, 'error');
        console.error('Error:', message);
    } catch (error) {
        console.error('Error showing error message:', error);
    }
}

// FUNGSI KHUSUS UNTUK SUCCESS NOTIFICATIONS  
function showSuccess(message) {
    showNotification(message, 'success');
}

// FUNGSI KHUSUS UNTUK WARNING NOTIFICATIONS
function showWarning(message) {
    try {
        const existing = document.querySelectorAll('.notification-warning');
        existing.forEach(n => n.remove());

        const notification = document.createElement('div');
        notification.className = 'notification notification-warning';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff9800;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 9999;
            animation: slideInTop 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
            border-top: 4px solid #f57c00;
            max-width: 350px;
            word-wrap: break-word;
        `;
        
        notification.textContent = '‚ö†Ô∏è ' + message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideOutTop 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }
        }, 4000);
        
        console.log('WARNING Notification:', message);
    } catch (error) {
        console.error('Error showing warning:', error);
    }
}

// TAMBAHKAN CSS ANIMATIONS baru untuk slide in/out
function addNotificationStyles() {
    const style = document.createElement('style');
    style.innerHTML = `
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutLeft {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(-100px);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100px);
            }
        }

        @keyframes slideInTop {
            from {
                opacity: 0;
                transform: translate(-50%, -50px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        @keyframes slideOutTop {
            from {
                opacity: 1;
                transform: translate(-50%, 0);
            }
            to {
                opacity: 0;
                transform: translate(-50%, -50px);
            }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .notification-error {
                left: 10px !important;
                right: auto !important;
                max-width: calc(100vw - 20px) !important;
            }
            
            .notification-success {
                right: 10px !important;
                left: auto !important;
                max-width: calc(100vw - 20px) !important;
            }
            
            .notification-warning {
                left: 50% !important;
                max-width: calc(100vw - 20px) !important;
            }
        }
    `;
    document.head.appendChild(style);
}

function showNotification(message, type = 'success') {
    try {
        // Remove existing notifications of the same type
        const existing = document.querySelectorAll(`.notification-${type}`);
        existing.forEach(n => n.remove());

        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        
        // Set position and color based on type
        if (type === 'error') {
            // Error notifications on the LEFT
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 20px;
                background: #f44336;
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 9999;
                animation: slideInLeft 0.3s ease;
                box-shadow: 0 5px 15px rgba(244, 67, 54, 0.3);
                border-left: 4px solid #d32f2f;
                max-width: 350px;
                word-wrap: break-word;
            `;
        } else {
            // Success notifications on the RIGHT (default)
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4caf50;
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 9999;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
                border-right: 4px solid #388e3c;
                max-width: 350px;
                word-wrap: break-word;
            `;
        }
        
        // Add icon based on type
        const icon = type === 'error' ? '‚ùå ' : '‚úÖ ';
        notification.textContent = icon + message;
        
        document.body.appendChild(notification);
        
        // Auto remove after delay (longer for errors)
        const delay = type === 'error' ? 5000 : 3000;
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = type === 'error' ? 'slideOutLeft 0.3s ease' : 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }
        }, delay);
        
        console.log(`${type.toUpperCase()} Notification:`, message);
    } catch (error) {
        console.error('Error showing notification:', error);
    }
}


// Initialize app
document.addEventListener('DOMContentLoaded', function() {
    addNotificationStyles();
    initializeAudioPlayer();
    console.log('DOM loaded, initializing app...');
    initBookmarks();
    loadSettings();
    loadSearchHistory();
    updateBookmarkCount();
    populateSurahSelect();
    
    // INISIALISASI PROGRESS BAR SYSTEM YANG BARU
    initializeProgressBar();
    
    setupEventListeners();
    updateAudioStatus(null);
    
    console.log('Enhanced app with working progress bar initialized!');
});

// Setup event listeners
function setupEventListeners() {
    // Surah selection change handler
    const surahSelect = document.getElementById('surah');
    if (surahSelect) {
        surahSelect.addEventListener('change', function() {
            console.log('Surah changed to:', this.value);
            updateNavigationButtons();
        });
    }

    // Load surah button
    const loadBtn = document.getElementById('loadSurahBtn');
    if (loadBtn) {
        loadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Load button clicked');
            loadSurah();
        });
    }

    // Search input enter key
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchVerse();
            }
        });

        searchInput.addEventListener('focus', () => {
            const historyPanel = document.getElementById('searchHistory');
            if (historyPanel) {
                renderSearchHistory();
                historyPanel.classList.add('show');
            }
        });

        searchInput.addEventListener('blur', (e) => {
            // Cek apakah yang akan difokuskan adalah elemen di dalam search area
            const relatedTarget = e.relatedTarget;
            if (relatedTarget) {
                const searchContainer = document.getElementById('searchContainer');
                const searchHistory = document.getElementById('searchHistory');
                
                // Jangan tutup jika yang diklik masih dalam area search
                if ((searchContainer && searchContainer.contains(relatedTarget)) ||
                    (searchHistory && searchHistory.contains(relatedTarget))) {
                    return;
                }
            }

    // Close search container when clicking outside
    setTimeout(() => {
                // Cek lagi apakah focus masih dalam area search
                const activeElement = document.activeElement;
                const searchContainer = document.getElementById('searchContainer');
                const searchHistory = document.getElementById('searchHistory');
                
                if (!((searchContainer && searchContainer.contains(activeElement)) ||
                      (searchHistory && searchHistory.contains(activeElement)))) {
                    const historyPanel = document.getElementById('searchHistory');
                    if (historyPanel) {
                        historyPanel.classList.remove('show');
                    }
                }
            }, 200);
        });
    }

        // IMPROVED CLICK OUTSIDE DETECTION
        document.addEventListener('click', function (e) {
        const searchContainer = document.getElementById('searchContainer');
        const searchBtn = document.querySelector('.search-container button');
        const searchHistory = document.getElementById('searchHistory');
        
        // Jangan tutup jika klik di dalam area search atau history
        if (searchContainer && searchContainer.contains(e.target)) return;
        if (searchBtn && searchBtn.contains(e.target)) return;
        if (searchHistory && searchHistory.contains(e.target)) return;
        
        // Tutup panel jika benar-benar klik di luar
        if (searchContainer) searchContainer.classList.remove('show');
        if (searchHistory) searchHistory.classList.remove('show');
    });

    // Close panels on escape key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeAllPanels();
        }
    });

    function addProgressEventListeners() {
    // Event listener untuk resize window
    window.addEventListener('resize', handleProgressOnResize);
    
    // Event listener untuk orientasi change (mobile)
    window.addEventListener('orientationchange', () => {
        setTimeout(handleProgressOnResize, 300);
    });
}
}

// PERBAIKAN 9: Fungsi khusus untuk scroll ke bagian tertentu
function scrollToSection(sectionClass, offset = 100) {
    const section = document.querySelector(sectionClass);
    if (section) {
        const elementTop = section.offsetTop;
        window.scrollTo({
            top: elementTop - offset,
            behavior: 'smooth'
        });
    }
}



// Load saved settings
function loadSettings() {
    try {
        const saved = localStorage.getItem('quranSettings');
        if (saved) {
            currentSettings = { ...currentSettings, ...JSON.parse(saved) };
            applySettings();
        }
    } catch (error) {
        console.error('Error loading settings:', error);
    }
}

// Save settings to localStorage
function saveSettings() {
    try {
        localStorage.setItem('quranSettings', JSON.stringify(currentSettings));
    } catch (error) {
        console.error('Error saving settings:', error);
    }
}

// Apply settings to UI
function applySettings() {
    try {
        // Apply theme
        if (currentSettings.darkTheme) {
            document.body.classList.add('dark-theme');
            const themeBtn = document.querySelector('.theme-toggle');
            if (themeBtn) themeBtn.textContent = '‚òÄÔ∏è';
        }

        // Apply font size
        document.querySelectorAll('.arabic').forEach(el => {
            el.className = el.className.replace(/\b(small|medium|large|xlarge)-text\b/, '');
            el.classList.add(currentSettings.fontSize + '-text');
        });

        // Update toggles
        const transliterationToggle = document.getElementById('transliterationToggle');
        const translationToggle = document.getElementById('translationToggle');
        const tajwidToggle = document.getElementById('tajwidToggle');
        const tajwidLegend = document.getElementById('tajwidLegend');
        
        if (transliterationToggle) {
            transliterationToggle.classList.toggle('active', currentSettings.showTransliteration);
        }
        if (translationToggle) {
            translationToggle.classList.toggle('active', currentSettings.showTranslation);
        }
        if (tajwidToggle) {
            tajwidToggle.classList.toggle('active', currentSettings.showTajwid);
        }
        if (tajwidLegend) {
            tajwidLegend.style.display = currentSettings.showTajwid ? 'grid' : 'none';
        }

        // Update font buttons
        document.querySelectorAll('.font-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        const activeFontBtn = document.querySelector(`[onclick="setFontSize('${currentSettings.fontSize}')"]`);
        if (activeFontBtn) activeFontBtn.classList.add('active');

        // Update language buttons
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        const activeLangBtn = document.querySelector(`[onclick="setLanguage('${currentSettings.language}')"]`);
        if (activeLangBtn) activeLangBtn.classList.add('active');

        // Update qari select
        const qariSelect = document.getElementById('qariSelect');
        if (qariSelect) qariSelect.value = currentSettings.qari;

        // Update Arabic text display
        updateArabicTextDisplay();
    } catch (error) {
        console.error('Error applying settings:', error);
    }
}

// Toggle tajwid
function toggleTajwid() {
    currentSettings.showTajwid = !currentSettings.showTajwid;
    const toggle = document.getElementById('tajwidToggle');
    const legend = document.getElementById('tajwidLegend');
    
    if (toggle) toggle.classList.toggle('active');
    if (legend) legend.style.display = currentSettings.showTajwid ? 'grid' : 'none';
    
    updateArabicTextDisplay();
    saveSettings();
}

// Update tampilan teks Arab dengan/tanpa tajwid
function updateArabicTextDisplay() {
    document.querySelectorAll('.arabic').forEach(el => {
        const surahNum = el.getAttribute('data-surah');
        const verseNum = el.getAttribute('data-verse');
        
        if (surahNum && verseNum) {
            if (currentSettings.showTajwid && tajwidData[surahNum] && tajwidData[surahNum][verseNum]) {
                el.innerHTML = tajwidData[surahNum][verseNum].tajwid;
            } else if (quranData[surahNum] && quranData[surahNum].verses[verseNum]) {
                el.innerHTML = quranData[surahNum].verses[verseNum].arabic;
            }
        }
    });
}

// Get Arabic Text with tajwid
function getArabicText(surahNum, verseNum) {
    if (currentSettings.showTajwid && tajwidData[surahNum] && tajwidData[surahNum][verseNum]) {
        return tajwidData[surahNum][verseNum].tajwid;
    }
    if (quranData[surahNum] && quranData[surahNum].verses[verseNum]) {
        return quranData[surahNum].verses[verseNum].arabic;
    }
    return '';
}

// Populate surah select
function populateSurahSelect() {
    try {
        const select = document.getElementById('surah');
        if (!select) {
            console.error('Surah select element not found');
            return;
        }
        
        select.innerHTML = '';
        
        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Pilih Surah...';
        select.appendChild(defaultOption);
        
        // Add surah options
        Object.keys(quranData).forEach(num => {
            const surah = quranData[num];
            const option = document.createElement('option');
            option.value = num;
            option.textContent = `${num}. ${surah.name} (${surah.arabicName})`;
            select.appendChild(option);
        });
        
        console.log('Surah select populated with', Object.keys(quranData).length, 'surahs');
        updateNavigationButtons();
    } catch (error) {
        console.error('Error populating surah select:', error);
    }
}

// Load surah
function loadSurah() {
    try {
        const surahSelect = document.getElementById('surah');
        const surahNumber = parseInt(surahSelect.value);
        
        if (!surahNumber || isNaN(surahNumber)) {
            showError('Silakan pilih surah terlebih dahulu');
            return;
        }
        
        currentSurah = surahNumber;
        
        const surah = quranData[surahNumber];
        if (!surah) {
            showError('Surah tidak ditemukan dalam database');
            return;
        }

        // RESET PROGRESS SEBELUM LOAD SURAH BARU
        resetProgress();

        // Update audio button
        const playBtn = document.getElementById('playAudioBtn');
        if (playBtn && quranData[currentSurah]) {
            playBtn.disabled = false;
            playBtn.textContent = `‚ñ∂Ô∏è Putar Surah ${quranData[currentSurah].name}`;
        }

        updateAudioStatus(currentSurah);
        
        console.log('Loading surah:', surah.name);
        displaySurah(surah, surahNumber);
        updateStatistics();
        updateNavigationButtons();
        closeAllPanels();
        
        // Scroll ke header surah setelah render
        setTimeout(() => {
            const surahHeader = document.querySelector('.surah-header');
            if (surahHeader) {
                const headerTop = surahHeader.offsetTop;
                window.scrollTo({ 
                    top: headerTop - 20,
                    behavior: 'smooth'
                });
            }
            
            // Update progress setelah scroll dan render selesai
            setTimeout(() => {
                updateReadingProgress();
            }, 800);
        }, 500);
        
        showSuccess(`Surah ${surah.name} berhasil dimuat`);
    } catch (error) {
        console.error('Error loading surah:', error);
        showError('Terjadi kesalahan saat memuat surah');
    }
}

// Display surah
function displaySurah(surah, surahNumber) {
    try {
        const container = document.getElementById('surahContainer');
        if (!container) {
            console.error('Surah container not found');
            return;
        }
        
        let html = `
            <div class="surah-header">
                <h2>${surah.name} - ${surah.arabicName}</h2>
                <p>Arti: ${surah.meaning} | Turun di: ${surah.revelation} | ${Object.keys(surah.verses).length} Ayat</p>
            </div>
        `;

        Object.keys(surah.verses).forEach(verseNum => {
            const verse = surah.verses[verseNum];
            const isBookmarked = bookmarks.some(b => b.surah === surahNumber && b.verse === parseInt(verseNum));
            
            html += `
                <div class="ayah-card" id="ayah-${surahNumber}-${verseNum}">
                    <div class="left-section">
                        <div class="ayah-number">Ayat ${verseNum}</div>
                        
                        ${currentSettings.showTransliteration ? `
                            <div class="transliteration" style="display: block;">
                                <h4>Transliterasi:</h4>
                                <p>${verse.transliteration}</p>
                            </div>
                        ` : `
                            <div class="transliteration" style="display: none;">
                                <h4>Transliterasi:</h4>
                                <p>${verse.transliteration}</p>
                            </div>
                        `}
                        
                        ${currentSettings.showTranslation ? `
                            <div class="translation" style="display: block;">
                                <h4>Terjemahan:</h4>
                                <p>${verse.translation}</p>
                            </div>
                        ` : `
                            <div class="translation" style="display: none;">
                                <h4>Terjemahan:</h4>
                                <p>${verse.translation}</p>
                            </div>
                        `}

                        <div class="verse-actions">
                            <button class="action-btn bookmark-btn ${isBookmarked ? 'bookmarked' : ''}" 
                                    onclick="toggleBookmark(${surahNumber}, ${verseNum})">
                                ${isBookmarked ? 'üîñ Tersimpan' : 'üîñ Simpan'}
                            </button>
                            <button class="action-btn" onclick="copyVerse(${surahNumber}, ${verseNum})">
                                üìã Salin
                            </button>
                            <button class="action-btn" onclick="shareVerse(${surahNumber}, ${verseNum})">
                                üì§ Bagikan
                            </button>
                            <button class="action-btn" onclick="playVerseAudio(${surahNumber}, ${verseNum})">
                                üîä Audio
                            </button>
                        </div>
                    </div>
                    
                    <div class="arabic-text">
                        <div class="arabic ${currentSettings.fontSize}-text" onclick="highlightVerse(${surahNumber}, ${verseNum})" data-surah="${surahNumber}" data-verse="${verseNum}">
                            ${getArabicText(surahNumber, verseNum)}
                        </div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
        console.log('Surah displayed successfully');
    } catch (error) {
        console.error('Error displaying surah:', error);
        showError('Terjadi kesalahan saat menampilkan surah');
    }
}

// Toggle theme
function toggleTheme() {
    currentSettings.darkTheme = !currentSettings.darkTheme;
    document.body.classList.toggle('dark-theme');
    const themeBtn = document.querySelector('.theme-toggle');
    if (themeBtn) {
        themeBtn.textContent = currentSettings.darkTheme ? '‚òÄÔ∏è' : 'üåô';
    }
    saveSettings();
}

// Font size controls
function setFontSize(size) {
    currentSettings.fontSize = size;
    document.querySelectorAll('.font-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.querySelector(`[onclick="setFontSize('${size}')"]`);
    if (activeBtn) activeBtn.classList.add('active');
    
    document.querySelectorAll('.arabic').forEach(el => {
        el.className = el.className.replace(/\b(small|medium|large|xlarge)-text\b/, '');
        el.classList.add(size + '-text');
    });
    
    saveSettings();
}

// Toggle transliteration
function toggleTransliteration() {
    currentSettings.showTransliteration = !currentSettings.showTransliteration;
    const toggle = document.getElementById('transliterationToggle');
    if (toggle) toggle.classList.toggle('active');
    
    document.querySelectorAll('.transliteration').forEach(el => {
        el.style.display = currentSettings.showTransliteration ? 'block' : 'none';
    });
    
    saveSettings();
}

// Toggle translation
function toggleTranslation() {
    currentSettings.showTranslation = !currentSettings.showTranslation;
    const toggle = document.getElementById('translationToggle');
    if (toggle) toggle.classList.toggle('active');
    
    document.querySelectorAll('.translation').forEach(el => {
        el.style.display = currentSettings.showTranslation ? 'block' : 'none';
    });
    
    saveSettings();
}

// Set language
function setLanguage(lang) {
    currentSettings.language = lang;
    document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.querySelector(`[onclick="setLanguage('${lang}')"]`);
    if (activeBtn) activeBtn.classList.add('active');
    saveSettings();
}

// Toggle settings panel
function toggleSettings() {
    const panel = document.getElementById('settingsPanel');
    const overlay = document.getElementById('overlay');
    
    if (panel && overlay) {
        panel.classList.toggle('show');
        overlay.classList.toggle('show');
    }
}

// Toggle search
function toggleSearch() {
    const container = document.getElementById('searchContainer');
    if (container) {
        container.classList.toggle('show');
        
        if (container.classList.contains('show')) {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.focus();
        }
    }
}

// Search verse
function searchVerse() {
    const searchInput = document.getElementById('searchInput');
    const query = searchInput ? searchInput.value.toLowerCase().trim() : '';
    
    if (!query) {
        showError('Masukkan kata kunci pencarian'); // ERROR - LEFT SIDE
        return;
    }
    
    // Add to search history
    addToSearchHistory(query);
    
    // Show loading
    const container = document.getElementById('surahContainer');
    if (container) {
        container.innerHTML = '<div class="loading">Mencari ayat...</div>';
    }

    // Close search container
    const searchContainer = document.getElementById('searchContainer');
    if (searchContainer) {
        searchContainer.classList.remove('show');
    }
    
    // Clear search input
    if (searchInput) {
        searchInput.value = '';
    }
    
    // Perform search with delay for UI responsiveness
    setTimeout(() => {
        searchResults = [];
        Object.keys(quranData).forEach(surahNum => {
            const surah = quranData[surahNum];
            Object.keys(surah.verses).forEach(verseNum => {
                const verse = surah.verses[verseNum];
                if (verse.translation.toLowerCase().includes(query) || 
                    verse.transliteration.toLowerCase().includes(query) ||
                    verse.arabic.includes(query)) {
                    searchResults.push({
                        surah: parseInt(surahNum),
                        verse: parseInt(verseNum),
                        surahName: surah.name
                    });
                }
            });
        });
        
        if (searchResults.length === 0) {
            showError(`Tidak ditemukan ayat dengan kata kunci "${query}"`); // ERROR - LEFT SIDE
        } else {
            showSuccess(`Ditemukan ${searchResults.length} ayat untuk "${query}"`); // SUCCESS - RIGHT SIDE
        }
        
        displaySearchResults();
        
        // Auto-scroll to search results
        setTimeout(() => {
            const surahContainer = document.getElementById('surahContainer');
            if (surahContainer) {
                surahContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }, 100);
    }, 300);
}

// Display search results
function displaySearchResults() {
    const container = document.getElementById('surahContainer');
    if (!container) return;

    if (searchResults.length === 0) {
        showError('Tidak ada hasil pencarian yang ditemukan'); // ERROR - LEFT SIDE
        return;
    }
    
    let html = `
        <div class="surah-header">
            <h2>üîç Hasil Pencarian</h2>
            <p>Ditemukan ${searchResults.length} ayat</p>
        </div>
    `;
    
    searchResults.forEach(result => {
        const verse = quranData[result.surah].verses[result.verse];
        const isBookmarked = bookmarks.some(b => b.surah === result.surah && b.verse === result.verse);
        
        html += `
            <div class="ayah-card highlight" id="ayah-${result.surah}-${result.verse}">
                <div class="left-section">
                    <div class="ayah-number">${result.surahName} - Ayat ${result.verse}</div>
                    <div class="transliteration">
                        <h4>Transliterasi:</h4>
                        <p>${verse.transliteration}</p>
                    </div>
                    <div class="translation">
                        <h4>Terjemahan:</h4>
                        <p>${verse.translation}</p>
                    </div>
                    <div class="verse-actions">
                        <button class="action-btn" onclick="goToVerse(${result.surah}, ${result.verse})">
                            üìñ Lihat Surah
                        </button>
                        <button class="action-btn bookmark-btn ${isBookmarked ? 'bookmarked' : ''}" 
                                onclick="toggleBookmark(${result.surah}, ${result.verse})">
                            ${isBookmarked ? 'üîñ Tersimpan' : 'üîñ Simpan'}
                        </button>
                    </div>
                </div>
                <div class="arabic-text">
                    <div class="arabic ${currentSettings.fontSize}-text">
                        ${getArabicText(result.surah, result.verse)}
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Go to specific verse
function goToVerse(surahNum, verseNum) {
    const surahSelect = document.getElementById('surah');
    if (surahSelect) {
        surahSelect.value = surahNum;
        currentSurah = surahNum;
        loadSurah();
        
        setTimeout(() => {
            const element = document.getElementById(`ayah-${surahNum}-${verseNum}`);
            if (element) {
                // Scroll ke ayah dengan offset yang lebih baik
                const elementTop = element.offsetTop;
                const offset = 120; // Offset dari atas
                
                window.scrollTo({
                    top: elementTop - offset,
                    behavior: 'smooth'
                });
                
                // Highlight ayah
                element.classList.add('highlight');
                setTimeout(() => element.classList.remove('highlight'), 4000);
                
                // Update progress setelah scroll
                setTimeout(() => {
                    updateReadingProgress();
                }, 1000);
            }
        }, 1000); // Delay lebih lama untuk memastikan rendering selesai
    }
}

// 9. FUNGSI INITIALIZATION YANG LENGKAP
function initializeProgressBar() {
    console.log('Initializing Progress Bar System...');
    
    // Setup scroll handler
    setupScrollHandler();
    
    // Force update progress setelah DOM benar-benar ready
    if (document.readyState === 'complete') {
        setTimeout(() => {
            updateReadingProgress();
        }, 1500);
    } else {
        window.addEventListener('load', () => {
            setTimeout(() => {
                updateReadingProgress();
            }, 1500);
        });
    }
    
    // Observer untuk perubahan DOM (ketika ayah cards ditambahkan)
    if (typeof MutationObserver !== 'undefined') {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    // Cek apakah ada ayah card yang ditambahkan
                    const hasAyahCard = Array.from(mutation.addedNodes).some(node => 
                        node.nodeType === 1 && (
                            node.classList.contains('ayah-card') || 
                            node.querySelector('.ayah-card')
                        )
                    );
                    
                    if (hasAyahCard) {
                        setTimeout(() => {
                            updateReadingProgress();
                        }, 500);
                    }
                }
            });
        });
        
        // Observe perubahan di surah container
        const surahContainer = document.getElementById('surahContainer');
        if (surahContainer) {
            observer.observe(surahContainer, {
                childList: true,
                subtree: true
            });
        }
    }
    
    console.log('Progress Bar System initialized successfully');
}

// 10. FUNGSI UNTUK FORCE UPDATE PROGRESS (UNTUK DEBUGGING)
function forceUpdateProgress() {
    console.log('Force updating progress...');
    updateReadingProgress();
}

function handleProgressOnResize() {
    setTimeout(() => {
        updateReadingProgress();
    }, 200);
}

// PERBAIKAN 7: Tambahkan fungsi ini untuk reset progress saat ganti surah
function resetProgress() {
    const progressFill = document.getElementById('progressFill');
    const progressElement = document.getElementById('readingProgress');
    
    if (progressFill) {
        progressFill.style.width = '0%';
        progressFill.style.transition = 'width 0.3s ease';
    }
    if (progressElement) {
        progressElement.textContent = '0%';
    }
    
    console.log('Progress reset to 0%');
}

// Bookmark functions
function toggleBookmark(surahNum, verseNum) {
    const index = bookmarks.findIndex(b => b.surah === surahNum && b.verse === verseNum);
    
    if (index > -1) {
        bookmarks.splice(index, 1);
        showSuccess('Bookmark berhasil dihapus'); // SUCCESS - RIGHT SIDE
    } else {
        const surah = quranData[surahNum];
        if (surah && surah.verses[verseNum]) {
            bookmarks.push({
                surah: surahNum,
                verse: verseNum,
                surahName: surah.name,
                text: surah.verses[verseNum].translation
            });
            showSuccess('Bookmark berhasil ditambahkan'); // SUCCESS - RIGHT SIDE
        }
    }
    
    try {
        localStorage.setItem('quranBookmarks', JSON.stringify(bookmarks));
    } catch (error) {
        console.error('Error saving bookmarks:', error);
        showError('Gagal menyimpan bookmark'); // ERROR - LEFT SIDE
    }
    
    updateBookmarkCount();
    updateBookmarkButton(surahNum, verseNum);
    displayBookmarks();
}

function updateBookmarkButton(surahNum, verseNum) {
    const isBookmarked = bookmarks.some(b => b.surah === surahNum && b.verse === verseNum);
    const button = document.querySelector(`#ayah-${surahNum}-${verseNum} .bookmark-btn`);
    
    if (button) {
        button.classList.toggle('bookmarked', isBookmarked);
        button.textContent = isBookmarked ? 'üîñ Tersimpan' : 'üîñ Simpan';
    }
}

function toggleBookmarks() {
    const panel = document.getElementById('bookmarksPanel');
    const overlay = document.getElementById('overlay');
    
    if (panel && overlay) {
        panel.classList.toggle('open');
        overlay.classList.toggle('show');
        
        if (panel.classList.contains('open')) {
            displayBookmarks();
        }
    }
}

function displayBookmarks() {
    const container = document.getElementById('bookmarksList');
    if (!container) return;
    
    if (bookmarks.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Belum ada bookmark</div>';
        return;
    }

    let html = '';
    bookmarks.forEach(bookmark => {
        html += `
            <div class="bookmark-item" onclick="goToVerse(${bookmark.surah}, ${bookmark.verse})">
                <h4>${bookmark.surahName} - Ayat ${bookmark.verse}</h4>
                <p>${bookmark.text.substring(0, 100)}...</p>
                <button onclick="event.stopPropagation(); removeBookmark(${bookmark.surah}, ${bookmark.verse})" 
                        style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; margin-top: 10px;">
                    üóëÔ∏è Hapus
                </button>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function removeBookmark(surahNum, verseNum) {
    toggleBookmark(surahNum, verseNum);
}

// Audio functions
function playAudio() {
    if (!currentSurah || !quranData[currentSurah]) {
        showError("Silakan pilih surah terlebih dahulu"); // ERROR - LEFT SIDE
        return;
    }

    const surah = quranData[currentSurah];
    const ayatKeys = Object.keys(surah.verses).map(Number);
    autoPlayQueue = ayatKeys.map(n => ({ surah: currentSurah, ayah: n }));
    currentAutoIndex = 0;

    showSuccess(`Memulai audio Surah ${surah.name}`); // SUCCESS - RIGHT SIDE
    playNextInQueue();
}

function getFormattedAyahNumber(surah, ayah) {
    return String(surah).padStart(3, '0') + String(ayah).padStart(3, '0');
}

function playVerseAudio(surahNum, verseNum) {
    const surah = quranData[surahNum];
    if (!surah || !surah.verses[verseNum]) {
        showNotification("‚ùå Ayat tidak ditemukan.");
        return;
    }

    // Prepare list of all verses from current verse to end of surah
    const ayatKeys = Object.keys(surah.verses).map(Number).filter(n => n >= verseNum);
    autoPlayQueue = ayatKeys.map(n => ({ surah: surahNum, ayah: n }));
    currentAutoIndex = 0;

    playNextInQueue();
}


// FUNGSI AUDIO
function playNextInQueue() {
    if (currentAutoIndex >= autoPlayQueue.length) {
        showSuccess("‚úÖ Semua ayat selesai diputar.");
        closeAudioPlayer();
        currentAudio = null;
        autoPlayQueue = [];
        currentAutoIndex = 0;
        return;
    }

    const item = autoPlayQueue[currentAutoIndex];
    const surah = item.surah;
    const ayah = item.ayah;

    const qariMap = {
        'abdul-basit': 'AbdulBaset',
        'al-husary': 'Husary',
        'al-minshawi': 'Minshawi',
        'al-huzaifi': 'Hudzaifi',
        'aziz-alili': 'AzizAlili',
        'mishari-alafasy': 'Alafasy',
        'saad-al-ghamidi': 'SaadAlGhamdi',
        'saud-ash-shuraym': 'Shuraym'
    };

    const qariRaw = currentSettings.qari;
    const qari = qariMap[qariRaw] || 'AbdulBaset';

    const formattedNum = getFormattedAyahNumber(surah, ayah);
    const url = `https://verses.quran.com/${qari}/Mujawwad/mp3/${formattedNum}.mp3`;

    if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
    }

    currentAudio = new Audio(url);

        // Set audio properties
        currentAudio.playbackRate = audioPlayer.currentSpeed;
    currentAudio.volume = audioPlayer.isMuted ? 0 : audioPlayer.volume;
    
    // Update volume slider to reflect current volume
    const volumeSlider = document.getElementById('volumeSlider');
    if (volumeSlider) {
        volumeSlider.value = audioPlayer.isMuted ? 0 : audioPlayer.volume;
    }
    
    // Set audio properties
    currentAudio.playbackRate = audioPlayer.currentSpeed;
    currentAudio.volume = audioPlayer.isMuted ? 0 : audioPlayer.volume;
    
    // Show audio player
    if (!audioPlayer.isVisible) {
        showAudioPlayer();
    }
    
    // Update player info
    const totalVerses = Object.keys(quranData[surah].verses).length;
    updatePlayerInfo(quranData[surah].name, ayah, totalVerses);
    
    currentAudio.play().then(() => {
        const playPauseBtn = document.getElementById('playPauseBtn');
        if (playPauseBtn) playPauseBtn.textContent = '‚è∏Ô∏è';
        
        // Highlight current verse being played
        const currentVerse = document.getElementById(`ayah-${surah}-${ayah}`);
        if (currentVerse) {
            // Remove previous highlights
            document.querySelectorAll('.ayah-card.highlight').forEach(el => {
                el.classList.remove('highlight');
            });
            // Add highlight to current verse
            currentVerse.classList.add('highlight');
            currentVerse.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }).catch((error) => {
        console.error('Audio playback error:', error);
        showError("‚ùå Gagal memutar audio. Melanjutkan ke ayat berikutnya...");
        // Continue to next verse even if current fails
        currentAutoIndex++;
        setTimeout(() => playNextInQueue(), 1000);
    });

    // Audio event listeners
    currentAudio.addEventListener('timeupdate', updateAudioProgress);
    
    currentAudio.addEventListener('ended', () => {
        currentAutoIndex++;
        setTimeout(() => playNextInQueue(), 500);
    });

    currentAudio.addEventListener('error', () => {
        console.error('Audio loading error for:', url);
        showError(`Gagal memuat audio ayat ${ayah}`);
        currentAutoIndex++;
        setTimeout(() => playNextInQueue(), 1000);
    });
    
    currentAudio.addEventListener('pause', () => {
        const playPauseBtn = document.getElementById('playPauseBtn');
        if (playPauseBtn) playPauseBtn.textContent = '‚ñ∂Ô∏è';
    });
    
    currentAudio.addEventListener('play', () => {
        const playPauseBtn = document.getElementById('playPauseBtn');
        if (playPauseBtn) playPauseBtn.textContent = '‚è∏Ô∏è';
    });
}

// SETUP VOLUME SLIDER
function setupVolumeSlider() {
    const volumeSlider = document.getElementById('volumeSlider');
    if (!volumeSlider) {
        console.error('Volume slider not found');
        return;
    }
    
    console.log('Setting up volume slider...');
    
    // Remove existing listeners first
    volumeSlider.removeEventListener('input', handleVolumeChange);
    volumeSlider.removeEventListener('change', handleVolumeChange);
    
    // Add event listeners
    volumeSlider.addEventListener('input', handleVolumeChange);
    volumeSlider.addEventListener('change', handleVolumeChange);
    
    console.log('Volume slider setup complete');
}

function handleVolumeChange(e) {
    const newVolume = parseFloat(e.target.value);
    console.log('Volume changed to:', newVolume);
    
    audioPlayer.volume = newVolume;
    audioPlayer.isMuted = newVolume === 0;
    
    if (currentAudio) {
        currentAudio.volume = newVolume;
        console.log('Audio volume set to:', currentAudio.volume);
    }
    
    const muteBtn = document.getElementById('muteBtn');
    if (muteBtn) {
        muteBtn.textContent = newVolume === 0 ? 'üîá' : 'üîä';
    }
}

// INISIALISASI AUDIO PLAYER
function initializeAudioPlayer() {
    addAudioPlayerStyles();
    createAudioPlayer();
    // Setup volume slider setelah element dibuat
    setTimeout(() => {
        setupVolumeSlider();
    }, 100);
}

// Utility functions
function copyVerse(surahNum, verseNum) {
    const verse = quranData[surahNum].verses[verseNum];
    const surah = quranData[surahNum];
    const text = `${surah.name} - Ayat ${verseNum}\n\n${verse.arabic}\n\n${verse.transliteration}\n\n${verse.translation}`;
    
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
            showNotification('Ayat berhasil disalin!');
        }).catch(() => {
            // Fallback for older browsers
            fallbackCopyText(text);
        });
    } else {
        fallbackCopyText(text);
    }
}

function fallbackCopyText(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showNotification('Ayat berhasil disalin!');
    } catch (err) {
        console.error('Fallback copy failed:', err);
        showNotification('Gagal menyalin ayat');
    }
    
    document.body.removeChild(textArea);
}

function shareVerse(surahNum, verseNum) {
    const verse = quranData[surahNum].verses[verseNum];
    const surah = quranData[surahNum];
    const text = `${surah.name} - Ayat ${verseNum}\n\n${verse.arabic}\n\n${verse.transliteration}\n\n${verse.translation}`;
    
    if (navigator.share) {
        navigator.share({
            title: `${surah.name} - Ayat ${verseNum}`,
            text: text
        }).catch((error) => {
            console.error('Share failed:', error);
            copyVerse(surahNum, verseNum);
            showNotification('Ayat disalin, silakan bagikan secara manual');
        });
    } else {
        copyVerse(surahNum, verseNum);
        showNotification('Ayat disalin, silakan bagikan secara manual');
    }
}

function highlightVerse(surahNum, verseNum) {
    const element = document.getElementById(`ayah-${surahNum}-${verseNum}`);
    if (element) {
        element.classList.add('highlight');
        setTimeout(() => element.classList.remove('highlight'), 2000);
    }
}

// Navigation functions
function previousSurah() {
    const surahSelect = document.getElementById('surah');
    const currentValue = parseInt(surahSelect.value);
    
    if (currentValue && currentValue > 1) {
        const surahKeys = Object.keys(quranData).map(Number).sort((a, b) => a - b);
        const currentIndex = surahKeys.indexOf(currentValue);
        if (currentIndex > 0) {
            const prevSurah = surahKeys[currentIndex - 1];
            surahSelect.value = prevSurah;
            currentSurah = prevSurah;
            resetProgress(); // Reset progress dulu
            loadSurah();
        }
    }
}

// 7. GANTI FUNGSI nextSurah() DENGAN INI
function nextSurah() {
    const surahSelect = document.getElementById('surah');
    const currentValue = parseInt(surahSelect.value);
    
    if (currentValue) {
        const surahKeys = Object.keys(quranData).map(Number).sort((a, b) => a - b);
        const currentIndex = surahKeys.indexOf(currentValue);
        if (currentIndex < surahKeys.length - 1) {
            const nextSurah = surahKeys[currentIndex + 1];
            surahSelect.value = nextSurah;
            currentSurah = nextSurah;
            resetProgress(); // Reset progress dulu
            loadSurah();
        }
    }
}

function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const surahSelect = document.getElementById('surah');
    const selectedSurah = parseInt(surahSelect.value);

    if (selectedSurah && prevBtn && nextBtn) {
        const surahKeys = Object.keys(quranData).map(Number).sort((a, b) => a - b);
        const currentIndex = surahKeys.indexOf(selectedSurah);
        const prevSurahKey = surahKeys[currentIndex - 1];
        const nextSurahKey = surahKeys[currentIndex + 1];

        if (prevSurahKey && quranData[prevSurahKey]) {
            prevBtn.textContent = `‚Üê ${quranData[prevSurahKey].name}`;
            prevBtn.disabled = false;
        } else {
            prevBtn.textContent = '‚Üê Surah Pertama';
            prevBtn.disabled = true;
        }

        if (nextSurahKey && quranData[nextSurahKey]) {
            nextBtn.textContent = `${quranData[nextSurahKey].name} ‚Üí`;
            nextBtn.disabled = false;
        } else {
            nextBtn.textContent = 'Surah Terakhir ‚Üí';
            nextBtn.disabled = true;
        }
    } else {
        if (prevBtn) {
            prevBtn.textContent = '‚Üê Surah Sebelumnya';
            prevBtn.disabled = true;
        }
        if (nextBtn) {
            nextBtn.textContent = 'Surah Selanjutnya ‚Üí';
            nextBtn.disabled = true;
        }
    }
}

// Statistics and progress
function updateStatistics() {
    try {
        const surah = quranData[currentSurah];
        if (!surah) return;
        
        const totalVerses = Object.keys(surah.verses).length;
        const totalAyahsElement = document.getElementById('totalAyahs');
        
        if (totalAyahsElement) {
            totalAyahsElement.textContent = totalVerses;
        }
        
        // Reset progress saat load surah baru
        resetProgress();
        
        // Update progress setelah render selesai (delay lebih lama)
        setTimeout(() => {
            updateReadingProgress();
        }, 1200);
        
    } catch (error) {
        console.error('Error updating statistics:', error);
    }
}

// Scroll functions
function setupScrollHandler() {
    let ticking = false;
    
    function updateOnScroll() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollBtn = document.getElementById('scrollTopBtn');
        
        // Update scroll to top button
        if (scrollBtn) {
            scrollBtn.style.display = scrollTop > 500 ? 'block' : 'none';
        }
        
        // Update reading progress
        updateReadingProgress();
        
        ticking = false;
    }
    
    // Event scroll dengan throttling
    window.addEventListener('scroll', () => {
        if (!ticking) {
            requestAnimationFrame(updateOnScroll);
            ticking = true;
        }
    }, { passive: true });
    
    // Event resize untuk update progress
    window.addEventListener('resize', () => {
        setTimeout(() => {
            updateReadingProgress();
        }, 300);
    });
    
    // Initial progress update setelah DOM ready
    setTimeout(() => {
        updateReadingProgress();
        console.log('Progress bar initialized successfully');
    }, 1000);
}

function updateReadingProgress() {
    try {
        const progressFill = document.getElementById('progressFill');
        const progressElement = document.getElementById('readingProgress');
        
        if (!progressFill || !progressElement) {
            console.log('Progress elements not found');
            return;
        }
        
        // Ambil semua ayah cards yang ada di halaman
        const ayahCards = document.querySelectorAll('.ayah-card');
        if (ayahCards.length === 0) {
            progressFill.style.width = '0%';
            progressElement.textContent = '0%';
            return;
        }
        
        const windowHeight = window.innerHeight;
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const viewportCenter = scrollTop + (windowHeight / 2);
        
        let readAyahs = 0;
        const totalAyahs = ayahCards.length;
        
        // Hitung ayah yang sudah terbaca (melewati tengah viewport)
        ayahCards.forEach((card) => {
            const rect = card.getBoundingClientRect();
            const cardTop = rect.top + scrollTop;
            
            // Ayah dianggap terbaca jika sudah melewati tengah viewport
            if (cardTop < viewportCenter) {
                readAyahs++;
            }
        });
        
        // Hitung persentase
        const progress = Math.min(100, Math.max(0, Math.floor((readAyahs / totalAyahs) * 100)));
        
        // Update UI dengan animasi smooth
        progressFill.style.width = progress + '%';
        progressElement.textContent = progress + '%';
        
        // Debug info
        console.log(`Progress Update: ${progress}% (${readAyahs}/${totalAyahs} ayat)`);
        
    } catch (error) {
        console.error('Error updating reading progress:', error);
    }
}

function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

// Close all panels
// Close all panels
function closeAllPanels() {
    try {
        const panels = [
            'settingsPanel',
            'searchContainer',
            'bookmarksPanel',
            'progressPanel',
            'overlay'
        ];
        
        panels.forEach(panelId => {
            const panel = document.getElementById(panelId);
            if (panel) {
                if (panelId === 'bookmarksPanel' || panelId === 'progressPanel') {
                    panel.classList.remove('open');
                } else {
                    panel.classList.remove('show');
                }
            }
        });

        // Also hide search history
        const searchHistory = document.getElementById('searchHistory');
        if (searchHistory) {
            searchHistory.classList.remove('show');
        }
    } catch (error) {
        console.error('Error closing panels:', error);
    }
}

// Error handling for missing elements
function safeGetElement(id) {
    const element = document.getElementById(id);
    if (!element) {
        console.warn(`Element with id '${id}' not found`);
    }
    return element;
}

// Initialize error handlers
window.addEventListener('error', function(event) {
    console.error('Global error:', event.error);
    showNotification('Terjadi kesalahan pada aplikasi');
});

window.addEventListener('unhandledrejection', function(event) {
    console.error('Unhandled promise rejection:', event.reason);
    showNotification('Terjadi kesalahan jaringan');
});

// Responsive handling
function handleResize() {
    // Adjust panels for mobile
    const settingsPanel = document.getElementById('settingsPanel');
    const bookmarksPanel = document.getElementById('bookmarksPanel');
    
    if (window.innerWidth <= 768) {
        if (settingsPanel) {
            settingsPanel.style.width = '65vw';
            settingsPanel.style.right = '13vw';
        }
        if (bookmarksPanel) {
            bookmarksPanel.style.width = '41vw';
        }
    } else {
        if (settingsPanel) {
            settingsPanel.style.width = '400px';
            settingsPanel.style.right = '20px';
        }
        if (bookmarksPanel) {
            bookmarksPanel.style.width = '400px';
        }
    }
}

window.addEventListener('resize', handleResize);

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + F for search
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        toggleSearch();
    }
    
    // Escape to close panels
    if (e.key === 'Escape') {
        closeAllPanels();
    }
    
    // Arrow keys for navigation (when not in input fields)
    if (!e.target.matches('input, textarea, select')) {
        if (e.key === 'ArrowLeft') {
            previousSurah();
        } else if (e.key === 'ArrowRight') {
            nextSurah();
        }
    }
    
    // Space for play/pause audio (when not in input fields)
    if (e.key === ' ' && !e.target.matches('input, textarea, select')) {
        e.preventDefault();
        if (currentAudio && !currentAudio.paused) {
            pauseAudio();
        } else if (currentSurah) {
            playAudio();
        }
    }
});

// TAMBAHKAN CSS untuk Modern Audio Player
function addAudioPlayerStyles() {
    const style = document.createElement('style');
    style.innerHTML = `
        /* Modern Audio Player Styles */
        .modern-audio-player {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 10000;
            box-shadow: 0 2px 20px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .modern-audio-player.show {
            display: flex;
            animation: slideDownPlayer 0.3s ease;
        }

        @keyframes slideDownPlayer {
            from {
                opacity: 0;
                transform: translateY(-100%);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .audio-player-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .audio-player-info {
            flex: 1;
            min-width: 0;
        }

        .audio-player-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .audio-player-subtitle {
            font-size: 12px;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .audio-player-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .audio-control-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .audio-control-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .audio-control-btn.play-pause {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.9);
            color: #667eea;
            font-size: 18px;
        }

        .audio-control-btn.play-pause:hover {
            background: white;
            transform: scale(1.05);
        }

        .speed-control {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .speed-control:hover {
            background: rgba(255,255,255,0.3);
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
        }

        .volume-slider {
            width: 100px;
            height: 8px; /* Lebih tebal untuk garis putih yang jelas */
            background: rgba(255,255,255,0.8); /* Background putih lebih terang */
            border-radius: 4px;
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            border: 1px solid rgba(255,255,255,0.9); /* Border putih */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); /* Shadow dalam untuk efek 3D */
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: white;
            border: 2px solid #667eea; /* Border biru */
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }

        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            border-color: #764ba2;
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
        }

        .volume-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .volume-slider::-moz-range-track {
            height: 8px;
            background: rgba(255,255,255,0.8);
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.9);
        }

        .volume-slider::-ms-thumb {
            width: 18px;
            height: 18px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 50%;
            cursor: pointer;
        }

        .volume-slider::-ms-track {
            height: 8px;
            background: rgba(255,255,255,0.8);
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.9);
            color: transparent;
        }

        /* Efek saat slider aktif/fokus */
        .volume-slider:focus {
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2), 
                        0 0 8px rgba(102, 126, 234, 0.5);
        }

        /* Desktop - slider lebih panjang */
        @media (min-width: 1024px) {
            .volume-container {
                min-width: 160px;
            }
            
            .volume-slider {
                width: 120px;
            }
        }

        /* Mobile - sembunyikan */
        @media (max-width: 768px) {
            .volume-container {
                display: none;
            }
        }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .time-display {
            font-size: 11px;
            opacity: 0.9;
            white-space: nowrap;
        }

        .close-player {
            width: 28px;
            height: 28px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .close-player:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .modern-audio-player {
                padding: 10px 15px;
                gap: 10px;
            }

            .audio-player-icon {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }

            .audio-player-title {
                font-size: 13px;
            }

            .audio-player-subtitle {
                font-size: 11px;
            }

            .audio-control-btn {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }

            .audio-control-btn.play-pause {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }

            .volume-container {
                display: none;
            }

            .progress-container {
                min-width: 80px;
            }

            .speed-control {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .modern-audio-player {
                padding: 8px 12px;
                gap: 8px;
            }

            .progress-container {
                min-width: 60px;
            }

            .time-display {
                font-size: 10px;
            }
        }
    `;
    document.head.appendChild(style);
}

// TAMBAHKAN HTML Audio Player ke body
function createAudioPlayer() {
    const playerHTML = `
        <div class="modern-audio-player" id="modernAudioPlayer">
            <div class="audio-player-icon">
                üìñ
            </div>
            
            <div class="audio-player-info">
                <div class="audio-player-title" id="audioPlayerTitle">Putar Surah</div>
                <div class="audio-player-subtitle" id="audioPlayerSubtitle">Al-Fatihah - 1/7</div>
            </div>
            
            <div class="audio-player-controls">
                <button class="audio-control-btn" onclick="seekBackward()" title="Mundur 10 detik">
                    ‚è™
                </button>
                
                <button class="audio-control-btn play-pause" onclick="togglePlayPause()" id="playPauseBtn" title="Play/Pause">
                    ‚ñ∂Ô∏è
                </button>
                
                <button class="audio-control-btn" onclick="seekForward()" title="Maju 10 detik">
                    ‚è©
                </button>
                
                <button class="speed-control" onclick="togglePlaybackSpeed()" id="speedControl" title="Kecepatan Putar">
                    1.0x
                </button>
            </div>
            
            <div class="volume-container">
                <button class="audio-control-btn" onclick="toggleMute()" id="muteBtn" title="Mute/Unmute">
                    üîä
                </button>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.1" value="1">
            </div>
            
            <div class="progress-container">
                <div class="progress-bar" onclick="seekToPosition(event)" id="audioProgressBar">
                    <div class="progress-fill" id="audioProgressFill"></div>
                </div>
                <div class="time-display" id="timeDisplay">0:00/0:00</div>
            </div>
            
            <button class="close-player" onclick="closeAudioPlayer()" title="Tutup Player">
                ‚úï
            </button>
        </div>
    `;
    
    document.body.insertAdjacentHTML('afterbegin', playerHTML);
}

// FUNGSI KONTROL AUDIO PLAYER
function showAudioPlayer() {
    const player = document.getElementById('modernAudioPlayer');
    if (player) {
        player.classList.add('show');
        audioPlayer.isVisible = true;
        
        // Push down main content
        const container = document.querySelector('.container');
        if (container) {
            container.style.marginTop = '70px';
            container.style.transition = 'margin-top 0.3s ease';
        }
    }
}

function closeAudioPlayer() {
    const player = document.getElementById('modernAudioPlayer');
    if (player) {
        player.classList.remove('show');
        audioPlayer.isVisible = false;
        
        // Reset main content position
        const container = document.querySelector('.container');
        if (container) {
            container.style.marginTop = '0';
        }
        
        // Stop current audio
        if (currentAudio) {
            currentAudio.pause();
            currentAudio = null;
            autoPlayQueue = [];
            currentAutoIndex = 0;
        }
    }
}

function togglePlayPause() {
    const btn = document.getElementById('playPauseBtn');
    
    if (!currentAudio) {
        // Start new audio if none playing
        if (currentSurah && quranData[currentSurah]) {
            playAudio();
        } else {
            showError('Silakan pilih surah terlebih dahulu');
        }
        return;
    }
    
    if (currentAudio.paused) {
        currentAudio.play();
        btn.textContent = '‚è∏Ô∏è';
    } else {
        currentAudio.pause();
        btn.textContent = '‚ñ∂Ô∏è';
    }
}

function seekBackward() {
    if (currentAudio) {
        currentAudio.currentTime = Math.max(0, currentAudio.currentTime - 10);
    }
}

function seekForward() {
    if (currentAudio) {
        currentAudio.currentTime = Math.min(currentAudio.duration || 0, currentAudio.currentTime + 10);
    }
}

function togglePlaybackSpeed() {
    audioPlayer.speedIndex = (audioPlayer.speedIndex + 1) % audioPlayer.speeds.length;
    audioPlayer.currentSpeed = audioPlayer.speeds[audioPlayer.speedIndex];
    
    const speedBtn = document.getElementById('speedControl');
    speedBtn.textContent = audioPlayer.currentSpeed + 'x';
    
    if (currentAudio) {
        currentAudio.playbackRate = audioPlayer.currentSpeed;
    }
}

function toggleMute() {
    const muteBtn = document.getElementById('muteBtn');
    const volumeSlider = document.getElementById('volumeSlider');
    
    if (!muteBtn || !volumeSlider) return;
    
    audioPlayer.isMuted = !audioPlayer.isMuted;
    
    if (audioPlayer.isMuted) {
        // Mute: simpan volume saat ini dan set ke 0
        audioPlayer.volume = audioPlayer.volume > 0 ? audioPlayer.volume : 1.0;
        muteBtn.textContent = 'üîá';
        volumeSlider.value = 0;
        if (currentAudio) currentAudio.volume = 0;
    } else {
        // Unmute: kembalikan ke volume sebelumnya
        muteBtn.textContent = 'üîä';
        volumeSlider.value = audioPlayer.volume;
        if (currentAudio) currentAudio.volume = audioPlayer.volume;
    }
    
    console.log('Mute toggled:', audioPlayer.isMuted, 'Volume:', audioPlayer.volume);
}

function seekToPosition(event) {
    if (!currentAudio || !currentAudio.duration) return;
    
    const progressBar = event.currentTarget;
    const rect = progressBar.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const percentage = clickX / rect.width;
    
    currentAudio.currentTime = currentAudio.duration * percentage;
}

function updateAudioProgress() {
    if (!currentAudio) return;
    
    const progressFill = document.getElementById('audioProgressFill');
    const timeDisplay = document.getElementById('timeDisplay');
    
    if (currentAudio.duration) {
        const progress = (currentAudio.currentTime / currentAudio.duration) * 100;
        progressFill.style.width = progress + '%';
        
        const currentTime = formatTime(currentAudio.currentTime);
        const totalTime = formatTime(currentAudio.duration);
        timeDisplay.textContent = `${currentTime}/${totalTime}`;
    }
}

function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function updatePlayerInfo(surahName, currentVerse, totalVerses) {
    const title = document.getElementById('audioPlayerTitle');
    const subtitle = document.getElementById('audioPlayerSubtitle');
    
    if (title) title.textContent = `Putar Surah`;
    if (subtitle) subtitle.textContent = `${surahName} - ${currentVerse}/${totalVerses}`;
}



// Performance optimization: Lazy loading for long surahs
function createIntersectionObserver() {
    if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, {
            threshold: 0.1,
            rootMargin: '50px'
        });

        // Observe ayah cards when they're created
        document.querySelectorAll('.ayah-card').forEach(card => {
            observer.observe(card);
        });
    }
}

// Service Worker registration for offline functionality (optional)
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        // Uncomment to enable service worker
        // navigator.serviceWorker.register('/sw.js')
        //   .then(registration => console.log('SW registered'))
        //   .catch(error => console.log('SW registration failed'));
    });
}

// Initialize app when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        console.log('App initialized');
        handleResize(); // Initial responsive setup
    });
} else {
    console.log('App initialized');
    handleResize(); // Initial responsive setup
}

// Debugging helper
window.QuranApp = {
    currentSurah,
    currentSettings,
    bookmarks,
    searchHistory,
    searchResults,
    showError,
    showNotification,
    loadSurah,
    toggleTheme,
    version: '2.0.0'
};

console.log('Progress Bar System v2.0 loaded successfully!');

function getAudioUrl(surah, ayah) {
    return `https://verses.quran.com/AbdulBaset/Mujawwad/mp3/${String(surah).padStart(3, '0')}${String(ayah).padStart(3, '0')}.mp3`;
}

function updateAudioStatus(surahNumber) {
    const statusEl = document.getElementById('audioStatus');
    if (!statusEl) return;

    const surah = quranData[surahNumber];
    if (!surah) {
        statusEl.textContent = 'üîá Tidak ada audio yang tersedia';
        return;
    }

    const audioUrl = getAudioUrl(surahNumber, 1); // Cek ayat 1
    if (!audioUrl || typeof audioUrl !== 'string' || audioUrl.includes('undefined')) {
        statusEl.textContent = `üîá Audio tidak tersedia untuk surah ${surah.name}`;
    } else {
        statusEl.textContent = `üîä Audio tersedia untuk surah ${surah.name}`;
    }
}

// ===== SISTEM PROGRESS PER SURAH =====

// CSS untuk modal progress per surah
// Fungsi untuk menampilkan notifikasi (fallback jika showSuccess tidak ada)
function safeShowSuccess(message) {
    if (typeof showSuccess === 'function') {
        showSuccess(message);
    } else if (typeof showNotification === 'function') {
        showNotification(message, 'success');
    } else {
        console.log('SUCCESS:', message);
        alert(message);
    }
}

function safeShowError(message) {
    if (typeof showError === 'function') {
        showError(message);
    } else if (typeof showNotification === 'function') {
        showNotification(message, 'error');
    } else {
        console.log('ERROR:', message);
        alert(message);
    }
}

// Simpan progress surah ke localStorage
function saveProgressForSurah(surahNumber, progress) {
    try {
        if (!surahNumber || progress < 0) return;
        
        const progressData = JSON.parse(localStorage.getItem('quranSurahProgress') || '{}');
        progressData[surahNumber] = {
            progress: progress,
            lastRead: new Date().toISOString(),
            surahName: (window.quranData && window.quranData[surahNumber]) ? 
                      window.quranData[surahNumber].name : `Surah ${surahNumber}`
        };
        localStorage.setItem('quranSurahProgress', JSON.stringify(progressData));
        console.log(`Progress saved for surah ${surahNumber}: ${progress}%`);
    } catch (error) {
        console.error('Error saving progress:', error);
    }
}

// Load progress surah dari localStorage
function loadProgressForSurah(surahNumber) {
    try {
        if (!surahNumber) return 0;
        
        const progressData = JSON.parse(localStorage.getItem('quranSurahProgress') || '{}');
        if (progressData[surahNumber]) {
            return progressData[surahNumber].progress || 0;
        }
        return 0;
    } catch (error) {
        console.error('Error loading progress:', error);
        return 0;
    }
}

// Hapus progress surah dari localStorage
function deleteProgressForSurah(surahNumber) {
    try {
        if (!surahNumber) return;
        
        const progressData = JSON.parse(localStorage.getItem('quranSurahProgress') || '{}');
        delete progressData[surahNumber];
        localStorage.setItem('quranSurahProgress', JSON.stringify(progressData));
        console.log(`Progress deleted for surah ${surahNumber}`);
    } catch (error) {
        console.error('Error deleting progress:', error);
    }
}

// Cek apakah surah memiliki progress tersimpan
function hasSavedProgress(surahNumber) {
    try {
        if (!surahNumber) return false;
        
        const progressData = JSON.parse(localStorage.getItem('quranSurahProgress') || '{}');
        return progressData[surahNumber] && progressData[surahNumber].progress > 0;
    } catch (error) {
        return false;
    }
}

function getSurahName(surahNumber) {
    try {
        // Coba ambil dari quranData global
        if (typeof quranData !== 'undefined' && quranData[surahNumber]) {
            return quranData[surahNumber].name;
        }
        
        // Coba dari window.quranData
        if (window.quranData && window.quranData[surahNumber]) {
            return window.quranData[surahNumber].name;
        }
        
        // Fallback - coba ambil dari select option yang dipilih
        const surahSelect = document.getElementById('surah');
        if (surahSelect) {
            const selectedOption = surahSelect.options[surahSelect.selectedIndex];
            if (selectedOption && selectedOption.value == surahNumber) {
                const optionText = selectedOption.textContent;
                // Extract nama surah dari text seperti "1. Al-Fatihah (ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©)"
                const match = optionText.match(/^\d+\.\s*([^(]+)/);
                if (match) {
                    return match[1].trim();
                }
            }
        }
        
        // Ultimate fallback
        return `Surah ${surahNumber}`;
    } catch (error) {
        console.error('Error getting surah name:', error);
        return `Surah ${surahNumber}`;
    }
}

// UPDATE: Modal konfirmasi untuk menyimpan/menghapus progress saat pindah surah
function showSaveProgressModal(previousSurahNumber, previousProgress, callback) {
    try {
        // Hapus modal lama jika ada
        const existingModal = document.getElementById('progressModalV2');
        if (existingModal) existingModal.remove();

        const previousSurahName = getSurahName(previousSurahNumber);
        
        const modalHTML = `
            <div class="progress-modal-overlay-v2" id="progressModalV2">
                <div class="progress-modal-v2">
                    <h3>üíæ Simpan Progress Baca?</h3>
                    
                    <div class="progress-info-v2">
                        <h4>Progress Baca ${previousSurahName}</h4>
                        <div class="progress-bar-preview-v2">
                            <div class="progress-fill-preview-v2" style="width: ${previousProgress}%"></div>
                        </div>
                        <div class="progress-text-v2">Progress saat ini: ${previousProgress}%</div>
                    </div>
                    
                    <p>Apakah Anda ingin <strong>menyimpan</strong> atau <strong>menghapus</strong> progress baca <strong>${previousSurahName}</strong>?</p>
                    
                    <div class="progress-modal-buttons-v2">
                        <button class="progress-modal-btn-v2 save" onclick="confirmSaveProgressV2(${previousSurahNumber}, ${previousProgress}, true)">
                            üíæ Simpan
                        </button>
                        <button class="progress-modal-btn-v2 delete" onclick="confirmSaveProgressV2(${previousSurahNumber}, ${previousProgress}, false)">
                            üóëÔ∏è Hapus
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = modalHTML;
        document.body.appendChild(tempDiv.firstElementChild);
        
        // Store callback
        window.saveProgressCallbackV2 = callback;
        
    } catch (error) {
        console.error('Error showing save progress modal:', error);
        if (callback) callback();
    }
}

// UPDATE: Modal konfirmasi untuk melanjutkan atau memulai dari awal
function showContinueProgressModal(surahNumber, savedProgress, callback) {
    try {
        // Hapus modal lama jika ada
        const existingModal = document.getElementById('progressModalV2');
        if (existingModal) existingModal.remove();

        const surahName = getSurahName(surahNumber);
        
        // Hitung total ayat dan ayat terakhir yang dibaca
        let totalVerses = 0;
        let lastVerseRead = 0;
        
        try {
            if (typeof quranData !== 'undefined' && quranData[surahNumber]) {
                totalVerses = Object.keys(quranData[surahNumber].verses).length;
            } else if (window.quranData && window.quranData[surahNumber]) {
                totalVerses = Object.keys(window.quranData[surahNumber].verses).length;
            }
            
            if (totalVerses > 0) {
                lastVerseRead = Math.ceil((savedProgress / 100) * totalVerses);
            }
        } catch (error) {
            console.error('Error calculating verses:', error);
        }
        
        const modalHTML = `
            <div class="progress-modal-overlay-v2" id="progressModalV2">
                <div class="progress-modal-v2">
                    <h3>üìñ Lanjutkan Membaca?</h3>
                    
                    <div class="progress-info-v2">
                        <h4>Progress Tersimpan ${surahName}</h4>
                        <div class="progress-bar-preview-v2">
                            <div class="progress-fill-preview-v2" style="width: ${savedProgress}%"></div>
                        </div>
                        <div class="progress-text-v2">Progress tersimpan: ${savedProgress}% ${totalVerses > 0 ? `(sekitar ayat ${lastVerseRead} dari ${totalVerses})` : ''}</div>
                    </div>
                    
                    <p>Apakah Anda ingin <strong>melanjutkan membaca</strong> dari progress terakhir atau <strong>memulai dari awal</strong>?</p>
                    
                    <div class="progress-modal-buttons-v2">
                        <button class="progress-modal-btn-v2 continue" onclick="confirmContinueProgressV2(${surahNumber}, ${savedProgress}, true)">
                            üìñ Lanjutkan
                        </button>
                        <button class="progress-modal-btn-v2 restart" onclick="confirmContinueProgressV2(${surahNumber}, ${savedProgress}, false)">
                            üîÑ Mulai Awal
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = modalHTML;
        document.body.appendChild(tempDiv.firstElementChild);
        
        // Store callback
        window.continueProgressCallbackV2 = callback;
        
    } catch (error) {
        console.error('Error showing continue progress modal:', error);
        if (callback) callback();
    }
}

// UPDATE: Simpan progress surah ke localStorage dengan nama yang benar
function saveProgressForSurah(surahNumber, progress) {
    try {
        if (!surahNumber || progress < 0) return;
        
        const progressData = JSON.parse(localStorage.getItem('quranSurahProgress') || '{}');
        progressData[surahNumber] = {
            progress: progress,
            lastRead: new Date().toISOString(),
            surahName: getSurahName(surahNumber)
        };
        localStorage.setItem('quranSurahProgress', JSON.stringify(progressData));
        console.log(`Progress saved for ${getSurahName(surahNumber)}: ${progress}%`);
    } catch (error) {
        console.error('Error saving progress:', error);
    }
}

// UPDATE: Handle konfirmasi save/delete progress
function confirmSaveProgressV2(surahNumber, progress, shouldSave) {
    try {
        const modal = document.getElementById('progressModalV2');
        const surahName = getSurahName(surahNumber);
        
        if (shouldSave) {
            saveProgressForSurah(surahNumber, progress);
            safeShowSuccess(`‚úÖ Progress ${surahName} (${progress}%) disimpan`);
        } else {
            deleteProgressForSurah(surahNumber);
            safeShowSuccess(`üóëÔ∏è Progress ${surahName} dihapus`);
        }
        
        // Tutup modal
        if (modal) modal.remove();
        
        // Jalankan callback
        if (window.saveProgressCallbackV2) {
            window.saveProgressCallbackV2();
            window.saveProgressCallbackV2 = null;
        }
    } catch (error) {
        console.error('Error confirming save progress:', error);
    }
}

// UPDATE: Handle konfirmasi continue/restart progress
function confirmContinueProgressV2(surahNumber, savedProgress, shouldContinue) {
    try {
        const modal = document.getElementById('progressModalV2');
        const surahName = getSurahName(surahNumber);
        
        if (shouldContinue) {
            // Lanjutkan dari progress tersimpan
            maxReadingProgress = savedProgress;
            updateProgressBarDisplay();
            safeShowSuccess(`üìñ Melanjutkan ${surahName} dari ${savedProgress}%`);
            
            // Scroll ke posisi yang sesuai dengan progress
            setTimeout(() => {
                scrollToProgressPosition(savedProgress);
            }, 1000);
        } else {
            // Mulai dari awal - reset progress
            deleteProgressForSurah(surahNumber);
            maxReadingProgress = 0;
            updateProgressBarDisplay();
            safeShowSuccess(`üîÑ Memulai ${surahName} dari awal`);
            
            // Scroll ke atas
            setTimeout(() => {
                if (typeof scrollToTop === 'function') {
                    scrollToTop();
                } else {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }, 500);
        }
        
        // Tutup modal
        if (modal) modal.remove();
        
        // Jalankan callback
        if (window.continueProgressCallbackV2) {
            window.continueProgressCallbackV2();
            window.continueProgressCallbackV2 = null;
        }
    } catch (error) {
        console.error('Error confirming continue progress:', error);
    }
}

// Scroll ke posisi berdasarkan progress
function scrollToProgressPosition(progress) {
    try {
        const ayahCards = document.querySelectorAll('.ayah-card');
        if (ayahCards.length === 0) return;
        
        const targetIndex = Math.floor((progress / 100) * ayahCards.length);
        const targetCard = ayahCards[Math.min(targetIndex, ayahCards.length - 1)];
        
        if (targetCard) {
            targetCard.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            
            // Highlight target card
            targetCard.classList.add('highlight');
            setTimeout(() => {
                targetCard.classList.remove('highlight');
            }, 3000);
        }
    } catch (error) {
        console.error('Error scrolling to progress position:', error);
    }
}

// Update tampilan progress bar
function updateProgressBarDisplay() {
    try {
        const progressFill = document.getElementById('progressFill');
        const progressElement = document.getElementById('readingProgress');
        
        if (progressFill) progressFill.style.width = maxReadingProgress + '%';
        if (progressElement) progressElement.textContent = maxReadingProgress + '%';
    } catch (error) {
        console.error('Error updating progress bar display:', error);
    }
}

// Update progress berdasarkan scroll (hanya bisa naik)
function updateReadingProgressPerSurah() {
    try {
        if (!currentSurahNumber) return;
        
        const ayahCards = document.querySelectorAll('.ayah-card');
        if (ayahCards.length === 0) return;
        
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const viewportMiddle = scrollTop + (windowHeight / 2);
        
        let currentReadCount = 0;
        const totalCount = ayahCards.length;
        
        // Hitung ayah yang sudah terbaca
        ayahCards.forEach((card) => {
            const rect = card.getBoundingClientRect();
            const cardTop = rect.top + scrollTop;
            
            if (cardTop < viewportMiddle) {
                currentReadCount++;
            }
        });
        
        const currentProgress = Math.floor((currentReadCount / totalCount) * 100);
        
        // Progress hanya bisa naik
        if (currentProgress > maxReadingProgress) {
            maxReadingProgress = currentProgress;
            updateProgressBarDisplay();
            
            // Auto save progress (silent save)
            saveProgressForSurah(currentSurahNumber, maxReadingProgress);
        }
    } catch (error) {
        console.error('Error updating reading progress per surah:', error);
    }
}

// Setup scroll listener untuk progress per surah
function setupPerSurahProgressListener() {
    try {
        let isScrolling = false;
        
        function handleScroll() {
            if (isScrolling) return;
            
            isScrolling = true;
            
            requestAnimationFrame(() => {
                updateReadingProgressPerSurah();
                isScrolling = false;
            });
        }
        
        // Remove existing listener
        window.removeEventListener('scroll', handleScroll);
        // Add new listener
        window.addEventListener('scroll', handleScroll, { passive: true });
        
        console.log('Per-surah progress scroll listener setup');
    } catch (error) {
        console.error('Error setting up scroll listener:', error);
    }
}

// Override loadSurah dengan konfirmasi progress
function loadSurahWithProgressConfirm() {
    try {
        const surahSelect = document.getElementById('surah');
        if (!surahSelect) {
            safeShowError('Surah select not found');
            return;
        }
        
        const newSurahNumber = parseInt(surahSelect.value);
        
        if (!newSurahNumber || isNaN(newSurahNumber)) {
            safeShowError('Silakan pilih surah terlebih dahulu');
            return;
        }
        
        // Fungsi untuk melanjutkan load surah baru
        const proceedToNewSurah = () => {
            currentSurahNumber = newSurahNumber;
            
            // Cek apakah surah baru memiliki progress tersimpan
            if (hasSavedProgress(newSurahNumber)) {
                const savedProgress = loadProgressForSurah(newSurahNumber);
                
                // Tampilkan modal konfirmasi untuk melanjutkan atau mulai dari awal
                showContinueProgressModal(newSurahNumber, savedProgress, () => {
                    // Load surah setelah konfirmasi
                    if (originalLoadSurah) {
                        originalLoadSurah();
                    } else {
                        safeShowError('Original loadSurah function not found');
                    }
                    
                    // Update currentSurah global variable
                    if (typeof window.currentSurah !== 'undefined') {
                        window.currentSurah = newSurahNumber;
                    }
                });
            } else {
                // Surah baru, mulai dari 0%
                maxReadingProgress = 0;
                updateProgressBarDisplay();
                
                if (originalLoadSurah) {
                    originalLoadSurah();
                } else {
                    safeShowError('Original loadSurah function not found');
                }
                
                // Update currentSurah global variable
                if (typeof window.currentSurah !== 'undefined') {
                    window.currentSurah = newSurahNumber;
                }
            }
        };
        
        // Jika ada surah sebelumnya dengan progress > 0, tanya save/delete
        if (currentSurahNumber && currentSurahNumber !== newSurahNumber && maxReadingProgress > 0) {
            showSaveProgressModal(currentSurahNumber, maxReadingProgress, proceedToNewSurah);
        } else {
            // Langsung ke surah baru
            proceedToNewSurah();
        }
    } catch (error) {
        console.error('Error in loadSurahWithProgressConfirm:', error);
        safeShowError('Terjadi kesalahan saat memuat surah');
    }
}

// Override navigation functions  
function previousSurahWithProgressConfirm() {
    try {
        const surahSelect = document.getElementById('surah');
        if (!surahSelect) return;
        
        const currentValue = parseInt(surahSelect.value);
        
        if (currentValue && currentValue > 1 && window.quranData) {
            const surahKeys = Object.keys(window.quranData).map(Number).sort((a, b) => a - b);
            const currentIndex = surahKeys.indexOf(currentValue);
            if (currentIndex > 0) {
                const prevSurah = surahKeys[currentIndex - 1];
                
                // Fungsi untuk pindah ke surah sebelumnya
                const proceedToPrevSurah = () => {
                    surahSelect.value = prevSurah;
                    loadSurahWithProgressConfirm();
                };
                
                // Jika ada progress pada surah saat ini, tanya save/delete
                if (maxReadingProgress > 0) {
                    showSaveProgressModal(currentSurahNumber, maxReadingProgress, proceedToPrevSurah);
                } else {
                    proceedToPrevSurah();
                }
            }
        }
    } catch (error) {
        console.error('Error in previousSurahWithProgressConfirm:', error);
    }
}

function nextSurahWithProgressConfirm() {
    try {
        const surahSelect = document.getElementById('surah');
        if (!surahSelect) return;
        
        const currentValue = parseInt(surahSelect.value);
        
        if (currentValue && window.quranData) {
            const surahKeys = Object.keys(window.quranData).map(Number).sort((a, b) => a - b);
            const currentIndex = surahKeys.indexOf(currentValue);
            if (currentIndex < surahKeys.length - 1) {
                const nextSurah = surahKeys[currentIndex + 1];
                
                // Fungsi untuk pindah ke surah selanjutnya
                const proceedToNextSurah = () => {
                    surahSelect.value = nextSurah;
                    loadSurahWithProgressConfirm();
                };
                
                // Jika ada progress pada surah saat ini, tanya save/delete
                if (maxReadingProgress > 0) {
                    showSaveProgressModal(currentSurahNumber, maxReadingProgress, proceedToNextSurah);
                } else {
                    proceedToNextSurah();
                }
            }
        }
    } catch (error) {
        console.error('Error in nextSurahWithProgressConfirm:', error);
    }
}

// Inisialisasi sistem progress per surah
function initPerSurahProgressSystem() {
    try {
        console.log('Initializing Per-Surah Progress System...');
        
        // Setup scroll listener
        setupPerSurahProgressListener();
        
        // Backup dan override functions dengan delay untuk memastikan functions sudah ada
        setTimeout(() => {
            try {
                // Backup original functions
                if (typeof window.loadSurah === 'function' && !originalLoadSurah) {
                    originalLoadSurah = window.loadSurah;
                    window.loadSurah = loadSurahWithProgressConfirm;
                    console.log('loadSurah function overridden');
                }
                
                if (typeof window.previousSurah === 'function' && !originalPreviousSurah) {
                    originalPreviousSurah = window.previousSurah;
                    window.previousSurah = previousSurahWithProgressConfirm;
                    console.log('previousSurah function overridden');
                }
                
                if (typeof window.nextSurah === 'function' && !originalNextSurah) {
                    originalNextSurah = window.nextSurah;
                    window.nextSurah = nextSurahWithProgressConfirm;
                    console.log('nextSurah function overridden');
                }
                
                // Override updateReadingProgress jika ada
                if (typeof window.updateReadingProgress === 'function') {
                    window.updateReadingProgress = updateReadingProgressPerSurah;
                    console.log('updateReadingProgress function overridden');
                }
            } catch (error) {
                console.error('Error overriding functions:', error);
            }
        }, 1000);
        
        // Reset progress bar
        maxReadingProgress = 0;
        currentSurahNumber = null;
        updateProgressBarDisplay();
        
        console.log('‚úÖ Per-Surah Progress System initialized');
    } catch (error) {
        console.error('Error initializing per-surah progress system:', error);
    }
}

// Expose functions untuk debugging
window.PerSurahProgressV2 = {
    save: saveProgressForSurah,
    load: loadProgressForSurah,
    delete: deleteProgressForSurah,
    hasSaved: hasSavedProgress,
    current: () => ({ surah: currentSurahNumber, progress: maxReadingProgress }),
    init: initPerSurahProgressSystem
};

// Expose global functions untuk modal callbacks
window.confirmSaveProgressV2 = confirmSaveProgressV2;
window.confirmContinueProgressV2 = confirmContinueProgressV2;

// Auto init when DOM ready dengan multiple fallbacks
(function() {
    function tryInit() {
        if (document.body && document.head) {
            initPerSurahProgressSystem();
            return true;
        }
        return false;
    }
    
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        if (!tryInit()) {
            setTimeout(tryInit, 500);
        }
    } else {
        document.addEventListener('DOMContentLoaded', () => {
            if (!tryInit()) {
                setTimeout(tryInit, 500);
            }
        });
        
        window.addEventListener('load', () => {
            setTimeout(tryInit, 1000);
        });
    }
})();

console.log('‚úÖ Per-Surah Progress System V2 Loaded!');

// ===== PANEL PROGRESS BACA =====
// Fungsi untuk mendapatkan semua progress yang tersimpan
function getAllSavedProgress() {
    try {
        const progressData = JSON.parse(localStorage.getItem('quranSurahProgress') || '{}');
        return progressData;
    } catch (error) {
        console.error('Error loading all progress:', error);
        return {};
    }
}

// Fungsi untuk menghitung statistik progress
function calculateProgressStats() {
    const allProgress = getAllSavedProgress();
    const surahCount = Object.keys(allProgress).length;
    
    if (surahCount === 0) {
        return { totalSurah: 0, averageProgress: 0, completedSurah: 0 };
    }
    
    const progressValues = Object.values(allProgress).map(item => item.progress || 0);
    const totalProgress = progressValues.reduce((sum, progress) => sum + progress, 0);
    const averageProgress = Math.floor(totalProgress / surahCount);
    const completedSurah = progressValues.filter(progress => progress >= 100).length;
    
    return {
        totalSurah: surahCount,
        averageProgress: averageProgress,
        completedSurah: completedSurah
    };
}

// Fungsi untuk format tanggal
function formatDate(dateString) {
    try {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) {
            return 'Hari ini';
        } else if (diffDays === 1) {
            return 'Kemarin';
        } else if (diffDays < 7) {
            return `${diffDays} hari lalu`;
        } else {
            return date.toLocaleDateString('id-ID', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric' 
            });
        }
    } catch (error) {
        return 'Tidak diketahui';
    }
}

// Fungsi untuk menampilkan panel progress
function toggleProgressPanel() {
    const panel = document.getElementById('progressPanel');
    const overlay = document.getElementById('overlay');
    
    if (panel && overlay) {
        panel.classList.toggle('open');
        overlay.classList.toggle('show');
        
        if (panel.classList.contains('open')) {
            displayProgressList();
        }
    }
}

// Fungsi untuk menampilkan daftar progress
function displayProgressList() {
    const container = document.getElementById('progressList');
    const statsContainer = document.getElementById('progressStats');
    
    if (!container) return;
    
    const allProgress = getAllSavedProgress();
    const progressEntries = Object.entries(allProgress);
    
    // Update statistik
    if (statsContainer) {
        const stats = calculateProgressStats();
        statsContainer.innerHTML = `
            <h4>üìä Statistik Progress Baca</h4>
            <div class="progress-stats-grid">
                <div class="progress-stat-item">
                    <span class="progress-stat-number">${stats.totalSurah}</span>
                    <span class="progress-stat-label">Surah Dibaca</span>
                </div>
                <div class="progress-stat-item">
                    <span class="progress-stat-number">${stats.averageProgress}%</span>
                    <span class="progress-stat-label">Rata-rata Progress</span>
                </div>
            </div>
        `;
    }
    
    if (progressEntries.length === 0) {
        container.innerHTML = `
            <div class="progress-empty">
                <div class="progress-empty-icon">üìñ</div>
                <h4>Belum Ada Progress</h4>
                <p>Mulai membaca surah untuk melihat progress Anda di sini</p>
            </div>
        `;
        return;
    }
    
    // Sort berdasarkan tanggal terakhir dibaca (terbaru dulu)
    progressEntries.sort((a, b) => {
        const dateA = new Date(a[1].lastRead || 0);
        const dateB = new Date(b[1].lastRead || 0);
        return dateB - dateA;
    });
    
    let html = '';
    progressEntries.forEach(([surahNumber, progressData]) => {
        const surahName = getSurahName(parseInt(surahNumber));
        const progress = progressData.progress || 0;
        const lastRead = progressData.lastRead;
        const formattedDate = formatDate(lastRead);
        
        // Hitung ayat terakhir yang dibaca
        let estimatedVerse = '';
        try {
            let totalVerses = 0;
            if (typeof quranData !== 'undefined' && quranData[surahNumber]) {
                totalVerses = Object.keys(quranData[surahNumber].verses).length;
            }
            if (totalVerses > 0) {
                const lastVerseRead = Math.ceil((progress / 100) * totalVerses);
                estimatedVerse = ` (‚âà ayat ${lastVerseRead}/${totalVerses})`;
            }
        } catch (error) {
            // Ignore error
        }
        
        html += `
            <div class="progress-item" onclick="goToProgressSurah(${surahNumber}, ${progress})">
                <div class="progress-surah-name">${surahName}</div>
                <div class="progress-details">
                    <span class="progress-percentage">${progress}%${estimatedVerse}</span>
                    <span class="progress-date">${formattedDate}</span>
                </div>
                <div class="progress-bar-mini">
                    <div class="progress-fill-mini" style="width: ${progress}%"></div>
                </div>
                <div class="progress-actions">
                    <button class="progress-action-btn continue" 
                            onclick="event.stopPropagation(); continueFromProgress(${surahNumber}, ${progress})"
                            title="Lanjutkan membaca">
                        üìñ Lanjutkan
                    </button>
                    <button class="progress-action-btn delete" 
                            onclick="event.stopPropagation(); deleteProgressFromPanel(${surahNumber})"
                            title="Hapus progress">
                        üóëÔ∏è Hapus
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Fungsi untuk pergi ke surah dengan progress tertentu
function goToProgressSurah(surahNumber, progress) {
    try {
        const surahSelect = document.getElementById('surah');
        if (!surahSelect) return;
        
        // Tutup panel progress
        toggleProgressPanel();
        
        // Set surah di select
        surahSelect.value = surahNumber;
        
        // Set progress yang akan digunakan
        currentSurahNumber = surahNumber;
        maxReadingProgress = progress;
        
        // Load surah
        if (originalLoadSurah) {
            originalLoadSurah();
        }
        
        // Update currentSurah global
        if (typeof window.currentSurah !== 'undefined') {
            window.currentSurah = surahNumber;
        }
        
        // Update progress bar display
        setTimeout(() => {
            updateProgressBarDisplay();
            
            // Scroll ke posisi progress
            setTimeout(() => {
                scrollToProgressPosition(progress);
                safeShowSuccess(`üìñ Membuka ${getSurahName(surahNumber)} di progress ${progress}%`);
            }, 1000);
        }, 500);
        
    } catch (error) {
        console.error('Error going to progress surah:', error);
        safeShowError('Gagal membuka surah');
    }
}

// Fungsi untuk melanjutkan dari progress
function continueFromProgress(surahNumber, progress) {
    goToProgressSurah(surahNumber, progress);
}

// Fungsi untuk menghapus progress dari panel
function deleteProgressFromPanel(surahNumber) {
    try {
        const surahName = getSurahName(surahNumber);
        
        if (confirm(`Hapus progress baca ${surahName}?`)) {
            deleteProgressForSurah(surahNumber);
            displayProgressList(); // Refresh list
            safeShowSuccess(`üóëÔ∏è Progress ${surahName} berhasil dihapus`);
        }
    } catch (error) {
        console.error('Error deleting progress from panel:', error);
        safeShowError('Gagal menghapus progress');
    }
}

// Fungsi untuk menambahkan tombol progress di toolbar
function addProgressButtonToToolbar() {
    // Cek apakah tombol sudah ada di HTML
    const existingBtn = document.getElementById('progressBtn');
    if (existingBtn) {
        // Tombol sudah ada di HTML, hanya setup event listener
        existingBtn.onclick = toggleProgressPanel;
        existingBtn.title = 'Lihat Progress Baca';
        console.log('Progress button found and configured');
        return;
    }
    
    // Fallback: buat tombol jika belum ada (untuk backward compatibility)
    const bookmarkBtn = document.querySelector('button[onclick*="toggleBookmarks"]');
    if (bookmarkBtn && !document.getElementById('progressBtn')) {
        const progressBtn = document.createElement('button');
        progressBtn.id = 'progressBtn';
        progressBtn.className = 'rounded-button';
        progressBtn.onclick = toggleProgressPanel;
        progressBtn.innerHTML = 'üìà Progress';
        progressBtn.title = 'Lihat Progress Baca';
        bookmarkBtn.parentNode.insertBefore(progressBtn, bookmarkBtn.nextSibling);
        console.log('Progress button created dynamically');
    }
}

// Fungsi inisialisasi panel progress
function initProgressPanel() {
    try {
        addProgressButtonToToolbar(); // Langsung panggil, tanpa delay
        console.log('‚úÖ Progress Panel initialized');
    } catch (error) {
        console.error('Error initializing progress panel:', error);
    }
}

// Expose functions for global access
window.toggleProgressPanel = toggleProgressPanel;
window.goToProgressSurah = goToProgressSurah;
window.continueFromProgress = continueFromProgress;
window.deleteProgressFromPanel = deleteProgressFromPanel;

// Auto init panel progress
(function() {
    function tryInitPanel() {
        if (document.body && document.head) {
            setTimeout(() => {
                initProgressPanel();
            }, 100); // Kurangi delay ke 100ms
            return true;
        }
        return false;
    }
    
    // Sederhanakan init
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', tryInitPanel);
    } else {
        tryInitPanel();
    }
})();

console.log('‚úÖ Progress Panel System Loaded!');


</script>
</body>
</html>